name: Daily refresh (GA4 + sitemap) and deploy

on:
  workflow_dispatch:
  schedule:
    # 每天 UTC 00:00 (北京时间 08:00)
    - cron: "0 0 * * *"

permissions:
  contents: write
  actions: write

concurrency:
  group: daily-refresh-and-deploy
  cancel-in-progress: true

jobs:
  ga4_post_uv:
    uses: ./.github/workflows/ga4-post-uv.yml
    secrets: inherit

  sitemap_snapshot:
    needs: [ga4_post_uv]
    uses: ./.github/workflows/fetch-sitemap-snapshot.yml
    secrets: inherit

  deploy:
    needs: [ga4_post_uv, sitemap_snapshot]
    if: needs.ga4_post_uv.outputs.changed == 'true' || needs.sitemap_snapshot.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          curl -fsSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/workflows/deploy.yml/dispatches" \
            -d '{"ref":"master"}'
