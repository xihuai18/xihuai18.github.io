{% if site.enable_google_verification or site.enable_bing_verification %}
    <!-- Website verification -->
    {% if site.enable_google_verification -%}
    <meta name="google-site-verification" content="{{ site.google_site_verification }}" />
    {%- endif -%}
    {% if site.enable_bing_verification -%}
    <meta name="msvalidate.01" content="{{ site.bing_site_verification }}" />
    {%- endif -%}
    <!-- Avoid warning on Google Chrome
        Error with Permissions-Policy header: Origin trial controlled feature not enabled: 'interest-cohort'.
        see https://stackoverflow.com/a/75119417
    -->
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
{%- endif %}

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>
    {%- if site.title == "blank" -%}
        {%- capture title -%}{{ site.first_name }} {{ site.middle_name }} {{ site.last_name }}{%- endcapture -%}
    {%- else -%}
        {%- capture title -%}{{ site.title }}{%- endcapture -%}
    {%- endif -%}
    {% if page.url == '/blog/' or page.url == '/blog/index.html' or page.permalink == '/blog/' %}
        {{ site.blog_nav_title }} | {{ title }}
    {%- elsif page.title != "blank" and page.url != "/" -%}
        {%- if page.title == nil or page.title == "" -%}
            {{ page.date | date: "%Y" }} | {{ title }}
        {%- else -%}
            {{ page.title }} | {{ title }}
        {%- endif -%}
    {%- else -%}
        {{ title }}
    {%- endif -%}
    </title>

    {%- comment -%}
    Unified share title/description (escaped) for meta tags.
    - strip_html/strip_newlines: avoid breaking meta attributes
    - escape_once: safe for HTML attribute context
    {%- endcomment -%}
    {%- if page.layout == 'post' or page.layout == 'distill' -%}
        {%- capture _share_meta_title -%}Xihuai's Blog |{% if page.title %} {{ page.title }}{% else %} {{ title }}{% endif %}{%- endcapture -%}
    {%- else -%}
        {%- capture _share_meta_title -%}{%- if page.title -%}{{ page.title }}{%- else -%}{{ title }}{%- endif -%}{%- endcapture -%}
    {%- endif -%}
    {%- assign _share_meta_title = _share_meta_title | strip_html | strip_newlines | escape_once -%}
    {%- capture _share_meta_desc -%}{%- if page.description -%}{{ page.description }}{%- else -%}{{ site.description }}{%- endif -%}{%- endcapture -%}
    {%- assign _share_meta_desc = _share_meta_desc | strip_html | strip_newlines | escape_once -%}

    <meta name="author" content="{{ site.first_name }} {{ site.middle_name }} {{ site.last_name }}" />
    <meta name="description" content="{{ _share_meta_desc }}" />
{%- if page.keywords or site.keywords %}
    <meta name="keywords" content="{%- if page.keywords -%}{{ page.keywords }}{%- else -%}{{ site.keywords }}{%- endif -%}" />
{%- endif %}

    <!-- 
    Unified Share Image URL Calculation
    Priority:
    1) page.disable_share_image / page.share_image: none  -> no image
    2) page.og_image                                     -> explicit per-page image
    3) dynamic generation (posts)                         -> horizontal OG via Tailgraph
    4) site.og_image == 'auto'                            -> horizontal OG via Tailgraph for non-post pages
    5) site.og_image                                      -> site default
    This keeps homepage free to use a portrait image while giving blog pages a better horizontal card.
    -->
    {%- assign _disable_share_image = false -%}
    {%- if page.disable_share_image == true or page.share_image == 'none' -%}
        {%- assign _disable_share_image = true -%}
    {%- endif -%}

    {%- if _disable_share_image -%}
        {%- assign _share_image_url = nil -%}
    {%- elsif page.og_image -%}
        {%- assign _share_image_url = page.og_image -%}
        {%- unless _share_image_url contains '://' -%}
            {%- assign _share_image_url = _share_image_url | prepend: site.baseurl | prepend: site.url -%}
        {%- endunless -%}
    {%- elsif page.layout == 'post' or page.layout == 'distill' -%}
        {%- comment -%} Auto-generate share image for blog posts using dynamic service {%- endcomment -%}
        {%- comment -%}
        Tailgraph query params must be URL-encoded as a whole.
        Encode the full title (including prefix) and full author.
        {%- endcomment -%}
        {%- capture _share_title_raw -%}Xihuai's Blog |{% if page.title %} {{ page.title }}{% else %} {{ title }}{% endif %}{%- endcapture -%}
        {%- assign _share_title = _share_title_raw | strip_html | strip_newlines | url_encode -%}

        {%- capture _share_desc_raw -%}{%- if page.description -%}{{ page.description }}{%- else -%}{{ site.description }}{%- endif -%}{%- endcapture -%}
        {%- assign _share_desc = _share_desc_raw | strip_html | strip_newlines | truncate: 100 | url_encode -%}

        {%- capture _share_author_raw -%}{{ site.first_name }} {{ site.last_name }}{%- endcapture -%}
        {%- assign _share_author = _share_author_raw | strip_html | strip_newlines | url_encode -%}

        {%- capture _share_date -%}{%- if page.date -%}{{ page.date | date: "%Y-%m-%d" }}{%- endif -%}{%- endcapture -%}
        {%- assign _share_image_url = "https://og.tailgraph.com/og?fontFamily=Inter&title=" | append: _share_title | append: "&titleTailwind=font-bold%20text-4xl%20text-white&titleFontFamily=Inter&text=" | append: _share_desc | append: "&textTailwind=text-lg%20mt-4%20text-gray-300&textFontFamily=Inter&logoTailwind=h-12&bgTailwind=bg-gradient-to-br%20from-green-900%20via-emerald-800%20to-teal-900&footer=" | append: _share_author | append: "%20%C2%B7%20" | append: _share_date | append: "&footerTailwind=text-gray-400&containerTailwind=p-12" -%}
    {%- elsif site.og_image == 'auto' or site.og_image == blank -%}
        {%- comment -%} Auto-generate a horizontal share image for non-post pages (e.g., /blog/ index). {%- endcomment -%}
        {%- assign _share_title = _share_meta_title | url_encode -%}
        {%- assign _share_desc = _share_meta_desc | truncate: 100 | url_encode -%}
        {%- capture _share_author_raw -%}{{ site.first_name }} {{ site.last_name }}{%- endcapture -%}
        {%- assign _share_author = _share_author_raw | strip_html | strip_newlines | url_encode -%}
        {%- assign _share_image_url = "https://og.tailgraph.com/og?fontFamily=Inter&title=" | append: _share_title | append: "&titleTailwind=font-bold%20text-4xl%20text-white&titleFontFamily=Inter&text=" | append: _share_desc | append: "&textTailwind=text-lg%20mt-4%20text-gray-300&textFontFamily=Inter&logoTailwind=h-12&bgTailwind=bg-gradient-to-br%20from-green-900%20via-emerald-800%20to-teal-900&footer=" | append: _share_author | append: "&footerTailwind=text-gray-400&containerTailwind=p-12" -%}
    {%- elsif site.og_image -%}
        {%- assign _share_image_url = site.og_image -%}
        {%- unless _share_image_url contains '://' -%}
            {%- assign _share_image_url = _share_image_url | prepend: site.baseurl | prepend: site.url -%}
        {%- endunless -%}
    {%- endif -%}

    <!-- Itemprop meta tags for Zhihu and other platforms using Schema.org microdata -->
    <meta itemprop="name" content="{{ _share_meta_title }}" />
    <meta itemprop="description" content="{{ _share_meta_desc }}" />
    {%- if _share_image_url -%}
    <meta itemprop="image" content="{{ _share_image_url }}" />
    {%- endif -%}

    <!-- WeChat/Weibo/QQ specific meta tags for Chinese social platforms -->
    {%- comment -%} 
    These platforms primarily use Open Graph tags, but some also check these additional tags.
    WeChat uses JS-SDK for custom sharing, but falls back to these meta tags.
    {%- endcomment -%}
    <meta name="weibo:article:title" content="{{ _share_meta_title }}" />
    <meta name="weibo:article:description" content="{{ _share_meta_desc }}" />
    {%- if _share_image_url -%}
    <meta name="weibo:article:image" content="{{ _share_image_url }}" />
    {%- endif -%}

{%- if site.serve_og_meta %}

    <!-- OpenGraph -->
    <meta property="og:site_name" content="{{ title }}" />
    {%- if page.layout == 'post' or page.layout == 'distill' -%}
    <meta property="og:type" content="article" />
    {%- if page.date -%}
    <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}" />
    {%- endif -%}
    {%- if page.last_modified_at -%}
    <meta property="article:modified_time" content="{{ page.last_modified_at | date_to_xmlschema }}" />
    {%- endif -%}
    <meta property="article:author" content="{{ site.first_name }} {{ site.middle_name }} {{ site.last_name }}" />
    {%- if page.tags -%}
    {%- for tag in page.tags -%}
    <meta property="article:tag" content="{{ tag }}" />
    {%- endfor -%}
    {%- endif -%}
    {%- else -%}
    <meta property="og:type" content="website" />
    {%- endif -%}
    {%- comment -%} Add "Xihuai's Blog | " prefix for blog posts to build personal brand {%- endcomment -%}
    <meta property="og:title" content="{{ _share_meta_title }}" />
    <meta property="og:url" content="{{ page.url | replace:'index.html','' | absolute_url }}" />
    <meta property="og:description" content="{{ _share_meta_desc }}" />
    
    {%- comment -%} Use unified share image URL calculated earlier {%- endcomment -%}
    {%- if _share_image_url -%}
    <meta property="og:image" content="{{ _share_image_url }}" />
    <meta property="og:image:secure_url" content="{{ _share_image_url }}" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="{{ _share_meta_title }}" />
    {%- endif -%}
        {%- assign _page_lang = page.lang | default: site.lang -%}
        {%- if _page_lang == 'zh' -%}
            {%- assign _og_locale = 'zh_CN' -%}
        {%- elsif _page_lang == 'en' -%}
            {%- assign _og_locale = 'en_US' -%}
        {%- else -%}
            {%- assign _og_locale = _page_lang -%}
        {%- endif -%}
        <meta property="og:locale" content="{{ _og_locale }}" />

        <!-- Twitter card -->
        {%- if page.twitter_card -%}
            {%- assign _twitter_card = page.twitter_card -%}
        {%- elsif page.layout == 'post' or page.layout == 'distill' -%}
            {%- assign _twitter_card = 'summary_large_image' -%}
        {%- else -%}
            {%- assign _twitter_card = site.twitter_card | default: 'summary_large_image' -%}
        {%- endif -%}
    <meta name="twitter:card" content="{{ _twitter_card }}" />
    {%- comment -%} Add "Xihuai's Blog | " prefix for blog posts to build personal brand {%- endcomment -%}
    <meta name="twitter:title" content="{{ _share_meta_title }}" />
    <meta name="twitter:description" content="{{ _share_meta_desc }}" />
    
    {%- comment -%} Use unified share image URL for Twitter {%- endcomment -%}
    {%- if _share_image_url -%}
    <meta name="twitter:image" content="{{ _share_image_url }}" />
    <meta name="twitter:image:alt" content="{{ _share_meta_title }}" />
    {%- endif %}
    {% if site.twitter_username -%}
    <meta name="twitter:site" content="@{{ site.twitter_username }}" />
    <meta name="twitter:creator" content="@{{ site.twitter_username }}" />
    {%- endif %}
{%- endif %}

{%- if site.serve_schema_org %}

    <!-- Schema.org -->
    {%- comment -%} Social links generator for "sameAs schema" {%- endcomment %}
    {% assign sameaslinks = "" | split: "," %}
    {%- if site.orcid_id -%}
        {%- capture link -%}https://orcid.org/{{ site.orcid_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.scholar_userid -%}
        {%- capture link -%}https://scholar.google.com/citations?user={{ site.scholar_userid }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.semanticscholar_id -%}
        {%- capture link -%}https://www.semanticscholar.org/author/{{ site.semanticscholar_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.publons_id -%}
        {%- capture link -%}https://publons.com/a/{{ site.publons_id }}/{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.research_gate_profile -%}
        {%- capture link -%}https://www.researchgate.net/profile/{{site.research_gate_profile}}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.github_username -%}
        {%- capture link -%}https://github.com/{{ site.github_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.telegram_username -%}
        {%- capture link -%}https://telegram.me/{{ site.telegram_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.linkedin_username -%}
        {%- capture link -%}https://www.linkedin.com/in/{{ site.linkedin_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.twitter_username -%}
        {%- capture link -%}https://twitter.com/{{ site.twitter_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.medium_username -%}
        {%- capture link -%}https://medium.com/@{{ site.medium_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.quora_username -%}
        {%- capture link -%}https://www.quora.com/profile/{{ site.quora_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.blogger_url -%}
        {%- capture link -%}{{ site.blogger_url }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.work_url -%}
        {%- capture link -%}{{ site.work_url }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.wikidata_id -%}
        {%- capture link -%}https://www.wikidata.org/wiki/{{ site.wikidata_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.wikipedia_id -%}
        {%- capture link -%}https://wikipedia.org/wiki/User:{{ site.wikipedia_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.strava_userid -%}
        {%- capture link -%}https://www.strava.com/athletes/{{ site.strava_userid }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.keybase_username -%}
        {%- capture link -%}https://keybase.io/{{ site.keybase_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.gitlab_username -%}
        {%- capture link -%}https://gitlab.com/{{ site.gitlab_username }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.dblp_url -%}
        {%- capture link -%}{{ site.dblp_url }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.stackoverflow_id -%}
        {%- capture link -%}https://stackoverflow.com/users/{{ site.stackoverflow_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.kaggle_id -%}
        {%- capture link -%}https://www.kaggle.com/{{ site.kaggle_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.lastfm_id -%}
        {%- capture link -%}https://www.last.fm/user/{{ site.lastfm_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.spotify_id -%}
        {%- capture link -%}https://open.spotify.com/user/{{ site.spotify_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.pinterest_id -%}
        {%- capture link -%}https://www.pinterest.com/{{ site.pinterest_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.unsplash_id -%}
        {%- capture link -%}https://unsplash.com/@{{ site.unsplash_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.instagram_id -%}
        {%- capture link -%}https://instagram.com/{{ site.instagram_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.facebook_id -%}
        {%- capture link -%}https://facebook.com/{{ site.facebook_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- if site.discord_id -%}
        {%- capture link -%}https://discord.com/users/{{ site.discord_id }}{%- endcapture -%}
        {%- assign sameaslinks = sameaslinks | push: link -%}
    {%- endif -%}
    {%- comment -%}
    sameaslinks is already an array built via push, no need to split.
    The previous `split: ""` was incorrect and could corrupt the array.
    {%- endcomment -%}

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        {%- if page.layout == 'post' or page.layout == 'distill' -%}
        "@type": "BlogPosting",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": {{ page.url | replace:'index.html','' | absolute_url | jsonify }}
        },
        "headline": {{ _share_meta_title | jsonify }},
        "description": {{ _share_meta_desc | jsonify }},
        {%- if _share_image_url -%}
        "image": {{ _share_image_url | jsonify }},
        {%- endif -%}
        "author": {
          "@type": "Person",
          "name": "{{ site.first_name }} {{ site.middle_name }} {{ site.last_name }}"
        },
        "publisher": {
          "@type": "Person",
          "name": "{{ site.first_name }} {{ site.middle_name }} {{ site.last_name }}"
        },
        {%- if page.date -%}
        "datePublished": "{{ page.date | date_to_xmlschema }}",
        {%- endif -%}
        {%- if page.last_modified_at -%}
        "dateModified": "{{ page.last_modified_at | date_to_xmlschema }}",
        {%- elsif page.date -%}
        "dateModified": "{{ page.date | date_to_xmlschema }}",
        {%- endif -%}
        {%- elsif page.url == '/' -%}
        "@type": "WebSite",
        "name": "{{ site.first_name }} {{ site.middle_name }} {{ site.last_name }}",
        "description": {{ _share_meta_desc | jsonify }},
        {%- else -%}
        "@type": "WebPage",
        "name": {{ _share_meta_title | jsonify }},
        "description": {{ _share_meta_desc | jsonify }},
        {%- endif -%}
        "url": {{ page.url | replace:'index.html','' | absolute_url | jsonify }}{% if sameaslinks.size > 0 %},
        "sameAs": {{ sameaslinks | jsonify }}
        {%- endif %}
      }
    </script>
{%- endif %}
