<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡ | Xihuai Wang's Page</title>
    <meta name="author" content="Xihuai Leo Wang" />
    <meta name="description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1ã€k2ã€k3 çš„æ€§è´¨å·®å¼‚ï¼Œå¹¶ç»™å‡ºç”¨äº reward æƒ©ç½šä¸ç”¨äº loss å›ä¼ æ—¶çš„é€‰å‹æŒ‡å—ã€‚" />
    <meta name="keywords" content="Reinforcement Learning, Multi-agent System" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-cn.html">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header --><header>

  <!-- Nav Bar -->
  <nav id="navbar"
    class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      <a class="navbar-brand title font-weight-lighter" href="/">Xihuai Wang's Page</a>
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>

      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">

          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">about</a>
          </li>
          

          <!-- CV -->
          <!-- 
          <li class="nav-item ">
            <a class="nav-link" href="/assets/pdf/" target="_blank"
              rel="noopener noreferrer">cv</a>
          </li> -->
          <!-- Other pages -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">Xihuai's Blog</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="/publications/">publications</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="/cv/">cv</a>
          </li>

          <!-- Toogle theme mode -->
          <li class="toggle-container">
            <button id="light-toggle" title="Change theme">
              <i class="fas fa-moon"></i>
              <i class="fas fa-sun"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Scrolling Progress Bar -->
  <progress id="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡</h1>
    <p class="post-meta">December 1, 2025</p>
    <p class="post-tags">
  <a href="/blog/2025"> ğŸ“… 2025 </a>
      &nbsp; &middot; &nbsp;
        <a href="/blog/category/reinforcement-learning">
          ğŸ·ï¸ reinforcement-learning</a> &nbsp;
          

    </p>
  </header>

  <article class="post-content">
    <ul id="markdown-toc">
  <li><a href="#å¼•è¨€kl-æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²" id="markdown-toc-å¼•è¨€kl-æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²">å¼•è¨€ï¼šKL æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²</a>    <ul>
      <li><a href="#æ­£å‘-kl-ä¸åå‘-kl-çš„åŒºåˆ«" id="markdown-toc-æ­£å‘-kl-ä¸åå‘-kl-çš„åŒºåˆ«">æ­£å‘ KL ä¸åå‘ KL çš„åŒºåˆ«</a></li>
    </ul>
  </li>
  <li><a href="#ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†" id="markdown-toc-ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†">ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†</a>    <ul>
      <li><a href="#k_1æœ€æœ´ç´ çš„ä¼°è®¡å™¨" id="markdown-toc-k_1æœ€æœ´ç´ çš„ä¼°è®¡å™¨">$k_1$ï¼šæœ€æœ´ç´ çš„ä¼°è®¡å™¨</a></li>
      <li><a href="#k_2åŸºäº-f-æ•£åº¦çš„ä½æ–¹å·®ä¼°è®¡å™¨" id="markdown-toc-k_2åŸºäº-f-æ•£åº¦çš„ä½æ–¹å·®ä¼°è®¡å™¨">$k_2$ï¼šåŸºäº f-æ•£åº¦çš„ä½æ–¹å·®ä¼°è®¡å™¨</a></li>
      <li><a href="#k_3æ§åˆ¶å˜é‡æ³•æ„é€ çš„æœ€ä¼˜ä¼°è®¡å™¨" id="markdown-toc-k_3æ§åˆ¶å˜é‡æ³•æ„é€ çš„æœ€ä¼˜ä¼°è®¡å™¨">$k_3$ï¼šæ§åˆ¶å˜é‡æ³•æ„é€ çš„ã€Œæœ€ä¼˜ã€ä¼°è®¡å™¨</a></li>
      <li><a href="#ä¸‰è€…å¯¹æ¯”æ€»ç»“" id="markdown-toc-ä¸‰è€…å¯¹æ¯”æ€»ç»“">ä¸‰è€…å¯¹æ¯”æ€»ç»“</a></li>
    </ul>
  </li>
  <li><a href="#æ ¸å¿ƒåˆ†æ" id="markdown-toc-æ ¸å¿ƒåˆ†æ">æ ¸å¿ƒåˆ†æ</a>    <ul>
      <li><a href="#ä¼°è®¡-kl-æ•°å€¼æ—¶çš„åå·®ä¸æ–¹å·®" id="markdown-toc-ä¼°è®¡-kl-æ•°å€¼æ—¶çš„åå·®ä¸æ–¹å·®">ä¼°è®¡ KL æ•°å€¼æ—¶çš„åå·®ä¸æ–¹å·®</a></li>
      <li><a href="#ä¼°è®¡-kl-æ¢¯åº¦æ—¶çš„å…³é”®åŒºåˆ†" id="markdown-toc-ä¼°è®¡-kl-æ¢¯åº¦æ—¶çš„å…³é”®åŒºåˆ†">ä¼°è®¡ KL æ¢¯åº¦æ—¶çš„å…³é”®åŒºåˆ†</a>        <ul>
          <li><a href="#æ­£å‘ä¸åå‘-kl-çœŸæ¢¯åº¦çš„æ¨å¯¼" id="markdown-toc-æ­£å‘ä¸åå‘-kl-çœŸæ¢¯åº¦çš„æ¨å¯¼">æ­£å‘ä¸åå‘ KL çœŸæ¢¯åº¦çš„æ¨å¯¼</a></li>
          <li><a href="#ä¸¤ç§æ±‚å¯¼é¡ºåº" id="markdown-toc-ä¸¤ç§æ±‚å¯¼é¡ºåº">ä¸¤ç§æ±‚å¯¼é¡ºåº</a></li>
          <li><a href="#ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼" id="markdown-toc-ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼">ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼</a></li>
          <li><a href="#å…ˆæœŸæœ›åæ¢¯åº¦vså…ˆæ¢¯åº¦åæœŸæœ›" id="markdown-toc-å…ˆæœŸæœ›åæ¢¯åº¦vså…ˆæ¢¯åº¦åæœŸæœ›">ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€vsã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#rl-å®è·µæŒ‡å—" id="markdown-toc-rl-å®è·µæŒ‡å—">RL å®è·µæŒ‡å—</a>    <ul>
      <li><a href="#kl-ä½œä¸º-reward-æƒ©ç½šä¸éœ€è¦æ¢¯åº¦" id="markdown-toc-kl-ä½œä¸º-reward-æƒ©ç½šä¸éœ€è¦æ¢¯åº¦">KL ä½œä¸º Reward æƒ©ç½šï¼ˆä¸éœ€è¦æ¢¯åº¦ï¼‰</a></li>
      <li><a href="#kl-ä½œä¸º-losséœ€è¦æ¢¯åº¦å›ä¼ " id="markdown-toc-kl-ä½œä¸º-losséœ€è¦æ¢¯åº¦å›ä¼ ">KL ä½œä¸º Lossï¼ˆéœ€è¦æ¢¯åº¦å›ä¼ ï¼‰</a>        <ul>
          <li><a href="#ä¼˜åŒ–åå‘-klæœ€å¸¸è§åœºæ™¯" id="markdown-toc-ä¼˜åŒ–åå‘-klæœ€å¸¸è§åœºæ™¯">ä¼˜åŒ–åå‘ KLï¼ˆæœ€å¸¸è§åœºæ™¯ï¼‰</a></li>
          <li><a href="#ä¼˜åŒ–æ­£å‘-klè¦†ç›–å‹åœºæ™¯" id="markdown-toc-ä¼˜åŒ–æ­£å‘-klè¦†ç›–å‹åœºæ™¯">ä¼˜åŒ–æ­£å‘ KLï¼ˆè¦†ç›–å‹åœºæ™¯ï¼‰</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#ä¸€ä»½æ‹¿æ¥å°±ç”¨çš„å¯¹ç…§è¡¨" id="markdown-toc-ä¸€ä»½æ‹¿æ¥å°±ç”¨çš„å¯¹ç…§è¡¨">ä¸€ä»½ã€Œæ‹¿æ¥å°±ç”¨ã€çš„å¯¹ç…§è¡¨</a></li>
  <li><a href="#å¸¸è§å®ç°é™·é˜±" id="markdown-toc-å¸¸è§å®ç°é™·é˜±">å¸¸è§å®ç°é™·é˜±</a></li>
  <li><a href="#æ€»ç»“" id="markdown-toc-æ€»ç»“">æ€»ç»“</a></li>
  <li><a href="#å‚è€ƒæ–‡çŒ®" id="markdown-toc-å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></li>
</ul>

<blockquote>
  <p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ $k_1, k_2, k_3$ çš„æ€§è´¨å·®å¼‚ï¼Œå¹¶ç»™å‡ºã€Œç”¨äº reward æƒ©ç½šã€ä¸ã€Œç”¨äº loss å›ä¼ ã€æ—¶çš„é€‰å‹æŒ‡å—ã€‚</p>
</blockquote>

<p><a href="https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-en.html">English Version</a> | <a href="https://zhuanlan.zhihu.com/p/1978993413425763764">çŸ¥ä¹ç‰ˆæœ¬ <img src="https://static.zhihu.com/heifetz/favicon.ico" alt="Zhihu" /></a></p>

<p><img src="/assets/img/kl-estimator-cn.png" alt="Mini-class" style="display:block;margin:0 auto;width:95%;max-width:100%;" /></p>

<h2 id="å¼•è¨€kl-æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²">å¼•è¨€ï¼šKL æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²</h2>

<p>åœ¨ç­–ç•¥ä¼˜åŒ–ï¼ˆPPOã€GRPO ç­‰ï¼‰æˆ–å¯¹é½è®­ç»ƒï¼ˆRLHF/RLAIFï¼‰ä¸­ï¼Œ<strong>KL æƒ©ç½š</strong>æ˜¯çº¦æŸæ–°ç­–ç•¥ä¸åç¦»å‚è€ƒç­–ç•¥çš„æ ¸å¿ƒæ‰‹æ®µï¼Œç”¨ä»¥é˜²æ­¢è®­ç»ƒä¸ç¨³å®šæˆ–ç­–ç•¥å´©æºƒã€‚</p>

<h3 id="æ­£å‘-kl-ä¸åå‘-kl-çš„åŒºåˆ«">æ­£å‘ KL ä¸åå‘ KL çš„åŒºåˆ«</h3>

<p>è®¾ $q_\theta$ ä¸ºå½“å‰ actor ç­–ç•¥ï¼Œ$p$ ä¸ºå‚è€ƒç­–ç•¥ï¼Œä¸¤ç§æ–¹å‘çš„ KL æ•£åº¦åˆ†åˆ«ä¸ºï¼š</p>

<p><strong>åå‘ KLï¼ˆReverse KLï¼‰</strong>ï¼š
\(D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{x \sim q_\theta}\left[\log \frac{q_\theta(x)}{p(x)}\right]\)</p>

<figure style="text-align:center;">
  <img src="/assets/img/kl-estimator-reverse.png" style="width:95%;max-width:100%;" />
  <figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://dibyaghosh.com/blog/probability/kldivergence/">Dibya Ghosh's Blog</a></figcaption>
</figure>

<p><strong>æ­£å‘ KLï¼ˆForward KLï¼‰</strong>ï¼š
\(D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_{x \sim p}\left[\log \frac{p(x)}{q_\theta(x)}\right]\)</p>

<figure style="text-align:center;">
  <img src="/assets/img/kl-estimator-forward.png" style="width:95%;max-width:100%;" />
  <figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://dibyaghosh.com/blog/probability/kldivergence/">Dibya Ghosh's Blog</a></figcaption>
</figure>

<p><strong>ç›´è§‰ç†è§£</strong>ï¼š</p>
<ul>
  <li><strong>åå‘ KL</strong> å€¾å‘äºã€Œæ¨¡å¼å¯»ä¼˜ã€ï¼ˆmode-seekingï¼‰â€”â€”ç­–ç•¥ä¼šé›†ä¸­åœ¨å‚è€ƒåˆ†å¸ƒçš„é«˜æ¦‚ç‡åŒºåŸŸï¼Œå¯èƒ½ç‰ºç‰²å¤šæ ·æ€§</li>
  <li><strong>æ­£å‘ KL</strong> å€¾å‘äºã€Œè´¨é‡è¦†ç›–ã€ï¼ˆmass-coveringï¼‰â€”â€”ç­–ç•¥ä¼šå°½é‡è¦†ç›–å‚è€ƒåˆ†å¸ƒçš„æ”¯æ’‘é›†</li>
</ul>

<p>åœ¨ RLHF çš„ä¸»æµå®ç°ä¸­ï¼Œ<strong>åå‘ KL</strong> æ›´ä¸ºå¸¸è§ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ› actor ä¸è¦åç¦» reference policy å¤ªè¿œï¼Œè€Œéè¦æ±‚å®Œå…¨è¦†ç›–æ‰€æœ‰æ¨¡å¼ã€‚</p>

<h2 id="ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†">ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†</h2>

<p>è®¾æ¯”å€¼ $r(x) = \frac{p(x)}{q_\theta(x)}$ï¼ŒJohn Schulman æå‡ºçš„ä¸‰ç§å•æ ·æœ¬ä¼°è®¡å­å®šä¹‰å¦‚ä¸‹ï¼š</p>

<h3 id="k_1æœ€æœ´ç´ çš„ä¼°è®¡å™¨">$k_1$ï¼šæœ€æœ´ç´ çš„ä¼°è®¡å™¨</h3>

\[k_1(x) = -\log r = \log q_\theta(x) - \log p(x)\]

<p>è¿™æ˜¯æœ€ç›´æ¥çš„å®šä¹‰â€”â€”ç›´æ¥å– log-ratio çš„è´Ÿå€¼ã€‚å®ƒå¯¹åå‘ KL æ— åï¼Œä½†æœ‰ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼š<strong>å¯èƒ½å–è´Ÿå€¼</strong>ï¼Œè€Œ KL æ•£åº¦å§‹ç»ˆéè´Ÿã€‚è¿™å¯¼è‡´å…¶æ–¹å·®æé«˜ï¼Œå› ä¸ºæ­£è´Ÿæ ·æœ¬ä¼šç›¸äº’æŠµæ¶ˆã€‚</p>

<h3 id="k_2åŸºäº-f-æ•£åº¦çš„ä½æ–¹å·®ä¼°è®¡å™¨">$k_2$ï¼šåŸºäº f-æ•£åº¦çš„ä½æ–¹å·®ä¼°è®¡å™¨</h3>

\[k_2(x) = \frac{1}{2}(\log r)^2\]

<p><strong>è®¾è®¡åŠ¨æœº</strong>ï¼š$k_1$ çš„é—®é¢˜åœ¨äºå¯æ­£å¯è´Ÿï¼Œè€Œ $k_2$ é€šè¿‡å–å¹³æ–¹ä¿è¯<strong>æ¯ä¸ªæ ·æœ¬éƒ½æ˜¯æ­£çš„</strong>ï¼Œç›´è§‚ä¸Šæ¯ä¸ªæ ·æœ¬éƒ½åœ¨å‘Šè¯‰ä½  $p$ å’Œ $q$ ç›¸å·®å¤šè¿œã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆåå·®å¾ˆå°ï¼Ÿ</strong> $k_2$ æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <strong>f-æ•£åº¦</strong>ï¼ˆf-divergenceï¼‰ï¼Œå…¶ä¸­ $f(x) = \frac{1}{2}(\log x)^2$ã€‚f-æ•£åº¦æœ‰ä¸€ä¸ªä¼˜ç¾çš„æ€§è´¨ï¼š<strong>æ‰€æœ‰å¯å¾®çš„ f-æ•£åº¦åœ¨ $q \approx p$ æ—¶ï¼ŒäºŒé˜¶å±•å¼€éƒ½å½¢å¦‚</strong></p>

\[D_f(p, q_\theta) = \frac{f''(1)}{2} \theta^T F \theta + O(\theta^3)\]

<p>å…¶ä¸­ $F$ æ˜¯ Fisher ä¿¡æ¯çŸ©é˜µã€‚KL æ•£åº¦å¯¹åº” $f(x) = -\log x$ï¼Œæœ‰ $fâ€™â€˜(1) = 1$ï¼›è€Œ $k_2$ å¯¹åº”çš„ $f(x) = \frac{1}{2}(\log x)^2$ï¼ŒåŒæ ·æœ‰ $fâ€™â€˜(1) = 1$ã€‚è¿™æ„å‘³ç€<strong>å½“ç­–ç•¥æ¥è¿‘æ—¶ï¼Œ$k_2$ ä¸çœŸå® KL çš„è¡Œä¸ºå‡ ä¹ä¸€è‡´</strong>ï¼Œåå·®ä»…ä½“ç°åœ¨é«˜é˜¶é¡¹ã€‚</p>

<h3 id="k_3æ§åˆ¶å˜é‡æ³•æ„é€ çš„æœ€ä¼˜ä¼°è®¡å™¨">$k_3$ï¼šæ§åˆ¶å˜é‡æ³•æ„é€ çš„ã€Œæœ€ä¼˜ã€ä¼°è®¡å™¨</h3>

\[k_3(x) = r - 1 - \log r\]

<p><strong>è®¾è®¡åŠ¨æœº</strong>ï¼šæˆ‘ä»¬æƒ³è¦ä¸€ä¸ª<strong>æ—¢æ— ååˆä½æ–¹å·®</strong>çš„ä¼°è®¡å™¨ã€‚æ ‡å‡†åšæ³•æ˜¯ç»™ $k_1$ åŠ ä¸€ä¸ª<strong>æ§åˆ¶å˜é‡</strong>ï¼ˆcontrol variateï¼‰â€”â€”ä¸€ä¸ªæœŸæœ›ä¸ºé›¶ä½†ä¸ $k_1$ è´Ÿç›¸å…³çš„é‡ã€‚</p>

<p>æ³¨æ„åˆ° $\mathbb{E}_q[r - 1] = \mathbb{E}_q\left[\frac{p}{q}\right] - 1 = 1 - 1 = 0$ï¼Œæ‰€ä»¥å¯¹äºä»»æ„ $\lambda$ï¼Œ</p>

\[k_1 + \lambda(r - 1) = -\log r + \lambda(r - 1)\]

<p>ä»ç„¶æ˜¯æ— åä¼°è®¡ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆé€‰ $\lambda = 1$ï¼Ÿ</strong> ç”±äº $\log$ æ˜¯å‡¹å‡½æ•°ï¼Œæœ‰ $\log x \leq x - 1$ï¼Œå› æ­¤</p>

\[k_3 = (r - 1) - \log r \geq 0\]

<p><strong>å§‹ç»ˆéè´Ÿ</strong>ï¼è¿™ä¿è¯äº†æ¯ä¸ªæ ·æœ¬éƒ½åœ¨ã€Œæ­£å‘ã€è´¡çŒ®ä¿¡æ¯ï¼Œæ¶ˆé™¤äº† $k_1$ æ­£è´ŸæŠµæ¶ˆçš„é—®é¢˜ã€‚</p>

<p><strong>å‡ ä½•ç›´è§‰</strong>ï¼š$k_3$ å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>Bregman æ•£åº¦</strong>ã€‚è€ƒè™‘å‡¸å‡½æ•° $\phi(x) = -\log x$ï¼Œå®ƒåœ¨ $x=1$ å¤„çš„åˆ‡çº¿ä¸º $y = 1 - x$ã€‚Bregman æ•£åº¦å®šä¹‰ä¸ºã€Œå‡½æ•°å€¼ä¸åˆ‡çº¿å€¼ä¹‹å·®ã€ï¼š</p>

\[D_\phi(r, 1) = \phi(r) - \phi(1) - \phi'(1)(r - 1) = -\log r - 0 - (-1)(r-1) = r - 1 - \log r = k_3\]

<p>ç”±äºå‡¸å‡½æ•°å§‹ç»ˆä½äºå…¶åˆ‡çº¿ä¸Šæ–¹ï¼Œè¿™ä¸ªå·®å€¼<strong>å¤©ç„¶éè´Ÿ</strong>ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨ $r \to 1$ æ—¶ï¼Œå‡½æ•°ä¸åˆ‡çº¿ã€Œè´´åˆã€å¾—è¶Šæ¥è¶Šç´§ï¼Œå·®å€¼ä»¥ $(r-1)^2$ çš„äºŒé˜¶é€Ÿåº¦è¶‹è¿‘äºé›¶â€”â€”è¿™æ­£æ˜¯ $k_3$ åœ¨ç­–ç•¥æ¥è¿‘æ—¶æ–¹å·®å°çš„æ ¹æœ¬åŸå› ã€‚</p>

<h3 id="ä¸‰è€…å¯¹æ¯”æ€»ç»“">ä¸‰è€…å¯¹æ¯”æ€»ç»“</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: left">å®šä¹‰</th>
      <th style="text-align: left">è®¾è®¡åŸç†</th>
      <th style="text-align: center">å¯¹æ•°å€¼çš„åå·®</th>
      <th style="text-align: left">æ–¹å·®ç‰¹æ€§</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: left">$-\log r$</td>
      <td style="text-align: left">æœ€æœ´ç´ å®šä¹‰</td>
      <td style="text-align: center">æ— å</td>
      <td style="text-align: left">é«˜ï¼ˆå¯æ­£å¯è´Ÿï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: left">$\frac{1}{2}(\log r)^2$</td>
      <td style="text-align: left">f-æ•£åº¦ï¼ŒäºŒé˜¶è¡Œä¸ºä¸ KL ä¸€è‡´</td>
      <td style="text-align: center">æœ‰åï¼ˆä½†æå°ï¼‰</td>
      <td style="text-align: left">ä½ï¼ˆæ’æ­£ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: left">$r - 1 - \log r$</td>
      <td style="text-align: left">æ§åˆ¶å˜é‡ + Bregman æ•£åº¦</td>
      <td style="text-align: center">æ— å</td>
      <td style="text-align: left">ä½ï¼ˆæ’æ­£ï¼‰</td>
    </tr>
  </tbody>
</table>

<p>ä»æ•°å€¼ä¼°è®¡çš„è§’åº¦çœ‹ï¼Œ$k_3$ æ˜¯ã€Œæ— å + ä½æ–¹å·®ã€çš„æœ€ä¼˜é€‰æ‹©ï¼›ä½†æ­£å¦‚åæ–‡å°†åˆ†æçš„ï¼Œ<strong>æ¢¯åº¦å±‚é¢çš„æ•…äº‹å®Œå…¨ä¸åŒ</strong>ã€‚</p>

<h2 id="æ ¸å¿ƒåˆ†æ">æ ¸å¿ƒåˆ†æ</h2>

<h3 id="ä¼°è®¡-kl-æ•°å€¼æ—¶çš„åå·®ä¸æ–¹å·®">ä¼°è®¡ KL æ•°å€¼æ—¶çš„åå·®ä¸æ–¹å·®</h3>

<p>å‡è®¾ä» $q_\theta$ é‡‡æ ·æ¥ä¼°è®¡åå‘ KL $D_{\mathrm{KL}}(q_\theta | p)$ï¼š</p>

<p><strong>æ— åæ€§åˆ†æ</strong>ï¼š</p>

\[\mathbb{E}_{q}[k_1] = \mathbb{E}_{q}\left[\log \frac{q}{p}\right] = D_{\mathrm{KL}}(q \| p) \quad \textbf{ï¼ˆæ— åï¼‰}\]

\[\mathbb{E}_{q}[k_3] = \mathbb{E}_{q}[r - 1 - \log r] = 1 - 1 + D_{\mathrm{KL}}(q \| p) = D_{\mathrm{KL}}(q \| p) \quad \textbf{ï¼ˆæ— åï¼‰}\]

\[\mathbb{E}_{q}[k_2] = \frac{1}{2}\mathbb{E}_{q}[(\log r)^2] \neq D_{\mathrm{KL}}(q \| p) \quad \textbf{ï¼ˆæœ‰åï¼‰}\]

<p><strong>ç»“è®º</strong>ï¼šå¯¹äºä¼°è®¡åå‘ KL çš„<strong>æ•°å€¼</strong>ï¼Œ$k_1$ å’Œ $k_3$ æ˜¯æ— åä¼°è®¡ï¼Œè€Œ $k_2$ æ˜¯æœ‰åçš„ã€‚</p>

<p><strong>æ–¹å·®ç‰¹æ€§çš„ Trade-off</strong>ï¼š</p>

<p>John Schulman çš„å®éªŒï¼ˆ$q = \mathcal{N}(0,1)$ï¼Œ$p = \mathcal{N}(0.1,1)$ï¼ŒçœŸå® KL = 0.005ï¼‰è¡¨æ˜ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">bias/true</th>
      <th style="text-align: center">stdev/true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">20</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">0.002</td>
      <td style="text-align: center">1.42</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1.42</td>
    </tr>
  </tbody>
</table>

<p>å½“ KL è¾ƒå¤§æ—¶ï¼ˆ$p = \mathcal{N}(1,1)$ï¼ŒçœŸå® KL = 0.5ï¼‰ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">bias/true</th>
      <th style="text-align: center">stdev/true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">2</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">0.25</td>
      <td style="text-align: center">1.73</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1.7</td>
    </tr>
  </tbody>
</table>

<p><strong>æ ¸å¿ƒç›´è§‰</strong>ï¼š</p>
<ul>
  <li>$k_1 = -\log r$ ä»¥ä¸€é˜¶é¡¹èµ·æ­¥ï¼Œå½“ $r$ æ¥è¿‘ 1 æ—¶æ³¢åŠ¨è¾ƒå¤§ï¼Œä¸”å¯èƒ½å–è´Ÿå€¼</li>
  <li>$k_3 = r - 1 - \log r$ åœ¨ $r=1$ å¤„æ˜¯äºŒé˜¶å°é‡ï¼Œå§‹ç»ˆéè´Ÿï¼Œå› æ­¤åœ¨ç­–ç•¥æ¥è¿‘æ—¶æ–¹å·®æ›´å°</li>
  <li>ä½†å½“è¦†ç›–ä¸¥é‡ä¸è¶³ï¼ˆ$r$ å¯èƒ½çˆ†ç‚¸ï¼‰æ—¶ï¼Œ$k_3$ çš„æ–¹å·®ä¼šè¢«æƒé‡çˆ†ç‚¸æ‹–ç´¯ï¼›æ­¤æ—¶ $k_1$ åè€Œæ›´ç¨³å®š</li>
</ul>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šè‹¥è¦ä¼°è®¡<strong>æ­£å‘ KL çš„æ•°å€¼</strong> $D_{\mathrm{KL}}(p | q) = \mathbb{E}_p[\log r]$ï¼Œè€Œåªèƒ½ä» $q$ é‡‡æ ·ï¼Œå¯ç”¨é‡è¦æ€§é‡‡æ · $\mathbb{E}_q[r \log r]$ã€‚</p>
</blockquote>

<h3 id="ä¼°è®¡-kl-æ¢¯åº¦æ—¶çš„å…³é”®åŒºåˆ†">ä¼°è®¡ KL æ¢¯åº¦æ—¶çš„å…³é”®åŒºåˆ†</h3>

<p><strong>è¿™æ˜¯æœ€å®¹æ˜“æ··æ·†ã€ä¹Ÿæ˜¯å®è·µä¸­æœ€å…³é”®çš„éƒ¨åˆ†ã€‚</strong></p>

<h4 id="æ­£å‘ä¸åå‘-kl-çœŸæ¢¯åº¦çš„æ¨å¯¼">æ­£å‘ä¸åå‘ KL çœŸæ¢¯åº¦çš„æ¨å¯¼</h4>

<p>åœ¨åˆ†æä¼°è®¡å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¨å¯¼æ­£å‘å’Œåå‘ KL æ•£åº¦å¯¹ $\theta$ çš„<strong>çœŸæ¢¯åº¦</strong>ä½œä¸ºå‚ç…§ã€‚</p>

<p>è®° score function $s_\theta(x) = \nabla_\theta \log q_\theta(x)$ï¼Œå®ƒæœ‰ä¸€ä¸ªé‡è¦æ€§è´¨ï¼š$\mathbb{E}<em>{q</em>\theta}[s_\theta] = 0$ï¼ˆå› ä¸º $\int \nabla_\theta q_\theta dx = \nabla_\theta \int q_\theta dx = \nabla_\theta 1 = 0$ï¼‰ã€‚</p>

<p><strong>åå‘ KL çš„æ¢¯åº¦</strong>ï¼š</p>

\[D_{\mathrm{KL}}(q_\theta \| p) = \int q_\theta(x) \log \frac{q_\theta(x)}{p(x)} dx\]

<p>å¯¹ $\theta$ æ±‚æ¢¯åº¦ï¼ˆä½¿ç”¨ä¹˜ç§¯æ³•åˆ™ï¼‰ï¼š</p>

\[\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \int \nabla_\theta q_\theta \cdot \log \frac{q_\theta}{p} dx + \int q_\theta \cdot \nabla_\theta \log \frac{q_\theta}{p} dx\]

<p>åˆ©ç”¨ $\nabla_\theta q_\theta = q_\theta \cdot s_\theta$ ä»¥åŠ $\nabla_\theta \log q_\theta = s_\theta$ã€$\nabla_\theta \log p = 0$ï¼š</p>

\[= \mathbb{E}_q\left[s_\theta \cdot \log \frac{q_\theta}{p}\right] + \mathbb{E}_q[s_\theta] = \mathbb{E}_q\left[s_\theta \cdot \log \frac{q_\theta}{p}\right]\]

<p>å³ï¼š</p>

\[\boxed{\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_q\left[s_\theta \cdot \log \frac{q_\theta}{p}\right] = -\mathbb{E}_q[s_\theta \cdot \log r]}\]

<p><strong>æ­£å‘ KL çš„æ¢¯åº¦</strong>ï¼š</p>

\[D_{\mathrm{KL}}(p \| q_\theta) = \int p(x) \log \frac{p(x)}{q_\theta(x)} dx\]

<p>ç”±äº $p(x)$ ä¸ä¾èµ–äº $\theta$ï¼š</p>

\[\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = \int p(x) \cdot \nabla_\theta \left(-\log q_\theta(x)\right) dx = -\mathbb{E}_p[s_\theta]\]

<p>ä¸ºäº†ç”¨ $q$ çš„æ ·æœ¬ä¼°è®¡è¿™ä¸ªé‡ï¼Œè¿›è¡Œé‡è¦æ€§é‡‡æ ·ï¼š</p>

\[-\mathbb{E}_p[s_\theta] = -\mathbb{E}_q\left[\frac{p}{q_\theta} \cdot s_\theta\right] = -\mathbb{E}_q[r \cdot s_\theta]\]

<p>åˆ©ç”¨ $\mathbb{E}<em>q[s</em>\theta] = 0$ï¼Œå¯æ”¹å†™ä¸ºï¼š</p>

\[\boxed{\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_q[(1-r) \cdot s_\theta]}\]

<p>æœ‰äº†è¿™ä¸¤ä¸ªç»“æœï¼Œæˆ‘ä»¬å°±èƒ½åˆ¤æ–­å„ä¼°è®¡å™¨çš„æ¢¯åº¦æœŸæœ›ç©¶ç«Ÿå¯¹åº”å“ªä¸ª KL çš„çœŸæ¢¯åº¦ã€‚</p>

<h4 id="ä¸¤ç§æ±‚å¯¼é¡ºåº">ä¸¤ç§æ±‚å¯¼é¡ºåº</h4>

<p>åœ¨ä»£ç å®ç°ä¸­ï¼Œå­˜åœ¨ä¸¤æ¡è·¯å¾„ï¼š</p>

<ol>
  <li><strong>å…ˆæ¢¯åº¦ã€åæœŸæœ›</strong>ï¼šå¯¹æ¯ä¸ªæ ·æœ¬çš„ $k_i(x)$ æ±‚æ¢¯åº¦ï¼Œå†å¯¹æ¢¯åº¦æ±‚æœŸæœ›ï¼ˆMonte Carlo ä¼°è®¡ï¼‰</li>
  <li><strong>å…ˆæœŸæœ›ã€åæ¢¯åº¦</strong>ï¼šæŠŠ $\mathbb{E}_q[k_i]$ å½“ä½œæŸå¤±å‡½æ•°ï¼Œå¯¹è§£æè¡¨è¾¾å¼æ±‚æ¢¯åº¦</li>
</ol>

<p><strong>åœ¨å…¸å‹çš„æ·±åº¦å­¦ä¹ ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®é™…æ‰§è¡Œçš„æ˜¯ã€Œå…ˆæ¢¯åº¦ã€åæœŸæœ›ã€</strong>â€”â€”è‡ªåŠ¨å¾®åˆ†å¯¹æ¯ä¸ªæ ·æœ¬è®¡ç®—æ¢¯åº¦ï¼Œç„¶ååœ¨ batch ä¸Šå–å¹³å‡ã€‚</p>

<h4 id="ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼">ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼</h4>

<p>ç°åœ¨æˆ‘ä»¬è®¡ç®—ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦ï¼Œçœ‹å®ƒä»¬çš„æœŸæœ›åˆ†åˆ«å¯¹åº”å“ªä¸ª KL çš„çœŸæ¢¯åº¦ã€‚</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_1$</strong>ï¼š</p>

\[k_1 = -\log r = -\log \frac{p(x)}{q_\theta(x)} = \log q_\theta(x) - \log p(x)\]

\[\nabla_\theta k_1 = \nabla_\theta \log q_\theta(x) - \nabla_\theta \log p(x) = s_\theta - 0 = s_\theta\]

<p><strong>æ¨å¯¼ $\nabla_\theta k_2$</strong>ï¼š</p>

\[k_2 = \frac{1}{2}(\log r)^2\]

<p>ç”±é“¾å¼æ³•åˆ™ï¼š</p>

\[\nabla_\theta k_2 = (\log r) \cdot \nabla_\theta (\log r) = (\log r) \cdot \nabla_\theta \left(\log p(x) - \log q_\theta(x)\right) = (\log r) \cdot (-s_\theta) = -(\log r) \cdot s_\theta\]

<p><strong>æ¨å¯¼ $\nabla_\theta k_3$</strong>ï¼š</p>

\[k_3 = r - 1 - \log r\]

<p>é¦–å…ˆè®¡ç®— $\nabla_\theta r$ã€‚ç”±äº $r = p(x) \cdot q_\theta(x)^{-1}$ï¼š</p>

\[\nabla_\theta r = p(x) \cdot (-1) \cdot q_\theta(x)^{-2} \cdot \nabla_\theta q_\theta(x) = -\frac{p(x)}{q_\theta(x)} \cdot \frac{\nabla_\theta q_\theta(x)}{q_\theta(x)} = -r \cdot s_\theta\]

<p>å†è®¡ç®— $\nabla_\theta \log r$ï¼š</p>

\[\nabla_\theta \log r = \frac{1}{r} \nabla_\theta r = \frac{1}{r} \cdot (-r \cdot s_\theta) = -s_\theta\]

<p>å› æ­¤ï¼š</p>

\[\nabla_\theta k_3 = \nabla_\theta r - 0 - \nabla_\theta \log r = -r \cdot s_\theta - (-s_\theta) = (1 - r) \cdot s_\theta\]

<p>å¯¹å®ƒä»¬åœ¨ $q_\theta$ ä¸‹å–æœŸæœ›ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: left">$\mathbb{E}<em>{q}[\nabla</em>\theta k_i]$</th>
      <th style="text-align: left">ç­‰ä»·äº</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: left">$\mathbb{E}<em>{q}[s</em>\theta] = 0$</td>
      <td style="text-align: left"><strong>æ— æ„ä¹‰ï¼ˆæ’ä¸ºé›¶ï¼‰</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: left">$-\mathbb{E}<em>{q}[(\log r) \cdot s</em>\theta] = \nabla_\theta D_{\mathrm{KL}}(q | p)$</td>
      <td style="text-align: left"><strong>åå‘ KL çš„çœŸæ¢¯åº¦</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: left">$\mathbb{E}<em>{q}[(1-r) \cdot s</em>\theta] = \nabla_\theta D_{\mathrm{KL}}(p | q)$</td>
      <td style="text-align: left"><strong>æ­£å‘ KL çš„çœŸæ¢¯åº¦</strong></td>
    </tr>
  </tbody>
</table>

<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼š</p>
<ul>
  <li><strong>$k_2$ çš„æ¢¯åº¦</strong>ç­‰ä»·äºåå‘ KL çš„çœŸæ¢¯åº¦â€”â€”è¿™æ˜¯ä¼˜åŒ–ã€Œçº¦æŸç­–ç•¥ä¸åç¦» refã€çš„æ­£ç¡®é€‰æ‹©</li>
  <li><strong>$k_3$ çš„æ¢¯åº¦</strong>ç­‰ä»·äºæ­£å‘ KL çš„çœŸæ¢¯åº¦â€”â€”è¿™å¯¹åº”ã€Œè¦†ç›–å‹ã€ç›®æ ‡</li>
  <li><strong>$k_1$ çš„æ¢¯åº¦æœŸæœ›æ’ä¸ºé›¶</strong>â€”â€”ä½œä¸º loss åä¼ æ¯«æ— æ„ä¹‰ï¼</li>
</ul>

<h4 id="å…ˆæœŸæœ›åæ¢¯åº¦vså…ˆæ¢¯åº¦åæœŸæœ›">ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€vsã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€</h4>

<p>å¦‚æœä»è§£æè§’åº¦æŠŠ $\mathbb{E}_q[k_i]$ å½“ä½œä¸€ä¸ªå…³äº $\theta$ çš„å‡½æ•°å†æ±‚æ¢¯åº¦ï¼ˆå³ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ï¼‰ï¼Œé‚£ä¹ˆï¼š</p>

\[\nabla_\theta \mathbb{E}_q[k_1] = \nabla_\theta D_{\mathrm{KL}}(q \| p)\]

\[\nabla_\theta \mathbb{E}_q[k_3] = \nabla_\theta D_{\mathrm{KL}}(q \| p)\]

<p>ä¸¤è€…éƒ½ç»™å‡ºåå‘ KL çš„æ¢¯åº¦ã€‚ä½†åœ¨ä»£ç ä¸­ç›´æ¥å¯¹ $k_3$ çš„æ ·æœ¬å‡å€¼è°ƒç”¨åä¼ æ—¶ï¼Œè‡ªåŠ¨å¾®åˆ†æ‰§è¡Œçš„æ˜¯ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€ï¼Œå¾—åˆ°çš„æ˜¯ $\mathbb{E}<em>q[\nabla</em>\theta k_3]$ï¼Œå³<strong>æ­£å‘ KL çš„æ¢¯åº¦</strong>ã€‚</p>

<p>è¿™ä¸ªåŒºåˆ†éå¸¸é‡è¦ï¼š<strong>åŒä¸€ä¸ªä¼°è®¡å™¨ï¼Œä¸¤ç§æ±‚å¯¼é¡ºåºå¯èƒ½ç»™å‡ºå®Œå…¨ä¸åŒçš„ç»“æœ</strong>ã€‚</p>

<h2 id="rl-å®è·µæŒ‡å—">RL å®è·µæŒ‡å—</h2>

<h3 id="kl-ä½œä¸º-reward-æƒ©ç½šä¸éœ€è¦æ¢¯åº¦">KL ä½œä¸º Reward æƒ©ç½šï¼ˆä¸éœ€è¦æ¢¯åº¦ï¼‰</h3>

<p>å½“ KL ä»…ä½œä¸ºæ ‡é‡æƒ©ç½šåŠ å…¥ reward shaping æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å‡†ç¡®çš„<strong>æ•°å€¼ä¼°è®¡</strong>ï¼Œä¸éœ€è¦åä¼ æ¢¯åº¦ã€‚</p>

<p><strong>æ¨è</strong>ï¼š</p>
<ul>
  <li>ä½¿ç”¨ <strong>$k_1$</strong> æˆ– <strong>$k_3$</strong>ï¼ˆä¸¤è€…å¯¹åå‘ KL æ•°å€¼å‡æ— åï¼‰</li>
  <li>å½“ç­–ç•¥å·²æ¥è¿‘å‚è€ƒç­–ç•¥æ—¶ï¼Œ$k_3$ å¾€å¾€æ›´ä½æ–¹å·®</li>
  <li>è¦†ç›–ä¸è¶³æˆ–å°¾éƒ¨é”™é…æ˜æ˜¾æ—¶ï¼Œ$k_1$ æ›´ç¨³å¥</li>
</ul>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šè‹¥æƒ³æ–½åŠ <strong>æ­£å‘ KL æƒ©ç½š</strong>ï¼ˆåå‘è¦†ç›–è¡Œä¸ºåˆ†å¸ƒï¼‰ï¼Œæ•°å€¼ä¸Šå¯ç”¨ $\mathbb{E}_q[r \log r]$ æˆ–ï¼ˆè‹¥å¯ä» $p$ é‡‡æ ·ï¼‰$\mathbb{E}_p[\log r]$ã€‚</p>
</blockquote>

<h3 id="kl-ä½œä¸º-losséœ€è¦æ¢¯åº¦å›ä¼ ">KL ä½œä¸º Lossï¼ˆéœ€è¦æ¢¯åº¦å›ä¼ ï¼‰</h3>

<p>å½“ KL ä½œä¸º loss çš„ä¸€éƒ¨åˆ†å‚ä¸åä¼ æ—¶ï¼Œå¿…é¡»è€ƒè™‘æ¢¯åº¦çš„æ­£ç¡®æ€§ã€‚</p>

<h4 id="ä¼˜åŒ–åå‘-klæœ€å¸¸è§åœºæ™¯">ä¼˜åŒ–åå‘ KLï¼ˆæœ€å¸¸è§åœºæ™¯ï¼‰</h4>

<p>ç›®æ ‡ï¼šæ§åˆ¶ actor ä¸åç¦» reference policyã€‚</p>

<p><strong>æ­£ç¡®åšæ³•</strong>ï¼šä½¿ç”¨ <strong>$k_2$</strong> ä½œä¸º lossã€‚</p>

\[\mathcal{L}_{k_2} = \frac{1}{2}(\log r)^2\]

<p>å…¶æ¢¯åº¦æœŸæœ› $\mathbb{E}<em>q[\nabla k_2] = \nabla</em>\theta D_{\mathrm{KL}}(q | p)$ æ­£æ˜¯åå‘ KL çš„çœŸæ¢¯åº¦ã€‚</p>

<h4 id="ä¼˜åŒ–æ­£å‘-klè¦†ç›–å‹åœºæ™¯">ä¼˜åŒ–æ­£å‘ KLï¼ˆè¦†ç›–å‹åœºæ™¯ï¼‰</h4>

<p>ç›®æ ‡ï¼šè®©ç­–ç•¥è¦†ç›–å‚è€ƒåˆ†å¸ƒçš„æ”¯æ’‘é›†ï¼ˆå¦‚ç¦»çº¿ RLã€æ¨¡ä»¿å­¦ä¹ ç­‰ï¼‰ã€‚</p>

<p><strong>æ­£ç¡®åšæ³•</strong>ï¼šä½¿ç”¨ <strong>$k_3$</strong> ä½œä¸º lossã€‚</p>

\[\mathbb{E}_q[\nabla k_3] = \mathbb{E}_q[(1-r) \cdot s_\theta] = \nabla_\theta D_{\mathrm{KL}}(p \| q)\]

<p>ç›´æ¥å¯¹ $k_3$ çš„æ ·æœ¬å‡å€¼è°ƒç”¨åä¼ ï¼Œè‡ªåŠ¨å¾®åˆ†è®¡ç®—çš„å°±æ˜¯ $\mathbb{E}<em>q[\nabla</em>\theta k_3]$ï¼Œå³æ­£å‘ KL çš„æ¢¯åº¦ï¼Œæ— éœ€é¢å¤–å¤„ç†ã€‚</p>

<h2 id="ä¸€ä»½æ‹¿æ¥å°±ç”¨çš„å¯¹ç…§è¡¨">ä¸€ä»½ã€Œæ‹¿æ¥å°±ç”¨ã€çš„å¯¹ç…§è¡¨</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ç›®æ ‡</th>
      <th style="text-align: center">é‡‡æ ·æ¥æº</th>
      <th style="text-align: left">ç”¨äº<strong>æ•°å€¼</strong></th>
      <th style="text-align: left">ç”¨äº<strong>æ¢¯åº¦</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">åå‘ KL $D_{\mathrm{KL}}(q|p)$</td>
      <td style="text-align: center">$q$</td>
      <td style="text-align: left">$k_1$ æˆ– $k_3$ï¼ˆæ— åï¼‰</td>
      <td style="text-align: left">$k_2$</td>
    </tr>
    <tr>
      <td style="text-align: left">æ­£å‘ KL $D_{\mathrm{KL}}(p|q)$</td>
      <td style="text-align: center">$q$</td>
      <td style="text-align: left">$\mathbb{E}_q[r\log r]$</td>
      <td style="text-align: left">$k_3$</td>
    </tr>
  </tbody>
</table>

<h2 id="å¸¸è§å®ç°é™·é˜±">å¸¸è§å®ç°é™·é˜±</h2>

<p><strong>é™·é˜± 1ï¼šæŠŠ $k_1$ ç›´æ¥å½“ loss åä¼ </strong></p>

<p>$k_1$ çš„æ¢¯åº¦æœŸæœ›æ’ä¸ºé›¶ï¼ˆ$\mathbb{E}<em>q[\nabla k_1] = \mathbb{E}_q[s</em>\theta] = 0$ï¼‰ï¼Œä½œä¸º loss å®Œå…¨æ— æ•ˆã€‚</p>

<blockquote>
  <p><strong>è§£å†³</strong>ï¼šreward shaping ç”¨ $k_1$ æˆ– $k_3$ï¼ˆä¸éœ€è¦æ¢¯åº¦ï¼‰ï¼Œloss ç”¨ $k_2$ æˆ– $k_3$ã€‚</p>
</blockquote>

<p><strong>é™·é˜± 2ï¼šæ··æ·† $k_3$ çš„ã€Œæ•°å€¼æ— åæ€§ã€ä¸ã€Œæ¢¯åº¦å¯¹åº”çš„ç›®æ ‡ã€</strong></p>

<p>$k_3$ å¯¹<strong>åå‘ KL çš„æ•°å€¼</strong>æ˜¯æ— åä¼°è®¡ï¼Œä½†å®ƒçš„<strong>æ¢¯åº¦</strong>å¯¹åº”çš„æ˜¯<strong>æ­£å‘ KL</strong>ã€‚å¦‚æœä½ çš„ç›®æ ‡æ˜¯ä¼˜åŒ–åå‘ KLï¼Œå´ç”¨ $k_3$ ä½œä¸º lossï¼Œå®é™…ä¸Šåœ¨ä¼˜åŒ–æ­£å‘ KLã€‚</p>

<blockquote>
  <p><strong>è§£å†³</strong>ï¼šæ˜ç¡®ä½ çš„ä¼˜åŒ–ç›®æ ‡ã€‚ä¼˜åŒ–åå‘ KL ç”¨ $k_2$ï¼›ä¼˜åŒ–æ­£å‘ KL æ‰ç”¨ $k_3$ã€‚</p>
</blockquote>

<p><strong>é™·é˜± 3ï¼š$r$ é‡å°¾å¯¼è‡´æ–¹å·®çˆ†ç‚¸</strong></p>

<p>å½“ç­–ç•¥ä¸å‚è€ƒåˆ†å¸ƒå·®å¼‚è¿‡å¤§æ—¶ï¼Œ$r = p/q$ å¯èƒ½å‡ºç°æç«¯å€¼ï¼Œå¯¼è‡´ $k_3$ çš„æ–¹å·®çˆ†ç‚¸ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p><strong>ä¸€å¥è¯è®°å¿†</strong>ï¼š</p>

<ul>
  <li><strong>åªè¦æ•°å€¼ï¼ˆKL ä½œä¸º reward æƒ©ç½šï¼‰</strong>ï¼šé€‰ $k_1$ æˆ– $k_3$ï¼ˆå‡å¯¹åå‘ KL æ— åï¼‰</li>
  <li><strong>éœ€è¦æ¢¯åº¦ï¼ˆKL ä½œä¸º lossï¼‰</strong>ï¼š
    <ul>
      <li>ä¼˜åŒ–<strong>åå‘ KL</strong> â†’ ç”¨ $k_2$</li>
      <li>ä¼˜åŒ–<strong>æ­£å‘ KL</strong> â†’ ç”¨ $k_3$</li>
    </ul>
  </li>
</ul>

<p>æŠŠã€Œ<strong>ä»è°é‡‡æ ·</strong>ã€ã€ã€Œ<strong>ä¼°è®¡è°çš„å€¼</strong>ã€ã€ã€Œ<strong>å¯¹è°æ±‚æ¢¯åº¦</strong>ã€è¿™ä¸‰ä¸ªé—®é¢˜æ‹æ¸…æ¥šï¼Œä¸‰ç§ä¼°è®¡å™¨å°±ä¸å†è®©äººæ··æ·†äº†ã€‚</p>

<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>

<ol>
  <li>
    <p>Dibya Ghosh. â€œKL Divergence for Machine Learningâ€. https://dibyaghosh.com/blog/probability/kldivergence</p>
  </li>
  <li>
    <p>John Schulman. â€œApproximating KL Divergenceâ€. https://joschu.net/blog/kl-approx.html</p>
  </li>
  <li>
    <p>Verl Documentation. â€œProximal Policy Optimization (PPO)â€. https://verl.readthedocs.io/en/latest/algo/ppo.html</p>
  </li>
  <li>
    <p>åˆä¸ƒ123334. RLHF/RLVR è®­ç»ƒä¸­çš„ KL è¿‘ä¼¼æ–¹æ³•æµ…æï¼ˆk1 / k2 / k3ï¼‰. https://zhuanlan.zhihu.com/p/1966872846212010437</p>
  </li>
  <li>
    <p>Kezhao Liu, Jason Klein Liu, Mingtao Chen, Yiming Liu. â€œRethinking KL Regularization in RLHF: From Value Estimation to Gradient Optimizationâ€. https://arxiv.org/abs/2510.01555</p>
  </li>
</ol>

<div class="language-bibtex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">@misc</span><span class="p">{</span><span class="nl">WangZhang2025KLEstimators</span><span class="p">,</span>
  <span class="na">author</span>       <span class="p">=</span> <span class="s">{Wang, Xihuai and Zhang, Shao}</span><span class="p">,</span>
  <span class="na">title</span>        <span class="p">=</span> <span class="s">{Understanding {KL} Divergence Estimators in {RL}: From Value Approximation to Gradient Estimation}</span><span class="p">,</span>
  <span class="na">year</span>         <span class="p">=</span> <span class="s">{2025}</span><span class="p">,</span>
  <span class="na">month</span>        <span class="p">=</span> <span class="nv">dec</span><span class="p">,</span>
  <span class="na">day</span>          <span class="p">=</span> <span class="s">{01}</span><span class="p">,</span>
  <span class="na">url</span>          <span class="p">=</span> <span class="s">{https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-en.html}</span>
<span class="p">}</span>
</code></pre></div></div>

  </article></div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        &copy; Copyright 2025 Xihuai Leo Wang. Last updated: December 01, 2025.
      </div>
    </footer>


    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    <!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams',
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2923RQZBXG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-2923RQZBXG');
  </script>
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar,
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
