<!DOCTYPE html><html lang="zh-CN">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡ | Xihuai Wang's Page</title>
    <meta name="author" content="Xihuai Leo Wang" />
    <meta name="description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1, k2, k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶ç»™å‡ºã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€æ—¶çš„é€‰å‹æŒ‡å—ã€‚" />
    <meta name="keywords" content="Reinforcement Learning, Multi-agent System, Language Model" />

    <!-- OpenGraph -->
    <meta property="og:site_name" content="Xihuai Wang's Page" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Xihuai Wang's Page | ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡" />
    <meta property="og:url" content="https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-zh.html" />
    <meta property="og:description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1, k2, k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶ç»™å‡ºã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€æ—¶çš„é€‰å‹æŒ‡å—ã€‚" />
    <meta property="og:locale" content="zh_CN" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡" />
    <meta name="twitter:description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1, k2, k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶ç»™å‡ºã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€æ—¶çš„é€‰å‹æŒ‡å—ã€‚" />
    
    

    <!-- Schema.org -->
    <script type="application/ld+json">
      {
        "author":
        {
          "@type": "Person",
          "name": "Xihuai Leo Wang"
        },
        "url": "https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-zh.html",
        "@type": "WebSite",
        "description": "åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1, k2, k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶ç»™å‡ºã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€æ—¶çš„é€‰å‹æŒ‡å—ã€‚",
        "headline": "ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡",
        "sameAs": ["https://scholar.google.com/citations?user=hy6v3qUAAAAJ", "https://github.com/xihuai18"],
        "name": "Xihuai Leo Wang",
        "@context": "https://schema.org"
      }
    </script>


    <!-- DNS Prefetch & Preconnect for faster external resource loading -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&display=swap">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light" /><!-- Pseudocode -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pseudocode@2.4.1/build/pseudocode.min.css" integrity="sha256-VwMV//xgBPDyRFVSOshhRhzJRDyBmIACniLPpeXNUdc=" crossorigin="anonymous"><!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-zh.html">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

    <!-- Prefetch/Preload for faster navigation -->
    <link rel="prefetch" href="/" as="document">
    <link rel="prefetch" href="/blog/" as="document">
    <link rel="prefetch" href="/publications/" as="document">
    <link rel="prefetch" href="/cv/" as="document">
    
    <!-- Instant.page for instant page loads on hover -->
    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module" defer></script>

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header --><header>

  <!-- Nav Bar -->
  <nav id="navbar"
    class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      <a class="navbar-brand title font-weight-lighter" href="/">Xihuai Wang's Page</a>
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>

      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">

          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">About</a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">Blog</a>
          </li>

          <!-- CV -->
          <!-- 
          <li class="nav-item ">
            <a class="nav-link" href="/assets/pdf/" target="_blank"
              rel="noopener noreferrer">cv</a>
          </li> -->
          <!-- Other pages -->
          <li class="nav-item ">
            <a class="nav-link" href="/publications/">Publications</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="/cv/">CV</a>
          </li>
          <!-- Toggle theme mode -->
          <li class="nav-item toggle-container">
            <button id="light-toggle" class="nav-link" title="Change theme">
              <i class="fas fa-moon"></i>
              <i class="fas fa-sun"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Scrolling Progress Bar -->
  <progress id="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post toc-layout">
  <header class="post-header">
    <h1 class="post-title">ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡</h1>
    <div class="post-meta-container">
      <div class="post-meta-row">
        <span class="post-date">
          <i class="far fa-calendar-alt"></i>
          December 1, 2025
        </span></div>
      <div class="post-tags-row">
        <a href="/blog/?year=2025" data-filter-link data-filter-type="year" data-filter-value="2025">
          ğŸ“… 2025
        </a>
          &nbsp; &middot; &nbsp;
          
            <a href="/blog/?category=reinforcement-learning" data-filter-link data-filter-type="category" data-filter-value="reinforcement-learning">
              ğŸ·ï¸ reinforcement-learning
            </a>
            
          
      </div>
    </div>
  </header>

  <div class="post-links">
  

  <!-- Bilingual Links -->
  

  

  <!-- External Platform Links -->
  

  

  <!-- External Source (from plugin) -->
  

  <!-- Output links -->
  
    <a href="/reinforcement-learning/2025/12/01/kl-estimators-en.html">English Version</a>
  
    <a href="https://zhuanlan.zhihu.com/p/1978993413425763764" target="_blank">çŸ¥ä¹ <img src="/assets/img/icons/zhihu.ico" style="height: 1em; vertical-align: middle;"></a>
  
</div>


  <div class="row">
    
      <div class="col-lg toc-content">
    

      <article class="post-content">
        <p><img src="/assets/img/kl-estimators/kl-estimator.png" alt="Mini-class" style="display:block;margin:0 auto;width:95%;max-width:100%;" /></p>

<blockquote>
  <p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ $k_1, k_2, k_3$ åœ¨ on-policy å’Œ off-policy åœºæ™¯çš„æ€§è´¨å·®å¼‚ï¼Œå¹¶ç»™å‡ºã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€æ—¶çš„é€‰å‹æŒ‡å—ã€‚</p>
</blockquote>

<h2 id="å¼•è¨€kl-æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²">å¼•è¨€ï¼šKL æ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²</h2>

<p>åœ¨ç­–ç•¥ä¼˜åŒ–ï¼ˆå¦‚ PPOã€GRPOï¼‰æˆ–å¯¹é½è®­ç»ƒï¼ˆRLHF/RLAIFï¼‰ä¸­ï¼Œ<strong>KL æƒ©ç½š</strong>æ˜¯çº¦æŸæ–°ç­–ç•¥ä¸åç¦»å‚è€ƒç­–ç•¥çš„æ ¸å¿ƒæ‰‹æ®µï¼Œç”¨äºé˜²æ­¢è®­ç»ƒä¸ç¨³å®šæˆ–ç­–ç•¥å´©æºƒã€‚ç„¶è€Œï¼ŒKL æƒ©ç½šçš„å®ç°æ¶‰åŠå¤šä¸ªå±‚æ¬¡çš„é€‰æ‹©ï¼š<strong>ä½¿ç”¨å“ªä¸ªä¼°è®¡å™¨</strong>ï¼ˆ$k_1$, $k_2$, $k_3$ï¼‰ã€<strong>ä»å“ªä¸ªç­–ç•¥é‡‡æ ·</strong>ï¼ˆon-policy ä¸ off-policyï¼‰ã€ä»¥åŠ<strong>å¦‚ä½•ä½¿ç”¨</strong>ï¼ˆä½œä¸º loss æ¢¯åº¦å›ä¼ è¿˜æ˜¯ä½œä¸º reward æƒ©ç½šï¼‰ã€‚æœ¬æ–‡å°†ç³»ç»Ÿåœ°æ¢³ç†è¿™äº›é€‰æ‹©åŠå…¶ç›¸äº’å…³ç³»ï¼Œå¸®åŠ©è¯»è€…å˜æ¸…ç›¸å…³æ¦‚å¿µã€‚</p>

<h3 id="æ­£å‘-kl-ä¸åå‘-kl-çš„åŒºåˆ«">æ­£å‘ KL ä¸åå‘ KL çš„åŒºåˆ«</h3>

<p>è®¾ $q_\theta$ ä¸ºå½“å‰ actor ç­–ç•¥ï¼Œ$p$ ä¸ºå‚è€ƒç­–ç•¥ï¼Œä¸¤ç§æ–¹å‘çš„ KL æ•£åº¦åˆ†åˆ«ä¸ºï¼š</p>

<p><strong>åå‘ KLï¼ˆReverse KLï¼‰</strong>ï¼š
$$
D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{x \sim q_\theta}\left[\log \frac{q_\theta(x)}{p(x)}\right]
$$</p>

<figure style="text-align:center;">
  <img src="/assets/img/kl-estimators/kl-estimator-reverse.png" style="width:80%;max-width:100%;" />
  <figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://dibyaghosh.com/blog/probability/kldivergence/">Dibya Ghosh's Blog</a></figcaption>
</figure>

<p><strong>æ­£å‘ KLï¼ˆForward KLï¼‰</strong>ï¼š
$$
D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_{x \sim p}\left[\log \frac{p(x)}{q_\theta(x)}\right]
$$</p>

<figure style="text-align:center;">
  <img src="/assets/img/kl-estimators/kl-estimator-forward.png" style="width:80%;max-width:100%;" />
  <figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://dibyaghosh.com/blog/probability/kldivergence/">Dibya Ghosh's Blog</a></figcaption>
</figure>

<p><strong>ç›´è§‚ç†è§£</strong>ï¼š</p>
<ul>
  <li><strong>åå‘ KL</strong> å€¾å‘äºã€Œæ¨¡å¼å¯»æ‰¾ã€ï¼ˆmode-seekingï¼‰â€”â€”ç­–ç•¥ä¼šé›†ä¸­åœ¨å‚è€ƒåˆ†å¸ƒçš„é«˜æ¦‚ç‡åŒºåŸŸï¼Œå¯èƒ½ç‰ºç‰²å¤šæ ·æ€§</li>
  <li><strong>æ­£å‘ KL</strong> å€¾å‘äºã€Œå…¨è¦†ç›–ã€ï¼ˆmass-coveringï¼‰â€”â€”ç­–ç•¥ä¼šå°½é‡è¦†ç›–å‚è€ƒåˆ†å¸ƒçš„æ”¯æ’‘é›†</li>
</ul>

<p>åœ¨ RLHF çš„ä¸»æµå®ç°ä¸­ï¼Œ<strong>åå‘ KL</strong> æ›´ä¸ºå¸¸è§ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ› actor ä¸è¦åç¦» reference policy å¤ªè¿œï¼Œè€Œéè¦æ±‚å®Œå…¨è¦†ç›–æ‰€æœ‰æ¨¡å¼ã€‚</p>

<h3 id="æœ¬æ–‡çš„æ ¸å¿ƒé—®é¢˜ä»è°é‡‡æ ·ä¼°è®¡ä»€ä¹ˆæ€ä¹ˆç”¨">æœ¬æ–‡çš„æ ¸å¿ƒé—®é¢˜ï¼šä»è°é‡‡æ ·ã€ä¼°è®¡ä»€ä¹ˆã€æ€ä¹ˆç”¨</h3>

<p>åœ¨å®é™…å®ç° KL æƒ©ç½šæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å›ç­”ä¸‰ä¸ªç›¸äº’å…³è”çš„é—®é¢˜ï¼š</p>

<ol>
  <li><strong>ä»è°é‡‡æ ·ï¼Ÿ</strong> æ ·æœ¬æ¥è‡ªå½“å‰ç­–ç•¥ $q_\theta$ï¼ˆon-policyï¼‰ï¼Œè¿˜æ˜¯æ¥è‡ªè¡Œä¸ºç­–ç•¥ $\mu$ï¼ˆoff-policyï¼‰ï¼Ÿ</li>
  <li><strong>ä¼°è®¡ä»€ä¹ˆï¼Ÿ</strong> æˆ‘ä»¬æƒ³è¦ä¼°è®¡çš„æ˜¯åå‘ KL $D_{\mathrm{KL}}(q_\theta \| p)$ è¿˜æ˜¯æ­£å‘ KL $D_{\mathrm{KL}}(p \| q_\theta)$ï¼Ÿ</li>
  <li><strong>æ€ä¹ˆç”¨ï¼Ÿ</strong> KL é¡¹æ˜¯ä½œä¸º loss å‚ä¸æ¢¯åº¦å›ä¼ ï¼Œè¿˜æ˜¯ä½œä¸º reward æƒ©ç½šï¼ˆstop-gradientï¼‰ï¼Ÿ</li>
</ol>

<p>è¿™ä¸‰ä¸ªé—®é¢˜çš„ä¸åŒç»„åˆï¼Œå†³å®šäº†åº”è¯¥é€‰ç”¨å“ªä¸ªä¼°è®¡å™¨ã€‚æœ¬æ–‡çš„ç›®æ ‡å°±æ˜¯ç³»ç»Ÿåœ°å˜æ¸…è¿™äº›é€‰æ‹©åŠå…¶ç›¸äº’å…³ç³»ã€‚</p>

<h2 id="å‡†å¤‡å·¥ä½œç¬¦å·ä¸åŸºæœ¬æ¦‚å¿µ">å‡†å¤‡å·¥ä½œï¼šç¬¦å·ä¸åŸºæœ¬æ¦‚å¿µ</h2>

<p>åœ¨æ·±å…¥åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç»Ÿä¸€ç¬¦å·çº¦å®šï¼Œå¹¶æ¨å¯¼ä¸¤ä¸ªåœ¨åæ–‡åå¤ç”¨åˆ°çš„åŸºç¡€ç»“è®ºã€‚</p>

<h3 id="ç¬¦å·çº¦å®š">ç¬¦å·çº¦å®š</h3>

<ul>
  <li>$q_\theta$ï¼šå½“å‰ actor ç­–ç•¥ï¼ˆå‚æ•°ä¸º $\theta$ï¼‰</li>
  <li>$p$ï¼šå‚è€ƒç­–ç•¥ï¼ˆreference policyï¼‰ï¼Œä¸ä¾èµ–äº $\theta$</li>
  <li>$\mu$ï¼šè¡Œä¸ºç­–ç•¥ï¼ˆbehavior policyï¼‰ï¼Œç”¨äº off-policy é‡‡æ ·ï¼Œä¸ä¾èµ–äº $\theta$</li>
  <li>$s_\theta(x) = \nabla_\theta \log q_\theta(x)$ï¼šscore function</li>
  <li>$w(x) = \frac{q_\theta(x)}{\mu(x)}$ï¼šé‡è¦æ€§æƒé‡</li>
  <li>$\text{sg}(\cdot)$ï¼šstop-gradient æ“ä½œï¼ˆåœ¨ä»£ç ä¸­å¯¹åº” <code class="language-plaintext highlighter-rouge">.detach()</code>ï¼‰</li>
</ul>

<h3 id="score-function-ä¸-kl-çœŸæ¢¯åº¦">Score Function ä¸ KL çœŸæ¢¯åº¦</h3>

<p>Score function æœ‰ä¸€ä¸ªé‡è¦æ€§è´¨ï¼š$\mathbb{E}_{q_\theta}[s_\theta] = 0$ï¼ˆå› ä¸º $\int \nabla_\theta q_\theta dx = \nabla_\theta \int q_\theta dx = \nabla_\theta 1 = 0$ï¼‰ã€‚</p>

<p>åˆ©ç”¨è¿™ä¸€æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼æ­£å‘å’Œåå‘ KL æ•£åº¦å¯¹ $\theta$ çš„<strong>çœŸæ¢¯åº¦</strong>ã€‚</p>

<p><strong>åå‘ KL çš„æ¢¯åº¦</strong>ï¼š</p>

<p>$$
D_{\mathrm{KL}}(q_\theta \| p) = \int q_\theta(x) \log \frac{q_\theta(x)}{p(x)} dx
$$</p>

<p>å¯¹ $\theta$ æ±‚æ¢¯åº¦ï¼ˆä½¿ç”¨ä¹˜ç§¯æ³•åˆ™ï¼‰ï¼š</p>

<p>$$
\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \int \nabla_\theta q_\theta \cdot \log \frac{q_\theta}{p} dx + \int q_\theta \cdot \nabla_\theta \log \frac{q_\theta}{p} dx
$$</p>

<p>åˆ©ç”¨ $\nabla_\theta q_\theta = q_\theta \cdot s_\theta$ ä»¥åŠ $\nabla_\theta \log q_\theta = s_\theta$ã€$\nabla_\theta \log p = 0$ï¼š</p>

<p>$$
= \mathbb{E}_q\left[s_\theta \cdot \log \frac{q_\theta}{p}\right] + \mathbb{E}_q[s_\theta] = \mathbb{E}_q\left[s_\theta \cdot \log \frac{q_\theta}{p}\right]
$$</p>

<p>å³ï¼š</p>

<p>$$
\boxed{\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_q\left[s_\theta \cdot \log \frac{q_\theta}{p}\right] = -\mathbb{E}_q\left[s_\theta \cdot \log \frac{p}{q}\right]}
$$</p>

<p><strong>æ­£å‘ KL çš„æ¢¯åº¦</strong>ï¼š</p>

<p>$$
D_{\mathrm{KL}}(p \| q_\theta) = \int p(x) \log \frac{p(x)}{q_\theta(x)} dx
$$</p>

<p>ç”±äº $p(x)$ ä¸ä¾èµ–äº $\theta$ï¼š</p>

<p>$$
\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = \int p(x) \cdot \nabla_\theta \left(-\log q_\theta(x)\right) dx = -\mathbb{E}_p[s_\theta]
$$</p>

<p>ä¸ºäº†ç”¨ $q$ çš„æ ·æœ¬ä¼°è®¡è¿™ä¸ªé‡ï¼Œè¿›è¡Œé‡è¦æ€§é‡‡æ ·ï¼š</p>

<p>$$
-\mathbb{E}_p[s_\theta] = -\mathbb{E}_q\left[\frac{p}{q_\theta} \cdot s_\theta\right] = -\mathbb{E}_q\left[\frac{p}{q} \cdot s_\theta\right]
$$</p>

<p>åˆ©ç”¨ $\mathbb{E}_q[s_\theta] = 0$ï¼Œå¯æ”¹å†™ä¸ºï¼š</p>

<p>$$
\boxed{\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_q\left[\left(1-\frac{p}{q}\right) \cdot s_\theta\right]}
$$</p>

<p>æœ‰äº†è¿™ä¸¤ä¸ªç»“æœï¼Œæˆ‘ä»¬å°±èƒ½åœ¨åæ–‡åˆ¤æ–­å„ä¼°è®¡å™¨çš„æ¢¯åº¦æœŸæœ›ç©¶ç«Ÿå¯¹åº”å“ªä¸ª KL çš„çœŸæ¢¯åº¦ã€‚</p>

<h2 id="ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†">ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†</h2>

<p>è®°æ¯”å€¼ $\frac{p(x)}{q_\theta(x)}$ï¼ŒJohn Schulman æå‡ºçš„ä¸‰ç§å•æ ·æœ¬ä¼°è®¡å™¨å®šä¹‰å¦‚ä¸‹ï¼š</p>

<h3 id="inlmath106mathendæœ€æœ´ç´ çš„-log-ratio-ä¼°è®¡å™¨">$k_1$ï¼šæœ€æœ´ç´ çš„ log-ratio ä¼°è®¡å™¨</h3>

<p>$$
k_1(x) = -\log \frac{p(x)}{q_\theta(x)} = \log q_\theta(x) - \log p(x)
$$</p>

<p>è¿™æ˜¯æœ€ç›´æ¥çš„å®šä¹‰â€”â€”ç›´æ¥å– log-ratio çš„è´Ÿå€¼ã€‚å®ƒå¯¹åå‘ KL æ— åï¼Œä½†æœ‰ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼š<strong>å¯èƒ½å–è´Ÿå€¼</strong>ï¼Œè€Œ KL æ•£åº¦å§‹ç»ˆéè´Ÿã€‚è¿™å¯¼è‡´å…¶æ–¹å·®æé«˜ï¼Œå› ä¸ºæ­£è´Ÿä¼°è®¡å€¼ä¼šç›¸äº’æŠµæ¶ˆã€‚</p>

<h3 id="inlmath107mathendåŸºäº-f-æ•£åº¦çš„å¹³æ–¹ä¼°è®¡å™¨">$k_2$ï¼šåŸºäº f-æ•£åº¦çš„å¹³æ–¹ä¼°è®¡å™¨</h3>

<p>$$
k_2(x) = \frac{1}{2}\left(\log \frac{p(x)}{q_\theta(x)}\right)^2
$$</p>

<p><strong>è®¾è®¡åŠ¨æœº</strong>ï¼š$k_1$ çš„é—®é¢˜åœ¨äºå¯æ­£å¯è´Ÿï¼Œè€Œ $k_2$ é€šè¿‡å–å¹³æ–¹ä¿è¯<strong>æ¯ä¸ªæ ·æœ¬éƒ½æ˜¯æ­£çš„</strong>ï¼Œç›´è§‚ä¸Šæ¯ä¸ªæ ·æœ¬éƒ½åœ¨è¡¡é‡ $p$ å’Œ $q$ çš„å·®å¼‚ç¨‹åº¦ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆåå·®å¾ˆå°ï¼Ÿ</strong> $k_2$ æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <strong>f-æ•£åº¦</strong>ï¼ˆf-divergenceï¼‰ï¼Œå…¶ä¸­ $f(x) = \frac{1}{2}(\log x)^2$ã€‚f-æ•£åº¦æœ‰ä¸€ä¸ªé‡è¦æ€§è´¨ï¼š<strong>æ‰€æœ‰å¯å¾®çš„ f-æ•£åº¦åœ¨ $q \approx p$ æ—¶ï¼ŒäºŒé˜¶å±•å¼€éƒ½å½¢å¦‚</strong></p>

<p>$$
D_f(p, q_\theta) = \frac{f^{\prime\prime}(1)}{2} \theta^T F \theta + O(\theta^3)
$$</p>

<p>å…¶ä¸­ $F$ æ˜¯ Fisher ä¿¡æ¯çŸ©é˜µã€‚KL æ•£åº¦å¯¹åº” $f(x) = -\log x$ï¼Œæœ‰ $f^{\prime\prime}(1) = 1$ï¼›è€Œ $k_2$ å¯¹åº”çš„ $f(x) = \frac{1}{2}(\log x)^2$ï¼ŒåŒæ ·æœ‰ $f^{\prime\prime}(1) = 1$ã€‚è¿™æ„å‘³ç€<strong>å½“ç­–ç•¥æ¥è¿‘æ—¶ï¼Œ$k_2$ ä¸çœŸå® KL çš„è¡Œä¸ºå‡ ä¹ç›¸åŒ</strong>ï¼Œåå·®ä»…ä½“ç°åœ¨é«˜é˜¶é¡¹ã€‚</p>

<h3 id="inlmath122mathendæ§åˆ¶å˜é‡æ³•æ„é€ çš„-bregman-æ•£åº¦ä¼°è®¡å™¨">$k_3$ï¼šæ§åˆ¶å˜é‡æ³•æ„é€ çš„ Bregman æ•£åº¦ä¼°è®¡å™¨</h3>

<p>$$
k_3(x) = \frac{p(x)}{q_\theta(x)} - 1 - \log \frac{p(x)}{q_\theta(x)}
$$</p>

<p><strong>è®¾è®¡åŠ¨æœº</strong>ï¼šæˆ‘ä»¬æƒ³è¦ä¸€ä¸ª<strong>æ—¢æ— ååˆä½æ–¹å·®</strong>çš„ä¼°è®¡å™¨ã€‚æ ‡å‡†åšæ³•æ˜¯ç»™ $k_1$ åŠ ä¸€ä¸ª<strong>æ§åˆ¶å˜é‡</strong>ï¼ˆcontrol variateï¼‰â€”â€”ä¸€ä¸ªæœŸæœ›ä¸ºé›¶ä½†ä¸ $k_1$ è´Ÿç›¸å…³çš„é‡ã€‚</p>

<p>æ³¨æ„åˆ° $\mathbb{E}_q\left[\frac{p}{q} - 1\right] = \mathbb{E}_q\left[\frac{p}{q}\right] - 1 = 1 - 1 = 0$ï¼Œæ‰€ä»¥å¯¹äºä»»æ„ $\lambda$ï¼Œ</p>

<p>$$
k_1 + \lambda\left(\frac{p}{q} - 1\right) = -\log \frac{p}{q} + \lambda\left(\frac{p}{q} - 1\right)
$$</p>

<p>ä»ç„¶æ˜¯æ— åä¼°è®¡ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆé€‰ $\lambda = 1$ï¼Ÿ</strong> ç”±äº $\log$ æ˜¯å‡¹å‡½æ•°ï¼Œæœ‰ $\log x \leq x - 1$ï¼Œå› æ­¤</p>

<p>$$
k_3 = \left(\frac{p}{q} - 1\right) - \log \frac{p}{q} \geq 0
$$</p>

<p><strong>å§‹ç»ˆéè´Ÿ</strong>ï¼è¿™ä¿è¯äº†æ¯ä¸ªæ ·æœ¬éƒ½åœ¨ã€Œæ­£å‘ã€è´¡çŒ®ä¿¡æ¯ï¼Œæ¶ˆé™¤äº† $k_1$ æ­£è´ŸæŠµæ¶ˆçš„é—®é¢˜ã€‚</p>

<p><strong>å‡ ä½•ç›´è§‚</strong>ï¼š$k_3$ å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>Bregman æ•£åº¦</strong>ã€‚è€ƒè™‘å‡¸å‡½æ•° $\phi(x) = -\log x$ï¼Œå®ƒåœ¨ $x=1$ å¤„çš„åˆ‡çº¿ä¸º $y = 1 - x$ã€‚Bregman æ•£åº¦å®šä¹‰ä¸ºã€Œå‡½æ•°å€¼ä¸åˆ‡çº¿å€¼ä¹‹å·®ã€ï¼š</p>

<p>$$
\begin{aligned}
D_\phi\left(\frac{p}{q}, 1\right) &= \phi\left(\frac{p}{q}\right) - \phi(1) - \phi'(1)\left(\frac{p}{q} - 1\right) \\
&= -\log \frac{p}{q} - 0 - (-1)\left(\frac{p}{q} - 1\right) \\
&= \frac{p}{q} - 1 - \log \frac{p}{q} \\
&= k_3.
\end{aligned}
$$</p>

<p>ç”±äºå‡¸å‡½æ•°å§‹ç»ˆä½äºå…¶åˆ‡çº¿ä¸Šæ–¹ï¼Œè¿™ä¸ªå·®å€¼<strong>è‡ªç„¶éè´Ÿ</strong>ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨ $\frac{p}{q} \to 1$ æ—¶ï¼Œå‡½æ•°ä¸åˆ‡çº¿ã€Œè´´åˆã€å¾—è¶Šæ¥è¶Šç´§å¯†ï¼Œå·®å€¼ä»¥ $\left(\frac{p}{q} - 1\right)^2$ çš„äºŒé˜¶é€Ÿåº¦è¶‹è¿‘äºé›¶â€”â€”è¿™æ­£æ˜¯ $k_3$ åœ¨ç­–ç•¥æ¥è¿‘æ—¶æ–¹å·®å°çš„æ ¹æœ¬åŸå› ã€‚</p>

<h3 id="å°ç»“ä¸‰è€…çš„è®¾è®¡é€»è¾‘å¯¹æ¯”">å°ç»“ï¼šä¸‰è€…çš„è®¾è®¡é€»è¾‘å¯¹æ¯”</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">å®šä¹‰</th>
      <th style="text-align: center">è®¾è®¡åŸç†</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">$-\log \frac{p}{q}$</td>
      <td style="text-align: center">æœ€æœ´ç´ å®šä¹‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">$\frac{1}{2}\left(\log \frac{p}{q}\right)^2$</td>
      <td style="text-align: center">f-æ•£åº¦ï¼ŒäºŒé˜¶è¡Œä¸ºä¸ KL ä¸€è‡´</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">$\frac{p}{q} - 1 - \log \frac{p}{q}$</td>
      <td style="text-align: center">æ§åˆ¶å˜é‡ + Bregman æ•£åº¦</td>
    </tr>
  </tbody>
</table>

<p>äº†è§£äº†ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†åï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æå®ƒä»¬åœ¨<strong>ä¼°è®¡ KL æ•°å€¼</strong>æ—¶çš„æ€§è´¨â€”â€”å³åå·®ä¸æ–¹å·®ã€‚</p>

<h2 id="æ•°å€¼ä¼°è®¡åå·®ä¸æ–¹å·®">æ•°å€¼ä¼°è®¡ï¼šåå·®ä¸æ–¹å·®</h2>

<p>æœ¬èŠ‚åˆ†æä¸‰ç§ä¼°è®¡å™¨åœ¨<strong>ä¼°è®¡ KL æ•°å€¼</strong>æ—¶çš„æ€§è´¨ã€‚è¿™äº›æ€§è´¨åœ¨ä»»ä½•ä½¿ç”¨åœºæ™¯ä¸‹éƒ½æ˜¯åŸºç¡€ã€‚</p>

<p>å‡è®¾ä» $q_\theta$ é‡‡æ ·æ¥ä¼°è®¡åå‘ KL $D_{\mathrm{KL}}(q_\theta \| p)$ï¼š</p>

<h3 id="æ— åæ€§åˆ†æ">æ— åæ€§åˆ†æ</h3>

<p>$$
\begin{aligned}
\mathbb{E}_{q}[k_1] &= \mathbb{E}_{q}\left[\log \frac{q}{p}\right] = D_{\mathrm{KL}}(q \| p) && \textbf{ï¼ˆæ— åï¼‰} \\[8pt]
\mathbb{E}_{q}[k_3] &= \mathbb{E}_{q}\left[\frac{p}{q} - 1 - \log \frac{p}{q}\right] && \\
&= 1 - 1 + D_{\mathrm{KL}}(q \| p) && \\
&= D_{\mathrm{KL}}(q \| p) && \textbf{ï¼ˆæ— åï¼‰} \\[8pt]
\mathbb{E}_{q}[k_2] &= \frac{1}{2}\mathbb{E}_{q}\left[\left(\log \frac{p}{q}\right)^2\right] \neq D_{\mathrm{KL}}(q \| p) && \textbf{ï¼ˆæœ‰åï¼‰}
\end{aligned}
$$</p>

<p><strong>ç»“è®º</strong>ï¼šå¯¹äºä¼°è®¡åå‘ KL çš„<strong>æ•°å€¼</strong>ï¼Œ$k_1$ å’Œ $k_3$ æ˜¯æ— åä¼°è®¡ï¼Œè€Œ $k_2$ æ˜¯æœ‰åçš„ã€‚</p>

<h3 id="æ–¹å·®ç‰¹æ€§åˆ†æ">æ–¹å·®ç‰¹æ€§åˆ†æ</h3>

<p>John Schulman çš„å®éªŒï¼ˆ$q = \mathcal{N}(0,1)$ï¼Œ$p = \mathcal{N}(0.1,1)$ï¼ŒçœŸå® KL = 0.005ï¼‰è¡¨æ˜ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">bias/true</th>
      <th style="text-align: center">stdev/true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">20</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">0.002</td>
      <td style="text-align: center">1.42</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1.42</td>
    </tr>
  </tbody>
</table>

<p>å½“ KL è¾ƒå¤§æ—¶ï¼ˆ$p = \mathcal{N}(1,1)$ï¼ŒçœŸå® KL = 0.5ï¼‰ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">bias/true</th>
      <th style="text-align: center">stdev/true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">2</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">0.25</td>
      <td style="text-align: center">1.73</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1.7</td>
    </tr>
  </tbody>
</table>

<p><strong>æ ¸å¿ƒç›´è§‚ç†è§£</strong>ï¼š</p>
<ul>
  <li>$k_1 = -\log \frac{p}{q}$ ä»¥ä¸€é˜¶é¡¹èµ·æ­¥ï¼Œå½“ $\frac{p}{q}$ æ¥è¿‘ 1 æ—¶æ³¢åŠ¨è¾ƒå¤§ï¼Œä¸”å¯èƒ½å–è´Ÿå€¼</li>
  <li>$k_3 = \frac{p}{q} - 1 - \log \frac{p}{q}$ åœ¨ $\frac{p}{q}=1$ å¤„æ˜¯äºŒé˜¶å°é‡ï¼Œå§‹ç»ˆéè´Ÿï¼Œå› æ­¤åœ¨ç­–ç•¥æ¥è¿‘æ—¶æ–¹å·®æ›´å°</li>
  <li>ä½†å½“è¦†ç›–ä¸¥é‡ä¸è¶³ï¼ˆ$\frac{p}{q}$ å¯èƒ½çˆ†ç‚¸ï¼‰æ—¶ï¼Œ$k_3$ çš„æ–¹å·®ä¼šå› æƒé‡çˆ†ç‚¸è€Œå¢å¤§ï¼›æ­¤æ—¶ $k_1$ åè€Œæ›´ç¨³å®š</li>
</ul>

<h3 id="æ•°å€¼ä¼°è®¡å°ç»“">æ•°å€¼ä¼°è®¡å°ç»“</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">å¯¹æ•°å€¼çš„åå·®</th>
      <th style="text-align: center">æ–¹å·®ç‰¹æ€§</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">æ— å</td>
      <td style="text-align: center">é«˜ï¼ˆå¯æ­£å¯è´Ÿï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">æœ‰åï¼ˆä½†æå°ï¼‰</td>
      <td style="text-align: center">ä½ï¼ˆæ’æ­£ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">æ— å</td>
      <td style="text-align: center">ä½ï¼ˆæ’æ­£ï¼‰</td>
    </tr>
  </tbody>
</table>

<p>ä»æ•°å€¼ä¼°è®¡çš„è§’åº¦çœ‹ï¼Œ$k_3$ æ˜¯ã€Œæ— å + ä½æ–¹å·®ã€çš„æœ€ä¼˜é€‰æ‹©ã€‚</p>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šè‹¥è¦ä¼°è®¡<strong>æ­£å‘ KL çš„æ•°å€¼</strong> $D_{\mathrm{KL}}(p \| q) = \mathbb{E}_p\left[\log \frac{p}{q}\right]$ï¼Œè€Œåªèƒ½ä» $q$ é‡‡æ ·ï¼Œå¯ç”¨é‡è¦æ€§é‡‡æ · $\mathbb{E}_q\left[\frac{p}{q} \log \frac{p}{q}\right]$ã€‚</p>
</blockquote>

<h2 id="kl-æƒ©ç½šçš„ä¸¤ç§ä½¿ç”¨æ–¹å¼">KL æƒ©ç½šçš„ä¸¤ç§ä½¿ç”¨æ–¹å¼</h2>

<p>äº†è§£äº†ä¼°è®¡å™¨çš„æ•°å€¼æ€§è´¨åï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥æ˜ç¡®ï¼š<strong>KL æƒ©ç½šåœ¨å¼ºåŒ–å­¦ä¹ ä¸­åˆ°åº•æ€ä¹ˆç”¨ï¼Ÿ</strong> è¿™ä¸€é€‰æ‹©å†³å®šäº†æˆ‘ä»¬æ˜¯åªå…³å¿ƒä¼°è®¡å™¨çš„æ•°å€¼æ€§è´¨ï¼Œè¿˜æ˜¯å¿…é¡»åŒæ—¶å…³å¿ƒå…¶æ¢¯åº¦æ€§è´¨ã€‚</p>

<p>å›é¡¾ KL æ­£åˆ™åŒ–å¼ºåŒ–å­¦ä¹ çš„ç›®æ ‡å‡½æ•°ï¼š</p>

<p>$$
J(\theta) = \mathbb{E}_{\tau \sim \pi_\theta} \left[ \sum_{t=0}^T \gamma^t r(s_t, a_t) \right] - \beta \cdot D_{\mathrm{KL}}(\pi_\theta \| \pi_{\text{ref}})
$$</p>

<p>è¿™ä¸ªæ•°å­¦å½¢å¼çœ‹èµ·æ¥å¾ˆç»Ÿä¸€ï¼Œä½†åœ¨åŸºäº Actor-Critic çš„ç®—æ³•ï¼ˆå¦‚ PPOï¼‰ä¸­å®ç°æ—¶ï¼Œå´è¡ç”Ÿå‡ºäº†ä¸¤ç§æˆªç„¶ä¸åŒçš„å®ç°èŒƒå¼â€”â€”å®ƒä»¬åœ¨ä»£ç å±‚é¢å¯èƒ½åªå·®å‡ è¡Œï¼Œå´å¯¹åº”ç€å®Œå…¨ä¸åŒçš„ä¼˜åŒ–è¯­ä¹‰ã€‚</p>

<blockquote>
  <p><strong>ç¬¦å·è¯´æ˜</strong>ï¼šæœ¬èŠ‚ç”¨ $\text{KL}_t$ æˆ– $\text{KL}(s)$ æ³›æŒ‡æŸä¸ª token/state çº§çš„ KL ä¼°è®¡å™¨ï¼ˆå¦‚ $k_1, k_2, k_3$ï¼‰ï¼Œå…·ä½“å®šä¹‰è§å‰æ–‡ã€Œä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†ã€ä¸€èŠ‚ã€‚</p>
</blockquote>

<h3 id="ä½œä¸º-losskl-å‚ä¸æ¢¯åº¦åä¼ ">ä½œä¸º Lossï¼šKL å‚ä¸æ¢¯åº¦åä¼ </h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">actor_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">advantage</span> <span class="o">*</span> <span class="n">log_prob</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">kl</span>  <span class="c1"># kl å‚ä¸æ¢¯åº¦è®¡ç®—
</span></code></pre></div></div>

<p>Critic åªå­¦ç¯å¢ƒä»·å€¼ï¼ŒKL ä½œä¸º actor çš„æ­£åˆ™é¡¹ç›´æ¥å‚ä¸ loss æ¢¯åº¦å›ä¼ ã€‚</p>

<h3 id="ä½œä¸º-rewardkl-åŠ å…¥å¥–åŠ±å¡‘å½¢">ä½œä¸º Rewardï¼šKL åŠ å…¥å¥–åŠ±å¡‘å½¢</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kl</span> <span class="o">=</span> <span class="nf">compute_kl</span><span class="p">(</span><span class="n">log_prob_q</span><span class="p">,</span> <span class="n">log_prob_p</span><span class="p">).</span><span class="nf">detach</span><span class="p">()</span>
<span class="n">shaped_reward</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">kl</span>
</code></pre></div></div>

<p>KL è¢«è§†ä¸ºç¯å¢ƒå¥–åŠ±çš„ä¸€éƒ¨åˆ†ï¼Œç”¨ shaped reward åšæ ‡å‡† actor-critic æ›´æ–°ã€‚KL é¡¹ä¸å‚ä¸ loss æ¢¯åº¦å›ä¼ ã€‚</p>

<p>è¿™ä¸¤ç§åšæ³•çœ‹ä¼¼åªæ˜¯ä»£ç é‡Œä¸€ä¸ª <code class="language-plaintext highlighter-rouge">.detach()</code> çš„åŒºåˆ«ï¼Œå®é™…ä¸Šå¯¹åº”ç€æˆªç„¶ä¸åŒçš„ä¼˜åŒ–è¯­ä¹‰ã€‚</p>

<h3 id="ä¸¤ç§æ–¹å¼çš„æ ¸å¿ƒå·®å¼‚">ä¸¤ç§æ–¹å¼çš„æ ¸å¿ƒå·®å¼‚</h3>

<h4 id="ä¼˜åŒ–ç›®æ ‡çš„ä¸åŒ">ä¼˜åŒ–ç›®æ ‡çš„ä¸åŒ</h4>

<p><strong>KL ä½œä¸º Loss</strong>ï¼šä¼˜åŒ–<strong>åŸä»»åŠ¡ + ç›‘ç£æ­£åˆ™</strong>ï¼ŒKL ä¸æ”¹å˜ MDP å®šä¹‰ï¼Œåªæ˜¯å¤–æŒ‚çš„çº¦æŸé¡¹ã€‚</p>

<p><strong>KL ä½œä¸º Reward</strong>ï¼šä¼˜åŒ–ä¸€ä¸ª<strong>æ­£åˆ™åŒ–åçš„æ–° MDP</strong>ï¼Œå¥–åŠ±å‡½æ•°å˜ä¸º $\tilde{r}(s,a) = r(s,a) - \beta \cdot \text{KL}(s)$ã€‚</p>

<p><strong>ç›´è§‰</strong>ï¼šå‰è€…æ˜¯ã€Œåœ¨åŸè§„åˆ™ä¸‹åŠ çº¦æŸã€ï¼Œåè€…æ˜¯ã€Œæ”¹å˜æ¸¸æˆè§„åˆ™ã€ã€‚</p>

<h4 id="æ¢¯åº¦è·¯å¾„çš„ä¸åŒ">æ¢¯åº¦è·¯å¾„çš„ä¸åŒ</h4>

<p><strong>KL ä½œä¸º Loss</strong>ï¼šæ¢¯åº¦åˆ†æˆä¸¤æ¡ç‹¬ç«‹è·¯å¾„ï¼š</p>

<p>$$
g_{\text{loss}} = \underbrace{\mathbb{E}\left[\nabla_\theta \log \pi_\theta \cdot A_t^{\text{env}}\right]}_{\text{RL æ¢¯åº¦}} + \underbrace{\beta \cdot \nabla_\theta \text{KL}}_{\text{KL æ˜¾å¼æ¢¯åº¦}}
$$</p>

<p><strong>KL ä½œä¸º Reward</strong>ï¼šå•ä¸€ policy gradientï¼ŒKL çš„å½±å“<strong>é€šè¿‡ advantage é—´æ¥ä½“ç°</strong>ï¼š</p>

<p>$$
g_{\text{reward}} = \mathbb{E}\left[\nabla_\theta \log \pi_\theta \cdot \tilde{A}_t\right], \quad \tilde{A}_t \text{ åŸºäº } (r_t - \beta \cdot \text{KL}_t)
$$</p>

<p><strong>å…³é”®åŒºåˆ«</strong>ï¼šKL çš„åŠ›é‡æ˜¯ã€Œå•ç‹¬ä¸€è‚¡åŠ›ã€è¿˜æ˜¯ã€Œä¹˜åœ¨ advantage ä¸Šã€ã€‚å‰è€…çš„ KL æ¢¯åº¦æ˜¯ç¡®å®šæ€§çš„ï¼Œä¸å— critic è´¨é‡å½±å“ã€‚</p>

<h4 id="ä»·å€¼å‡½æ•°ä¸ä¿¡åº¦åˆ†é…çš„ä¸åŒ">ä»·å€¼å‡½æ•°ä¸ä¿¡åº¦åˆ†é…çš„ä¸åŒ</h4>

<p><strong>ä»·å€¼å‡½æ•°</strong>ï¼š</p>

<p><strong>KL ä½œä¸º Loss</strong>ï¼šCritic åªå­¦ç¯å¢ƒä»·å€¼</p>

<p>$$
V^{\text{env}}(s) = \mathbb{E}\left[\sum_t \gamma^t r_t\right]
$$</p>

<p>åˆ†å·¥æ›´æ¸…æ™°ï¼Œä¾¿äºåˆ†åˆ«ç›‘æ§ä»»åŠ¡å›æŠ¥å’Œ KL æ•£åº¦ã€‚</p>

<p><strong>KL ä½œä¸º Reward</strong>ï¼šCritic å­¦æ··åˆä»·å€¼</p>

<p>$$
V^{\text{reg}}(s) = \mathbb{E}\left[\sum_t \gamma^t (r_t - \beta \cdot \text{KL}_t)\right]
$$</p>

<p><strong>ä¿¡åº¦åˆ†é…</strong>ï¼š</p>

<p>è€ƒè™‘åœºæ™¯ï¼šå‰å‡ æ­¥æ˜¯è·¯ç”±è¡Œä¸ºï¼Œæœ€åä¸€æ­¥ reward é«˜ä½† KL ä¹Ÿå¤§ã€‚</p>

<p><strong>KL ä½œä¸º Loss</strong>ï¼šæœ«çŠ¶æ€çš„ KL åªåœ¨è¯¥çŠ¶æ€çš„æ¢¯åº¦é¡¹é‡Œä½“ç°ï¼Œç­–ç•¥ä»æ„¿æ„<strong>è®¿é—®é«˜å›æŠ¥åŒºåŸŸï¼Œä½†å±€éƒ¨ä¿®æ­£</strong>è¡Œä¸ºã€‚</p>

<p><strong>KL ä½œä¸º Reward</strong>ï¼šæœ«çŠ¶æ€çš„å¤§ KL é€šè¿‡ TD <strong>å›ä¼ åˆ°å‰é¢æ‰€æœ‰æ­¥éª¤</strong>ï¼Œç­–ç•¥å€¾å‘äº<strong>ä»æ ¹æœ¬ä¸Šé¿å¼€</strong>é«˜ KL åŒºåŸŸâ€”â€”è¿™æ˜¯ã€Œè§„åˆ’æ€§çš„ KL é¢„ç®—åˆ†é…ã€ã€‚</p>

<h3 id="ä¸ºä»€ä¹ˆè¿™ä¸ªåŒºåˆ†è‡³å…³é‡è¦">ä¸ºä»€ä¹ˆè¿™ä¸ªåŒºåˆ†è‡³å…³é‡è¦</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç»´åº¦</th>
      <th style="text-align: center">KL ä½œä¸º Lossï¼ˆloss æ¢¯åº¦å›ä¼ ï¼‰</th>
      <th style="text-align: center">KL ä½œä¸º Rewardï¼ˆstop-gradï¼‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">æ›´æ–°ç›®æ ‡</td>
      <td style="text-align: center">åŸä»»åŠ¡ + ç›‘ç£æ­£åˆ™</td>
      <td style="text-align: center">æ­£åˆ™åŒ–åçš„æ–° MDP</td>
    </tr>
    <tr>
      <td style="text-align: center">Actor æ¢¯åº¦</td>
      <td style="text-align: center">RL æ¢¯åº¦ + æ˜¾å¼ KL æ¢¯åº¦</td>
      <td style="text-align: center">å•ä¸€ PGï¼ŒåŸºäº shaped advantage</td>
    </tr>
    <tr>
      <td style="text-align: center">Critic</td>
      <td style="text-align: center">å­¦ $V^{\text{env}}$ï¼šåªçœ‹ç¯å¢ƒ reward</td>
      <td style="text-align: center">å­¦ $V^{\text{reg}}$ï¼šreward + KL æ··åˆ</td>
    </tr>
    <tr>
      <td style="text-align: center">Credit Assignment</td>
      <td style="text-align: center">å±€éƒ¨ per-stateï¼Œæ— è§„åˆ’æ€§</td>
      <td style="text-align: center">å¤šæ­¥å›ä¼ ï¼Œæœ‰è§„åˆ’æ€§</td>
    </tr>
    <tr>
      <td style="text-align: center">å…³å¿ƒä»€ä¹ˆ</td>
      <td style="text-align: center">KL ä¼°è®¡å™¨çš„<strong>æ˜¾å¼æ¢¯åº¦</strong>ï¼ˆå¯¹åº”å“ªä¸ªä¼˜åŒ–ç›®æ ‡ï¼‰</td>
      <td style="text-align: center">KL çš„<strong>æ•°å€¼</strong> + è¯±å¯¼çš„<strong>ç­–ç•¥æ¢¯åº¦</strong>æ˜¯å¦æ­£ç¡®</td>
    </tr>
  </tbody>
</table>

<p><strong>ä¸€å¥è¯æ€»ç»“</strong>ï¼šKL ä½œä¸º loss è®© agentã€Œè®¿é—®ä½†å±€éƒ¨ä¿®æ­£ã€ï¼Œçº¦æŸæ›´å±€éƒ¨ã€æ›´çµæ´»ï¼›KL ä½œä¸º reward è®© agentã€Œè§„åˆ’æ€§åœ°é¿å¼€é«˜ KL è·¯å¾„ã€ï¼Œçº¦æŸæ›´å…¨å±€ã€æ›´å½»åº•ã€‚</p>

<p><strong>é€‰å‹å»ºè®®</strong>ï¼š</p>
<ul>
  <li>å¦‚æœä½ å¸Œæœ›çº¦æŸæ˜¯ã€Œ<strong>ä¿®æ­£æ€§</strong>ã€çš„ï¼Œå…è®¸ agent æ¢ç´¢ä½†åœ¨å±€éƒ¨ä¿®æ­£è¡Œä¸ºï¼Œé€‰æ‹©<strong>KL ä½œä¸º Loss</strong></li>
  <li>å¦‚æœä½ å¸Œæœ›çº¦æŸæ˜¯ã€Œ<strong>é¢„é˜²æ€§</strong>ã€çš„ï¼Œè®© agent ä»æ ¹æºä¸Šé¿å¼€é«˜ KL åŒºåŸŸï¼Œé€‰æ‹©<strong>KL ä½œä¸º Reward</strong></li>
</ul>

<p>ç†è§£äº†è¿™ä¸¤ç§èŒƒå¼çš„åŒºåˆ«åï¼Œæˆ‘ä»¬å°±èƒ½æ˜ç¡®ï¼š</p>
<ul>
  <li><strong>KL ä½œä¸º Loss</strong>ï¼šéœ€è¦ KL ä¼°è®¡å™¨çš„æ­£ç¡®æ˜¾å¼æ¢¯åº¦ï¼Œå…³å¿ƒæ¢¯åº¦å¯¹åº”å“ªä¸ªä¼˜åŒ–ç›®æ ‡</li>
  <li><strong>KL ä½œä¸º Reward</strong>ï¼šéœ€è¦ KL çš„å‡†ç¡®æ•°å€¼ä¼°è®¡ï¼ŒåŒæ—¶è¿˜è¦å…³å¿ƒå®ƒè¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ˜¯å¦æ­£ç¡®</li>
</ul>

<p>ä¸‹é¢æˆ‘ä»¬æŒ‰ç…§ã€Œä½œä¸º Lossã€å’Œã€Œä½œä¸º Rewardã€ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œæ·±å…¥å‰–æä¼°è®¡å™¨çš„æ¢¯åº¦æ€§è´¨ã€‚</p>

<h2 id="ä½œä¸º-loss-æ—¶çš„æ¢¯åº¦åˆ†æ">ä½œä¸º Loss æ—¶çš„æ¢¯åº¦åˆ†æ</h2>

<p>å½“ KL ä½œä¸º loss å‚ä¸æ¢¯åº¦å›ä¼ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å…³å¿ƒä¼°è®¡å™¨å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡ã€‚è¿™æ˜¯å®è·µä¸­æœ€å®¹æ˜“æ··æ·†ä¹Ÿæœ€å…³é”®çš„éƒ¨åˆ†ã€‚</p>

<h3 id="on-policy-åœºæ™¯">On-policy åœºæ™¯</h3>

<p>æˆ‘ä»¬ä» on-policy åœºæ™¯å¼€å§‹åˆ†æï¼Œå³æ ·æœ¬æ¥è‡ªå½“å‰ç­–ç•¥ $q_\theta$ã€‚</p>

<h4 id="ä¸¤ç§æ±‚å¯¼é¡ºåºå…ˆæ¢¯åº¦åæœŸæœ›-vs-å…ˆæœŸæœ›åæ¢¯åº¦">ä¸¤ç§æ±‚å¯¼é¡ºåºï¼šå…ˆæ¢¯åº¦åæœŸæœ› vs å…ˆæœŸæœ›åæ¢¯åº¦</h4>

<p>åœ¨ä»£ç å®ç°ä¸­ï¼Œå­˜åœ¨ä¸¤æ¡è·¯å¾„ï¼š</p>

<ol>
  <li><strong>å…ˆæ¢¯åº¦ã€åæœŸæœ›</strong>ï¼šå¯¹æ¯ä¸ªæ ·æœ¬çš„ $k_i(x)$ æ±‚æ¢¯åº¦ï¼Œå†å¯¹æ¢¯åº¦æ±‚æœŸæœ›ï¼ˆMonte Carlo ä¼°è®¡ï¼‰</li>
  <li><strong>å…ˆæœŸæœ›ã€åæ¢¯åº¦</strong>ï¼šæŠŠ $\mathbb{E}_q[k_i]$ å½“ä½œæŸå¤±å‡½æ•°ï¼Œå¯¹è§£æè¡¨è¾¾å¼æ±‚æ¢¯åº¦</li>
</ol>

<p><strong>åœ¨å…¸å‹çš„æ·±åº¦å­¦ä¹ ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®é™…æ‰§è¡Œçš„æ˜¯ã€Œå…ˆæ¢¯åº¦ã€åæœŸæœ›ã€</strong>â€”â€”è‡ªåŠ¨å¾®åˆ†å¯¹æ¯ä¸ªæ ·æœ¬è®¡ç®—æ¢¯åº¦ï¼Œç„¶ååœ¨ batch ä¸Šå–å¹³å‡ã€‚</p>

<h4 id="ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼">ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼</h4>

<p>ç°åœ¨æˆ‘ä»¬è®¡ç®—ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦ï¼Œçœ‹å®ƒä»¬çš„æœŸæœ›åˆ†åˆ«å¯¹åº”å“ªä¸ª KL çš„çœŸæ¢¯åº¦ï¼ˆå‚è§ã€Œå‡†å¤‡å·¥ä½œã€ç« èŠ‚ï¼‰ã€‚</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_1$</strong>ï¼š</p>

<p>$$
k_1 = -\log \frac{p(x)}{q_\theta(x)} = \log q_\theta(x) - \log p(x)
$$</p>

<p>$$
\nabla_\theta k_1 = \nabla_\theta \log q_\theta(x) - \nabla_\theta \log p(x) = s_\theta - 0 = s_\theta
$$</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_2$</strong>ï¼š</p>

<p>$$
k_2 = \frac{1}{2}\left(\log \frac{p}{q}\right)^2
$$</p>

<p>ç”±é“¾å¼æ³•åˆ™ï¼š</p>

<p>$$
\begin{aligned}
\nabla_\theta k_2 
&= \left(\log \frac{p}{q}\right) \cdot \nabla_\theta\left(\log \frac{p}{q}\right) \\
&= \left(\log \frac{p}{q}\right) \cdot \nabla_\theta(\log p(x) - \log q_\theta(x)) \\
&= \left(\log \frac{p}{q}\right)(-s_\theta) \\
&= - \left(\log \frac{p}{q}\right) s_\theta.
\end{aligned}
$$</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_3$</strong>ï¼š</p>

<p>$$
k_3 = \frac{p}{q} - 1 - \log \frac{p}{q}
$$</p>

<p>é¦–å…ˆè®¡ç®— $\nabla_\theta \frac{p}{q}$ã€‚ç”±äº $\frac{p}{q} = p(x) \cdot q_\theta(x)^{-1}$ï¼š</p>

<p>$$
\nabla_\theta \frac{p}{q} = p(x) \cdot (-1) \cdot q_\theta(x)^{-2} \cdot \nabla_\theta q_\theta(x) = -\frac{p(x)}{q_\theta(x)} \cdot \frac{\nabla_\theta q_\theta(x)}{q_\theta(x)} = -\frac{p}{q} \cdot s_\theta
$$</p>

<p>å†è®¡ç®— $\nabla_\theta \log \frac{p}{q}$ï¼š</p>

<p>$$
\nabla_\theta \log \frac{p}{q} = \frac{q}{p} \nabla_\theta \frac{p}{q} = \frac{q}{p} \cdot \left(-\frac{p}{q} \cdot s_\theta\right) = -s_\theta
$$</p>

<p>å› æ­¤ï¼š</p>

<p>$$
\nabla_\theta k_3 = \nabla_\theta \frac{p}{q} - 0 - \nabla_\theta \log \frac{p}{q} = -\frac{p}{q} \cdot s_\theta - (-s_\theta) = \left(1 - \frac{p}{q}\right) \cdot s_\theta
$$</p>

<p>å¯¹å®ƒä»¬åœ¨ $q_\theta$ ä¸‹å–æœŸæœ›ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">$\mathbb{E}_{q}[\nabla_\theta k_i]$</th>
      <th style="text-align: center">ç­‰ä»·äº</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">$\mathbb{E}_{q}[s_\theta] = 0$</td>
      <td style="text-align: center">é›¶ï¼ˆä½œä¸ºæŸå¤±æ— ç”¨ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">$-\mathbb{E}_{q}\left[\left(\log \frac{p}{q}\right) \cdot s_\theta\right] = \nabla_\theta D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">åå‘ KL çš„æ¢¯åº¦</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">$\mathbb{E}_{q}\left[\left(1-\frac{p}{q}\right) \cdot s_\theta\right] = \nabla_\theta D_{\mathrm{KL}}(p \| q)$</td>
      <td style="text-align: center">æ­£å‘ KL çš„æ¢¯åº¦</td>
    </tr>
  </tbody>
</table>

<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼š</p>
<ul>
  <li><strong>$k_2$ çš„æ¢¯åº¦</strong>ç­‰ä»·äºåå‘ KL çš„çœŸæ¢¯åº¦â€”â€”è¿™æ˜¯ä¼˜åŒ–ã€Œçº¦æŸç­–ç•¥ä¸åç¦» refã€çš„æ­£ç¡®é€‰æ‹©</li>
  <li><strong>$k_3$ çš„æ¢¯åº¦</strong>ç­‰ä»·äºæ­£å‘ KL çš„çœŸæ¢¯åº¦â€”â€”è¿™å¯¹åº”ã€Œè¦†ç›–å‹ã€ç›®æ ‡</li>
  <li><strong>$k_1$ çš„æ¢¯åº¦æœŸæœ›æ’ä¸ºé›¶</strong>â€”â€”ä½œä¸º loss åä¼ æ¯«æ— æ„ä¹‰ï¼</li>
</ul>

<h4 id="å…³é”®å‘ç°inlmath198mathend-æ— æ•ˆinlmath199mathend-å¯¹åº”åå‘-klinlmath200mathend-å¯¹åº”æ­£å‘-kl">å…³é”®å‘ç°ï¼š$k_1$ æ— æ•ˆã€$k_2$ å¯¹åº”åå‘ KLã€$k_3$ å¯¹åº”æ­£å‘ KL</h4>

<p>ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€vsã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€ï¼š</p>

<p>å¦‚æœä»è§£æè§’åº¦æŠŠ $\mathbb{E}_q[k_i]$ å½“ä½œä¸€ä¸ªå…³äº $\theta$ çš„å‡½æ•°å†æ±‚æ¢¯åº¦ï¼ˆå³ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ï¼‰ï¼Œé‚£ä¹ˆï¼š</p>

<p>$$
\nabla_\theta \mathbb{E}_q[k_1] = \nabla_\theta D_{\mathrm{KL}}(q \| p)
$$</p>

<p>$$
\nabla_\theta \mathbb{E}_q[k_3] = \nabla_\theta D_{\mathrm{KL}}(q \| p)
$$</p>

<p>ä¸¤è€…éƒ½ç»™å‡ºåå‘ KL çš„æ¢¯åº¦ã€‚ä½†åœ¨ä»£ç ä¸­ç›´æ¥å¯¹ $k_3$ çš„æ ·æœ¬å‡å€¼è°ƒç”¨åä¼ æ—¶ï¼Œè‡ªåŠ¨å¾®åˆ†æ‰§è¡Œçš„æ˜¯ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€ï¼Œå¾—åˆ°çš„æ˜¯ $\mathbb{E}_q[\nabla_\theta k_3]$ï¼Œå³<strong>æ­£å‘ KL çš„æ¢¯åº¦</strong>ã€‚</p>

<p><strong>on-policy åœºæ™¯çš„å…³é”®ç»“è®º</strong>ï¼šåŒä¸€ä¸ªä¼°è®¡å™¨ï¼Œä¸¤ç§æ±‚å¯¼é¡ºåºå¯èƒ½ç»™å‡ºå®Œå…¨ä¸åŒçš„ç»“æœã€‚å…·ä½“æ¥è¯´ï¼š</p>
<ul>
  <li>ä¼˜åŒ–<strong>åå‘ KL</strong>ï¼šåªèƒ½ç”¨ $k_2$</li>
  <li>ä¼˜åŒ–<strong>æ­£å‘ KL</strong>ï¼šç”¨ $k_3$</li>
  <li>$k_1$ çš„æ¢¯åº¦æœŸæœ›æ’ä¸ºé›¶ï¼Œä½œä¸º loss æ¯«æ— ä½œç”¨</li>
</ul>

<h3 id="off-policy-åœºæ™¯">Off-policy åœºæ™¯</h3>

<p>ç°åœ¨è€ƒè™‘ off-policy åœºæ™¯ï¼Œå³æ ·æœ¬æ¥è‡ªè¡Œä¸ºç­–ç•¥ $\mu \neq q_\theta$ã€‚åœ¨å®é™… RL è®­ç»ƒä¸­ï¼Œè¿™ç§æƒ…å†µéå¸¸å¸¸è§ï¼š</p>

<ul>
  <li>ç”¨æ—§ç­–ç•¥æˆ–æ··åˆç­–ç•¥ç”Ÿæˆæ•°æ®ï¼Œå†æ›´æ–°å½“å‰ actor $q_\theta$</li>
  <li>ç¦»çº¿ RL / ç»éªŒå›æ”¾ä¸­ï¼Œæ ·æœ¬åˆ†å¸ƒå›ºå®šä¸º $\mu$ï¼Œè€Œä¸æ˜¯å½“å‰çš„ $q_\theta$</li>
</ul>

<p>è¿™æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä»ç„¶å¸Œæœ›ä¼˜åŒ–<strong>åå‘ KL</strong> $D_{\mathrm{KL}}(q_\theta \| p)$ï¼Œå°±å¿…é¡»å¼•å…¥<strong>é‡è¦æ€§æƒé‡</strong>ã€‚</p>

<p>å…³äºå¤§æ¨¡å‹ off-policy åœºæ™¯çš„æ·±å…¥åˆ†æï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ï¼š<a href="/reinforcement-learning/2025/11/15/three-policy-zh.html">ä»ä¸¤ç­–ç•¥åˆ°ä¸‰ç­–ç•¥ï¼šLLM RL ä¸­è¡Œä¸ºç­–ç•¥â€“å‚è€ƒç­–ç•¥ä¸ä¸€è‡´ä¸‹çš„ TRPO æ‰©å±•</a>ã€‚</p>

<h4 id="é‡è¦æ€§åŠ æƒçš„å¼•å…¥">é‡è¦æ€§åŠ æƒçš„å¼•å…¥</h4>

<p>ä»ç„¶æ²¿ç”¨å‰æ–‡çš„è®°å·ï¼Œç°åœ¨åŠ å…¥é‡‡æ ·åˆ†å¸ƒ $\mu(x)$ï¼Œå¹¶ä½¿ç”¨é‡è¦æ€§æƒé‡ $w(x) = \frac{q_\theta(x)}{\mu(x)}$ã€‚</p>

<p>å½“ä» $x \sim \mu$ é‡‡æ ·æ—¶ï¼Œç”¨ $w(x) k_i(x)$ çš„ batch å‡å€¼ä½œä¸º lossï¼Œç„¶åè°ƒç”¨è‡ªåŠ¨å¾®åˆ†ã€‚é‚£ä¹ˆä¸‰ç§ä¼°è®¡å™¨åˆ†åˆ«ç»™å‡ºä»€ä¹ˆæ¢¯åº¦ï¼Ÿ</p>

<p>ä¸€ä¸ªå…³é”®å·®å¼‚æ˜¯ï¼š</p>

<blockquote>
  <p><strong>ä»¥å‰</strong>çš„æœŸæœ›æ˜¯ $\mathbb{E}_{q_{\theta}}[\cdot]$ï¼Œåˆ†å¸ƒæœ¬èº«ä¾èµ– $\theta$ï¼›
<strong>ç°åœ¨</strong>çš„æœŸæœ›æ˜¯ $\mathbb{E}_{\mu}[\cdot]$ï¼Œè€Œ $\mu$ ä¸ $\theta$ æ— å…³ã€‚</p>
</blockquote>

<p>è¿™ä¼šè®©ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ä¸ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€çš„å…³ç³»å‘ç”Ÿæ ¹æœ¬å˜åŒ–ã€‚</p>

<h4 id="ä¸¤ç§æ±‚å¯¼é¡ºåºçš„ç­‰ä»·æ€§">ä¸¤ç§æ±‚å¯¼é¡ºåºçš„ç­‰ä»·æ€§</h4>

<p>å› ä¸º $\mu$ ä¸ $\theta$ æ— å…³ï¼Œå¯¹ä»»ä½•å…³äº $\theta$ å¯å¾®çš„å‡½æ•° $f_\theta(x)$ï¼Œæœ‰</p>

<p>$$
\nabla_\theta \mathbb{E}_{\mu}[f_\theta(x)] = \mathbb{E}_{\mu}[\nabla_\theta f_\theta(x)]
$$</p>

<p>æ¢å¥è¯è¯´ï¼Œ<strong>ä»£ç ä¸­å¯¹æ ·æœ¬å‡å€¼åä¼ ï¼ˆå…ˆæ¢¯åº¦åæœŸæœ›ï¼‰å°±ç­‰ä»·äºå¯¹è§£æå½¢å¼æ±‚æ¢¯åº¦ï¼ˆå…ˆæœŸæœ›åæ¢¯åº¦ï¼‰</strong>ï¼Œä¸ä¼šå†åƒ on-policy æ—¶é‚£æ ·åˆ†è£‚æˆä¸¤ä¸ªä¸åŒçš„ç»“æœã€‚</p>

<p><strong>æ‰€ä»¥åœ¨ off-policy + é‡è¦æ€§åŠ æƒ çš„æƒ…å½¢ä¸‹ï¼Œå¯¹åå‘ KL æ•°å€¼æ— åçš„ä¼°è®¡å™¨ $k_1$ å’Œ $k_3$ï¼Œå®ƒä»¬çš„æ¢¯åº¦æœŸæœ›éƒ½å°†å¯¹åº”äºåå‘ KL çš„çœŸæ¢¯åº¦ã€‚</strong></p>

<p>è¿™æ˜¯ä¸ on-policy æƒ…å½¢çš„æ ¹æœ¬åŒºåˆ«ã€‚</p>

<h4 id="æ•°å€¼å±‚é¢æ— åæ€§ä»ç„¶ä¿æŒ">æ•°å€¼å±‚é¢ï¼šæ— åæ€§ä»ç„¶ä¿æŒ</h4>

<p>ç”±æ ‡å‡†çš„é‡è¦æ€§é‡‡æ ·å…³ç³» $\mathbb{E}_\mu[w \cdot f] = \mathbb{E}_{q_\theta}[f]$ï¼Œæœ‰</p>

<p>$$
\mathbb{E}_\mu[w k_1] = D_{\mathrm{KL}}(q_\theta \| p), \quad
\mathbb{E}_\mu[w k_3] = D_{\mathrm{KL}}(q_\theta \| p) \quad \textbf{ï¼ˆæ— åï¼‰}
$$</p>

<p>$$
\mathbb{E}_\mu[w k_2] = \mathbb{E}_{q_\theta}[k_2] \neq D_{\mathrm{KL}}(q_\theta \| p) \quad \textbf{ï¼ˆæœ‰åï¼‰}
$$</p>

<p>è¿™ä¸ on-policy æƒ…å½¢å®Œå…¨ä¸€è‡´ã€‚</p>

<h4 id="æ¢¯åº¦æ¨å¯¼ä¸æ— åæ€§åˆ†æ">æ¢¯åº¦æ¨å¯¼ä¸æ— åæ€§åˆ†æ</h4>

<p>é¦–å…ˆè®¡ç®—é‡è¦æ€§æƒé‡çš„æ¢¯åº¦ã€‚ç”± $w = q_\theta / \mu$ ä¸” $\mu$ ä¸ä¾èµ– $\theta$ï¼š</p>

<p>$$
\nabla_\theta w(x) = w(x) s_\theta(x)
$$</p>

<p>ç»“åˆå‰æ–‡å·²æ¨å¯¼çš„ $\nabla_\theta k_i$ï¼Œç”¨ä¹˜ç§¯æ³•åˆ™ï¼š</p>

<p><strong>$\nabla_\theta(w k_1)$</strong>ï¼š</p>

<p>$$
\nabla_\theta(w k_1) = (\nabla_\theta w) k_1 + w (\nabla_\theta k_1) = w s_\theta k_1 + w s_\theta = w s_\theta (k_1 + 1)
$$</p>

<p><strong>$\nabla_\theta(w k_2)$</strong>ï¼š</p>

<p>$$
\nabla_\theta(w k_2) = w s_\theta k_2 + w \left(-\log \frac{p}{q}\right) s_\theta = w s_\theta \left(k_2 - \log \frac{p}{q}\right)
$$</p>

<p><strong>$\nabla_\theta(w k_3)$</strong>ï¼š</p>

<p>$$
\nabla_\theta(w k_3) = w s_\theta k_3 + w \left(1-\frac{p}{q}\right) s_\theta = w s_\theta \left(k_3 + 1 - \frac{p}{q}\right)
$$</p>

<p>ä»£å…¥ $k_3 = \frac{p}{q} - 1 - \log \frac{p}{q}$ï¼š</p>

<p>$$
k_3 + 1 - \frac{p}{q} = \left(\frac{p}{q} - 1 - \log \frac{p}{q}\right) + 1 - \frac{p}{q} = -\log \frac{p}{q} = k_1
$$</p>

<p>å› æ­¤æœ‰ä¸€ä¸ªç®€åŒ–ï¼š</p>

<p>$$
\boxed{\nabla_\theta(w k_3) = w s_\theta k_1 = -w s_\theta \log \frac{p}{q}}
$$</p>

<h4 id="å“ªäº›ä¼°è®¡å™¨ç»™å‡ºæ— åçš„åå‘-kl-æ¢¯åº¦">å“ªäº›ä¼°è®¡å™¨ç»™å‡ºæ— åçš„åå‘ KL æ¢¯åº¦ï¼Ÿ</h4>

<p>åˆ©ç”¨ $\mathbb{E}_\mu[w \cdot f] = \mathbb{E}_{q_\theta}[f]$ å’Œ $\mathbb{E}_{q_\theta}[s_\theta] = 0$ï¼š</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(w k_1)]$</strong>ï¼š</p>

<p>$$
\mathbb{E}_\mu[w s_\theta (k_1 + 1)] = \mathbb{E}_{q}[s_\theta k_1] + \underbrace{\mathbb{E}_{q}[s_\theta]}_{=0} = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) \quad \checkmark
$$</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(w k_2)]$</strong>ï¼š</p>

<p>$$
\mathbb{E}_\mu\left[w s_\theta \left(k_2 - \log \frac{p}{q}\right)\right] = \mathbb{E}_{q}\left[s_\theta \left(k_2 - \log \frac{p}{q}\right)\right] = \nabla_\theta \mathbb{E}_{q}[k_2]
$$</p>

<p>è¿™æ˜¯ $\mathbb{E}_q[k_2]$ è¿™ä¸ª f-æ•£åº¦çš„çœŸæ¢¯åº¦ï¼Œ<strong>ä¸æ˜¯</strong>åå‘ KL çš„æ¢¯åº¦ã€‚</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(\text{sg}(w) k_2)]$</strong>ï¼š</p>

<p>å¦‚æœæŠŠé‡è¦æ€§æƒé‡è§†ä¸ºå¸¸æ•°ï¼ˆåœ¨ä»£ç ä¸­ detach æ‰ï¼‰ï¼Œåˆ™ï¼š</p>

<p>$$
\nabla_\theta(\text{sg}(w) k_2) = \text{sg}(w) \cdot \nabla_\theta k_2 = \text{sg}(w) \cdot \left(-\log \frac{p}{q}\right) s_\theta
$$</p>

<p>å–æœŸæœ›ï¼š</p>

<p>$$
\mathbb{E}_\mu\left[\text{sg}(w) \cdot \left(-\log \frac{p}{q}\right) s_\theta\right] = \mathbb{E}_{q}\left[\left(-\log \frac{p}{q}\right) s_\theta\right] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) \quad \checkmark
$$</p>

<p>è¿™æ­£æ˜¯åå‘ KL çš„çœŸæ¢¯åº¦ï¼</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(w k_3)]$</strong>ï¼š</p>

<p>$$
\mathbb{E}_\mu[w s_\theta k_1] = \mathbb{E}_{q}[s_\theta k_1] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) \quad \checkmark
$$</p>

<p><strong>æ€»ç»“è¡¨æ ¼</strong>ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">åŠ æƒä¼°è®¡å™¨</th>
      <th style="text-align: center">æœŸæœ›å¯¹åº”çš„ç›®æ ‡</th>
      <th style="text-align: center">æ¢¯åº¦æœŸæœ›å¯¹åº”çš„çœŸæ¢¯åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\mu} k_1$</td>
      <td style="text-align: center">$D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$ï¼ˆåå‘ KLï¼‰ âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\mu} k_2$</td>
      <td style="text-align: center">$\mathbb{E}_q[k_2]$ï¼ˆf-æ•£åº¦ï¼‰</td>
      <td style="text-align: center">$\nabla_\theta \mathbb{E}_q[k_2]$ï¼Œä¸æ˜¯åå‘ KL âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$</td>
      <td style="text-align: center">$\mathbb{E}_q[k_2]$ï¼ˆf-æ•£åº¦ï¼‰</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$ï¼ˆåå‘ KLï¼‰ âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\mu} k_3$</td>
      <td style="text-align: center">$D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$ï¼ˆåå‘ KLï¼‰ âœ“</td>
    </tr>
  </tbody>
</table>

<p><strong>ä¸ on-policy æƒ…å½¢çš„å¯¹æ¯”â€”â€”ä¸€ä¸ªæœ‰è¶£çš„åè½¬</strong>ï¼š</p>

<ul>
  <li>On-policy æ—¶ï¼Œç”¨ $k_2$ åš loss çš„æ¢¯åº¦æ˜¯åå‘ KLï¼Œè€Œ $k_1$ çš„æ¢¯åº¦æœŸæœ›æ’ä¸ºé›¶</li>
  <li>Off-policy + é‡è¦æ€§åŠ æƒæ—¶ï¼Œ$\frac{q_\theta}{\mu} k_1$ å’Œ $\frac{q_\theta}{\mu} k_3$ ç»™å‡ºåå‘ KL çš„çœŸæ¢¯åº¦ï¼Œè€Œ $\frac{q_\theta}{\mu} k_2$ï¼ˆæƒé‡å‚ä¸æ¢¯åº¦è®¡ç®—ï¼‰<strong>ä¸å†é€‚ç”¨</strong></li>
  <li>ä½†å¦‚æœæŠŠé‡è¦æ€§æƒé‡ <strong>detach</strong> æ‰ï¼Œ$\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$ çš„æ¢¯åº¦ä¹Ÿæ˜¯åå‘ KL çš„çœŸæ¢¯åº¦</li>
</ul>

<h4 id="ä¸‰ä¸ªæ— åæ¢¯åº¦ä¼°è®¡å™¨çš„æ–¹å·®å¯¹æ¯”">ä¸‰ä¸ªæ— åæ¢¯åº¦ä¼°è®¡å™¨çš„æ–¹å·®å¯¹æ¯”</h4>

<p>å‰ä¸€å°èŠ‚æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨ off-policy + é‡è¦æ€§é‡‡æ ·çš„è®¾ç½®ä¸‹ï¼Œä¸‹é¢ä¸‰ä¸ª loss éƒ½ç»™å‡º<strong>åå‘ KL</strong> çš„æ— åæ¢¯åº¦ä¼°è®¡ï¼š</p>

<p>$$
L_1(x) = w(x) k_1(x),\qquad
L_2(x) = \text{sg}(w(x)) k_2(x),\qquad
L_3(x) = w(x) k_3(x),
$$</p>

<p>å…¶ä¸­ $w = \dfrac{q_\theta}{\mu}$ï¼Œ$\text{sg}(\cdot)$ è¡¨ç¤º stop-gradientã€‚å®ƒä»¬å¯¹åº”çš„æ¢¯åº¦éšæœºå˜é‡ä¸ºï¼š</p>

<p>$$
g_1(x) := \nabla_\theta L_1(x),\quad
g_2(x) := \nabla_\theta L_2(x),\quad
g_3(x) := \nabla_\theta L_3(x).
$$</p>

<p>åˆ©ç”¨å‰æ–‡å·²æ¨å¯¼çš„ç»“æœï¼š</p>

<ul>
  <li>$\nabla_\theta w = w s_\theta$;</li>
  <li>$\nabla_\theta k_1 = s_\theta$;</li>
  <li>$\nabla_\theta k_2 = - \left(\log \frac{p}{q}\right) s_\theta = k_1 s_\theta$;</li>
  <li>$\nabla_\theta k_3 = \left(1-\frac{p}{q}\right) s_\theta$.</li>
</ul>

<p>æœ‰ï¼š</p>

<p>$$
\begin{aligned}
g_1(x)
&= \nabla_\theta(w k_1)
= w s_\theta k_1 + w s_\theta
= w(x) s_\theta(x)\big(k_1(x)+1\big),\\
g_2(x)
&= \nabla_\theta(\text{sg}(w) k_2)
= \text{sg}(w) \,\nabla_\theta k_2
= w \, k_1 s_\theta
= w(x) s_\theta(x) k_1(x),\\
g_3(x)
&= \nabla_\theta(w k_3)
= w s_\theta k_3 + w\left(1-\frac{p}{q}\right)s_\theta
= w s_\theta \left(k_3 + 1 - \frac{p}{q}\right)
= w(x) s_\theta(x) k_1(x).
\end{aligned}
$$</p>

<p>æœ€åä¸€æ­¥ç”¨åˆ°äº† $k_3 + 1 - \frac{p}{q} = \left(\frac{p}{q} - 1 - \log \frac{p}{q}\right) + 1 - \frac{p}{q} = -\log \frac{p}{q} = k_1$ã€‚äºæ˜¯å‡ºç°äº†ä¸€ä¸ªéå¸¸å…³é”®çš„äº‹å®ï¼š</p>

<blockquote>
  <p>åœ¨ off-policy + detach æƒé‡çš„æƒ…å†µä¸‹ï¼Œ$\text{sg}(w) k_2$ ä¸ $w k_3$ çš„æ¢¯åº¦å®Œå…¨ä¸€æ ·ï¼š$g_2(x) \equiv g_3(x)$ã€‚</p>
</blockquote>

<p>æ¢è¨€ä¹‹ï¼Œä¸‰ä¸ª loss å®é™…ä¸Šåªå¯¹åº”<strong>ä¸¤ç§</strong>ä¸åŒçš„æ¢¯åº¦éšæœºå˜é‡ï¼š$g_1$ ä¸ $g_\star := g_2 = g_3$ã€‚</p>

<p>ä¸‹é¢å°±æ¯”è¾ƒè¿™ä¸¤ç§éšæœºå˜é‡çš„æ–¹å·®ã€‚</p>

<p>ä¸ºç®€åŒ–è®°å·ï¼Œä»¤</p>

<p>$$
A(x) := w(x) s_\theta(x), \quad B(x) := k_1(x),
$$</p>

<p>åˆ™</p>

<p>$$
g_1 = A(B+1),\qquad g_\star = A B.
$$</p>

<p>ä¸¤è€…çš„æœŸæœ›éƒ½ç­‰äº $\nabla_\theta D_{\mathrm{KL}}(q_\theta\|p)$ï¼Œå› æ­¤æœ‰ç›¸åŒçš„å‡å€¼é¡¹ã€‚å±•å¼€æ–¹å·®å®šä¹‰å¹¶ç›¸å‡å¾—åˆ°ï¼š</p>

<p>$$
\boxed{
\mathrm{Var}_\mu(g_1) - \mathrm{Var}_\mu(g_\star)
= \mathbb{E}_\mu\big[A^2((B+1)^2 - B^2)\big]
= \mathbb{E}_\mu\big[A^2 (2B+1)\big]
}
$$</p>

<p>ä¹Ÿå°±æ˜¯</p>

<p>$$
\mathrm{Var}_\mu(g_1) - \mathrm{Var}_\mu(g_\star)
= \mathbb{E}_\mu\Big[w(x)^2 s_\theta(x)^2 \big(2k_1(x)+1\big)\Big].
$$</p>

<p>åœ¨å¸¸è§çš„ KL æƒ©ç½š regime ä¸‹ï¼Œ$q_\theta \approx p \approx \mu$ï¼Œå– $\frac{p(x)}{q(x)}=1+\varepsilon(x)$ï¼Œ$\lvert \varepsilon\rvert \ll1$ã€‚æ­¤æ—¶ $k_1 = -\log \frac{p}{q} \approx -\varepsilon$ï¼Œå› æ­¤ $2k_1+1 \approx 1 - 2\varepsilon$ï¼Œä¸»å¯¼é¡¹ä¸ºæ­£çš„ $O(1)$ å¸¸æ•°ã€‚è¿™æ„å‘³ç€ä¸Šå¼å³ä¾§è¿‘ä¼¼ä¸º $\mathbb{E}_\mu[w^2 s_\theta^2] > 0$ï¼Œä»è€Œ $\mathrm{Var}_\mu(g_1) > \mathrm{Var}_\mu(g_\star)$ã€‚</p>

<p>æ›´å…·ä½“åœ°ï¼Œä¸€é˜¶è¿‘ä¼¼</p>

<p>$$
k_1 \approx -\varepsilon,\quad k_1+1 \approx 1-\varepsilon.
$$</p>

<p>äºæ˜¯</p>

<p>$$
g_1(x) \approx w(x) s_\theta(x)(1 - \varepsilon(x)),\quad g_\star(x) \approx w(x) s_\theta(x)(-\varepsilon(x)).
$$</p>

<p>æ ¸å¿ƒç›´è§‚ç†è§£ï¼š</p>

<ul>
  <li>$g_1$ åŒ…å«ä¸€ä¸ªé‡çº§ä¸º $O(1)$ çš„é›¶å‡å€¼å™ªå£°é¡¹ $w s_\theta$ï¼Œå¯¼è‡´å•æ ·æœ¬æ–¹å·®è¾ƒå¤§ï¼›</li>
  <li>$g_\star$ å·²æŠŠè¯¥å¸¸æ•°å™ªå£°é¡¹æ¶ˆå»ï¼Œå‰©ä¸‹ä¸ $\varepsilon$ æˆæ­£æ¯”çš„ä¸€é˜¶å°é‡ï¼Œæ–¹å·®ä¸º $O(\varepsilon^2)$ï¼Œæ˜¾è‘—æ›´å°ã€‚</li>
</ul>

<p>å°ç»“è¡¨æ ¼ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">æ¢¯åº¦éšæœºå˜é‡</th>
      <th style="text-align: center">ç³»æ•°é‡çº§ï¼ˆ$\frac{p}{q}\approx1$ï¼‰</th>
      <th style="text-align: center">æ–¹å·®</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$w k_1$</td>
      <td style="text-align: center">$w s_\theta (k_1+1)$</td>
      <td style="text-align: center">$O(1)$</td>
      <td style="text-align: center">é«˜</td>
    </tr>
    <tr>
      <td style="text-align: center">$\text{sg}(w) k_2$</td>
      <td style="text-align: center">$w s_\theta k_1$</td>
      <td style="text-align: center">$O(\varepsilon)$</td>
      <td style="text-align: center">ä½</td>
    </tr>
    <tr>
      <td style="text-align: center">$w k_3$</td>
      <td style="text-align: center">$w s_\theta k_1$</td>
      <td style="text-align: center">$O(\varepsilon)$</td>
      <td style="text-align: center">ä½</td>
    </tr>
  </tbody>
</table>

<p>ç»“è®ºï¼šåœ¨ off-policy + é‡è¦æ€§é‡‡æ ·çš„è®¾ç½®ä¸‹ï¼Œç»™å‡ºåå‘ KL çœŸæ¢¯åº¦çš„æ— åä¼°è®¡å™¨æœ‰ä¸‰ä¸ªï¼š$w k_1,\; \text{sg}(w) k_2,\; w k_3$ã€‚å…¶ä¸­ $\text{sg}(w) k_2$ ä¸ $w k_3$ åœ¨æ¢¯åº¦å±‚é¢å®Œå…¨ç­‰ä»·â€”â€”åŒå‡å€¼ã€åŒæ–¹å·®ã€åŒé«˜é˜¶çŸ©ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œ$w k_1$ çš„æ¢¯åº¦å¤šäº†ä¸€ä¸ªé›¶å‡å€¼çš„å¸¸æ•°å™ªå£°é¡¹ $w s_\theta$ï¼Œåœ¨å…¸å‹çš„ KL æƒ©ç½š regime ä¸‹å…¶æ–¹å·®å¤§çº¦é«˜ä¸€ä¸ªé‡çº§ã€‚</p>

<blockquote>
  <p>å®è·µå»ºè®®ï¼šè‹¥åœ¨ off-policy åœºæ™¯ä¸‹ä¼˜åŒ–åå‘ KLï¼Œé¦–é€‰ $w k_3$ æˆ– $\text{sg}(w) k_2$ï¼ˆä¸¤è€…æ¢¯åº¦ç­‰ä»·ä¸”æ–¹å·®ä½ï¼‰ï¼›$w k_1$ è™½æ— åä½†æ–¹å·®é«˜ï¼Œå¯ä½œä¸ºå¤‡é€‰å¹¶éœ€é…åˆ clipping/æ­£åˆ™åŒ–ã€‚</p>
</blockquote>

<p><strong>æåº¦ off-policy æ—¶çš„è­¦ç¤º</strong>ï¼š</p>

<p>å½“ $\mu$ ä¸ $q_\theta$ å·®å¼‚å¾ˆå¤§â€”â€”æ¯”å¦‚ $\mu$ åœ¨ $q_\theta$ çš„é«˜å¯†åº¦åŒºåŸŸå‡ ä¹æ²¡æœ‰é‡‡æ ·ï¼Œæˆ– $w = q_\theta / \mu$ åœ¨å°¾éƒ¨çˆ†ç‚¸â€”â€”ä»»ä½•åŸºäº $\frac{q_\theta}{\mu}$ çš„æ–¹æ³•éƒ½ä¼šé­é‡ä¸¥é‡çš„æ–¹å·®é—®é¢˜ã€‚æ­¤æ—¶ $\frac{q_\theta}{\mu} k_3$ï¼ˆæˆ– $\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$ï¼‰ç›¸å¯¹ $\frac{q_\theta}{\mu} k_1$ çš„ä¼˜åŠ¿ä¸å†æœ‰ç†è®ºä¿è¯ï¼Œéœ€è¦ç»“åˆ clippingã€æ­£åˆ™åŒ–ç­‰ç­–ç•¥ç»¼åˆå¤„ç†ã€‚</p>

<p>ä¸è¿‡ï¼Œåœ¨ RL å®è·µä¸­æˆ‘ä»¬é€šå¸¸ä¼šæ§åˆ¶ KL çº¦æŸã€é™åˆ¶ off-policy ç¨‹åº¦ï¼ˆæ¯”å¦‚ä½¿ç”¨è¿‘é‚»ç­–ç•¥ $\mu = q_{\theta_\text{old}}$ï¼‰ï¼Œåœ¨è¿™ä¸ªå¸¸è§çš„ regime é‡Œï¼Œå¯ä»¥ç›¸å½“æœ‰ä¿¡å¿ƒåœ°è¯´ï¼š</p>

<blockquote>
  <p><strong>å¦‚æœå·²ç»å†³å®šç”¨ off-policy + é‡è¦æ€§é‡‡æ ·æ¥ä¼˜åŒ–åå‘ KLï¼Œæ¨èä½¿ç”¨ $\dfrac{q_\theta}{\mu} k_3$ æˆ– $\text{sg}\left(\dfrac{q_\theta}{\mu}\right) k_2$ï¼ˆä¸¤è€…æ¢¯åº¦ç­‰ä»·ä¸”æ–¹å·®ä½ï¼‰ï¼›ç›¸è¾ƒä¹‹ä¸‹ï¼Œ$\dfrac{q_\theta}{\mu} k_1$ æ–¹å·®æ›´é«˜ã€‚</strong></p>
</blockquote>

<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ DeepSeek v3.2 æŠ€æœ¯æŠ¥å‘Šä¸­ä½¿ç”¨çš„æ˜¯ $\frac{q_\theta}{\mu} k_3$ ä½œä¸º off-policy KL æƒ©ç½šçš„ä¼°è®¡å™¨ã€‚</p>

<figure style="text-align:center;">
<img src="/assets/img/kl-estimators/dpsk-3d2-k3.png" style="width:95%;max-width:100%;" />
<figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://arxiv.org/pdf/2512.02556v1">DeepSeek v3.2 æŠ€æœ¯æŠ¥å‘Š 3.1 ç« èŠ‚</a></figcaption>
</figure>

<h4 id="å…³é”®å‘ç°inlmath321mathend-æˆ–-inlmath322mathend-æ˜¯æœ€ä¼˜é€‰æ‹©">å…³é”®å‘ç°ï¼š$w k_3$ æˆ– $\text{sg}(w) k_2$ æ˜¯æœ€ä¼˜é€‰æ‹©</h4>

<p><strong>off-policy åœºæ™¯çš„å…³é”®ç»“è®º</strong>ï¼š</p>
<ul>
  <li>ä»è¡Œä¸ºç­–ç•¥ $\mu$ é‡‡æ ·æ—¶ï¼Œè‡ªç„¶çš„ off-policy KL ä¼°è®¡ä¸º $\frac{q_\theta}{\mu} k_i$</li>
  <li><strong>æ•°å€¼ä¸Š</strong>ï¼Œ$\frac{q_\theta}{\mu} k_1$ ä¸ $\frac{q_\theta}{\mu} k_3$ ä»ç„¶æ˜¯åå‘ KL çš„æ— åä¼°è®¡</li>
  <li><strong>æ¢¯åº¦ä¸Š</strong>ï¼Œå› ä¸º $\mu$ ä¸ $\theta$ æ— å…³ï¼Œã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ä¸ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€ç­‰ä»·ï¼š
    <ul>
      <li>$\mathbb{E}_\mu[\nabla_\theta(\frac{q_\theta}{\mu} k_1)] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$</li>
      <li>$\mathbb{E}_\mu[\nabla_\theta(\frac{q_\theta}{\mu} k_3)] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$</li>
      <li>$\mathbb{E}_\mu[\nabla_\theta(\frac{q_\theta}{\mu} k_2)] \neq \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$</li>
    </ul>
  </li>
  <li><strong>æ–¹å·®ä¸Š</strong>ï¼Œ$\frac{q_\theta}{\mu} k_3$ ä¸ $\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$ çš„æ¢¯åº¦<strong>å®Œå…¨ç›¸åŒ</strong>ï¼ˆä¸¤è€…éƒ½æ˜¯ $w s_\theta k_1$ï¼‰ï¼Œåœ¨ç»Ÿè®¡æ€§è´¨ä¸Šç­‰ä»·ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œ$\frac{q_\theta}{\mu} k_1$ çš„æ¢¯åº¦å¤šäº†ä¸€ä¸ªé›¶å‡å€¼å™ªå£°é¡¹ $w s_\theta$ï¼Œåœ¨ $q_\theta \approx p \approx \mu$ çš„å…¸å‹åœºæ™¯ä¸‹æ–¹å·®æ˜¾è‘—æ›´é«˜</li>
</ul>

<h3 id="æ¢¯åº¦åˆ†ææ€»è§ˆè¡¨">æ¢¯åº¦åˆ†ææ€»è§ˆè¡¨</h3>

<p>ç»¼åˆä»¥ä¸Šåˆ†æï¼Œä¸‹è¡¨æ±‡æ€»äº† on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ä¸‹ï¼Œå„ä¼°è®¡å™¨çš„æ¢¯åº¦æœŸæœ›åŠå…¶å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">é‡‡æ ·æ¥æº</th>
      <th style="text-align: center">Loss</th>
      <th style="text-align: center">$\nabla_\theta$ Loss çš„æœŸæœ›</th>
      <th style="text-align: center">å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡</th>
      <th style="text-align: center">èƒ½å¦ç”¨äºä¼˜åŒ–åå‘ KLï¼Ÿ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$q$ (on)</td>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">$\mathbb{E}_q[s_\theta] = 0$</td>
      <td style="text-align: center">æ— ï¼ˆæ¢¯åº¦æ’ä¸ºé›¶ï¼‰</td>
      <td style="text-align: center">âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$q$ (on)</td>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$q$ (on)</td>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(p \| q)$</td>
      <td style="text-align: center">æ­£å‘ KL</td>
      <td style="text-align: center">âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\mu$ (off)</td>
      <td style="text-align: center">$\frac{q}{\mu} k_1$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“ï¼ˆä½†æ–¹å·®è¾ƒé«˜ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$\mu$ (off)</td>
      <td style="text-align: center">$\frac{q}{\mu} k_2$</td>
      <td style="text-align: center">$\nabla_\theta \mathbb{E}_q[k_2]$</td>
      <td style="text-align: center">f-æ•£åº¦ï¼ˆé KLï¼‰</td>
      <td style="text-align: center">âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\mu$ (off)</td>
      <td style="text-align: center">$\text{sg}\left(\frac{q}{\mu}\right) k_2$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$\mu$ (off)</td>
      <td style="text-align: center">$\frac{q}{\mu} k_3$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“ï¼ˆæ¨èï¼Œä½æ–¹å·®ï¼‰</td>
    </tr>
  </tbody>
</table>

<p><strong>å…³é”®ç»“è®º</strong>ï¼š</p>

<ol>
  <li><strong>On-policy ä¼˜åŒ–åå‘ KL</strong>ï¼šå”¯ä¸€æ­£ç¡®é€‰æ‹©æ˜¯ $k_2$</li>
  <li><strong>Off-policy ä¼˜åŒ–åå‘ KL</strong>ï¼šæœ‰ä¸‰ä¸ªæ­£ç¡®é€‰é¡¹ï¼š
    <ul>
      <li>$\frac{q}{\mu} k_1$ï¼šæ— åä½†æ–¹å·®è¾ƒé«˜</li>
      <li>$\text{sg}\left(\frac{q}{\mu}\right) k_2$ï¼šæ— åï¼Œä¸ $\frac{q}{\mu} k_3$ <strong>æ¢¯åº¦å®Œå…¨ç­‰ä»·</strong></li>
      <li>$\frac{q}{\mu} k_3$ï¼šæ— åä¸”æ–¹å·®æ›´ä½ï¼ˆä¸ä¸Šä¸€é¡¹ç­‰ä»·ï¼Œå‡ä¸ºæ¨èé€‰æ‹©ï¼‰</li>
    </ul>
  </li>
  <li><strong>$\frac{q}{\mu} k_2$ï¼ˆæƒé‡å‚ä¸æ¢¯åº¦ï¼‰åœ¨ off-policy ä¸‹å¤±æ•ˆ</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªå®¹æ˜“è¢«å¿½è§†çš„é™·é˜±</li>
</ol>

<h2 id="ä½œä¸º-reward-æ—¶çš„æ¢¯åº¦åˆ†æ">ä½œä¸º Reward æ—¶çš„æ¢¯åº¦åˆ†æ</h2>

<p>å‰æ–‡åˆ†æäº†ä¸‰ç§ä¼°è®¡å™¨åœ¨ä¼°è®¡ KL <strong>æ•°å€¼</strong>æ—¶çš„åå·®ä¸æ–¹å·®ã€‚ä¸€ä¸ªè‡ªç„¶çš„æƒ³æ³•æ˜¯ï¼šæ—¢ç„¶ $k_1$ å’Œ $k_3$ å¯¹åå‘ KL æ•°å€¼éƒ½æ˜¯æ— åçš„ï¼Œé‚£ä¹ˆæŠŠå®ƒä»¬ï¼ˆåŠ  stop-gradientï¼‰ä½œä¸º reward æƒ©ç½šåº”è¯¥éƒ½æ²¡é—®é¢˜ã€‚</p>

<p><strong>ä½†è¿™æ˜¯é”™è¯¯çš„ã€‚</strong></p>

<p>é—®é¢˜åœ¨äºï¼šå½“ KL ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œè™½ç„¶ KL é¡¹æœ¬èº«ä¸åä¼ æ¢¯åº¦ï¼Œä½†å®ƒä¼šé€šè¿‡ advantage é—´æ¥å½±å“ç­–ç•¥æ¢¯åº¦ã€‚å› æ­¤ï¼Œè¯„ä»·ä¸€ä¸ªä¼°è®¡å™¨ã€Œèƒ½å¦ç”¨äº reward æƒ©ç½šã€ï¼Œä¸åº”åªçœ‹æ•°å€¼åå·®ï¼Œè€Œåº”çœ‹<strong>å®ƒè¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ˜¯å¦æ­£ç¡®</strong>ã€‚</p>

<h3 id="çœŸæ­£çš„-kl-æ­£åˆ™åŒ–ç­–ç•¥æ¢¯åº¦">çœŸæ­£çš„ KL æ­£åˆ™åŒ–ç­–ç•¥æ¢¯åº¦</h3>

<p>è€ƒè™‘ KL æ­£åˆ™åŒ–çš„å¼ºåŒ–å­¦ä¹ ç›®æ ‡ï¼š</p>

<p>$$
J(\theta) = \mathbb{E}_{q_\theta}[R] - \beta \cdot D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>å…¶çœŸæ¢¯åº¦ä¸ºï¼š</p>

<p>$$
\nabla_\theta J = \mathbb{E}_{q_\theta}[s_\theta \cdot R] - \beta \cdot \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>åˆ©ç”¨å‰æ–‡ã€Œå‡†å¤‡å·¥ä½œã€ç« èŠ‚çš„ç»“è®ºï¼Œåå‘ KL çš„æ¢¯åº¦ä¸ºï¼š</p>

<p>$$
\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(-\log \frac{p}{q}\right)\right] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]
$$</p>

<p>å› æ­¤ï¼ŒçœŸæ­£çš„ KL æ­£åˆ™åŒ–ç­–ç•¥æ¢¯åº¦æ˜¯ï¼š</p>

<p>$$
\nabla_\theta J = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(R - \beta \cdot k_1\right)\right]
$$</p>

<h3 id="ä½¿ç”¨ä¼°è®¡å™¨-inlmath368mathend-æ—¶çš„æ¢¯åº¦å½¢å¼">ä½¿ç”¨ä¼°è®¡å™¨ $\hat{k}$ æ—¶çš„æ¢¯åº¦å½¢å¼</h3>

<p>å½“æˆ‘ä»¬ç”¨æŸä¸ªä¼°è®¡å™¨ $\hat{k}$ï¼ˆåŠ  stop-gradientï¼‰ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œshaped reward ä¸º $\tilde{R} = R - \beta \cdot \text{sg}(\hat{k})$ï¼Œç­–ç•¥æ¢¯åº¦å˜ä¸ºï¼š</p>

<p>$$
\nabla_\theta \tilde{J} = \mathbb{E}_{q_\theta}\left[s_\theta \cdot (R - \beta \cdot \hat{k})\right]
$$</p>

<p><strong>æ— åæ¡ä»¶</strong>ï¼š$\nabla_\theta \tilde{J} = \nabla_\theta J$ å½“ä¸”ä»…å½“</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot \hat{k}] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]
$$</p>

<h3 id="ä½¿ç”¨-inlmath372mathend-ä½œä¸ºæƒ©ç½šæ¢¯åº¦æ— å">ä½¿ç”¨ $k_1$ ä½œä¸ºæƒ©ç½šï¼šæ¢¯åº¦æ— å</h3>

<p>å½“ $\hat{k} = k_1$ æ—¶ï¼Œæ¡ä»¶è‡ªåŠ¨æ»¡è¶³ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot k_1] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1] \quad \checkmark
$$</p>

<p>å› æ­¤ï¼Œ<strong>$k_1$ ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œè¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ˜¯æ— åçš„</strong>ã€‚</p>

<h3 id="ä½¿ç”¨-inlmath375mathend-ä½œä¸ºæƒ©ç½šæ¢¯åº¦æœ‰å">ä½¿ç”¨ $k_3$ ä½œä¸ºæƒ©ç½šï¼šæ¢¯åº¦æœ‰å</h3>

<p>å½“ $\hat{k} = k_3 = \frac{p}{q} - 1 - \log \frac{p}{q}$ æ—¶ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot k_3] = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(\frac{p}{q} - 1\right)\right] + \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(-\log \frac{p}{q}\right)\right]
$$</p>

<p>ç¬¬äºŒé¡¹æ­£æ˜¯ $\mathbb{E}_{q_\theta}[s_\theta \cdot k_1]$ã€‚é—®é¢˜å‡ºåœ¨ç¬¬ä¸€é¡¹ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(\frac{p}{q} - 1\right)\right] = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q}\right] - \underbrace{\mathbb{E}_{q_\theta}[s_\theta]}_{=0} = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q}\right]
$$</p>

<p>è€Œè¿™ä¸ªé‡å¯ä»¥æ”¹å†™ä¸ºï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q}\right] = \int q_\theta(x) \cdot \nabla_\theta \log q_\theta(x) \cdot \frac{p(x)}{q_\theta(x)} dx = \int p(x) \cdot \nabla_\theta \log q_\theta(x) dx = \mathbb{E}_p[s_\theta]
$$</p>

<p>åˆ©ç”¨æ­£å‘ KL çš„æ¢¯åº¦å…¬å¼ $\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = -\mathbb{E}_p[s_\theta]$ï¼Œæœ‰ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q}\right] = -\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta)
$$</p>

<p>å› æ­¤ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot k_3] = \underbrace{-\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta)}_{\text{åå·®é¡¹}} + \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p><strong>$k_3$ ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œæ¢¯åº¦æ˜¯æœ‰åçš„</strong>ï¼Œåå·®é¡¹ç­‰äºæ­£å‘ KL æ¢¯åº¦çš„è´Ÿå€¼ã€‚</p>

<p><strong>åå·®çš„å‡ ä½•å«ä¹‰</strong>ï¼šä½¿ç”¨ $k_3$ ä½œä¸º reward æƒ©ç½šï¼Œç›¸å½“äºåœ¨ä¼˜åŒ–ä¸€ä¸ªã€Œé”™è¯¯çš„æ··åˆç›®æ ‡ã€ï¼š</p>
<ul>
  <li>æ—¢æƒ©ç½šåå‘ KLï¼ˆå¸Œæœ›ç­–ç•¥ä¸åç¦»å‚è€ƒï¼‰</li>
  <li>åˆ<strong>é”™è¯¯åœ°é¼“åŠ±æ­£å‘ KL å˜å¤§</strong>ï¼ˆå¸Œæœ›å‚è€ƒä¸è¦†ç›–ç­–ç•¥ï¼‰</li>
</ul>

<p>è¿™ä¸¤ä¸ªæ–¹å‘ç›¸äº’å†²çªï¼Œå¯èƒ½å¯¼è‡´ä¼˜åŒ–ä¸ç¨³å®šã€‚</p>

<p><strong>å®éªŒéªŒè¯</strong>ï¼šShah et al. (2025) çš„å®éªŒè¡¨æ˜ï¼Œåœ¨ on-policy RL å¾®è°ƒ LLM æ—¶ï¼š</p>
<ul>
  <li><strong>$k_1$ in reward</strong>ï¼šè®­ç»ƒç¨³å®š</li>
  <li><strong>$k_3$ in reward</strong>ï¼š<strong>è®­ç»ƒå´©æºƒ</strong></li>
</ul>

<p>è¿™ä¸æˆ‘ä»¬çš„ç†è®ºåˆ†æå®Œå…¨ä¸€è‡´ã€‚</p>

<h3 id="off-policy-åœºæ™¯ä¸‹çš„ç»“è®º">Off-policy åœºæ™¯ä¸‹çš„ç»“è®º</h3>

<p>ä¸Šè¿°åˆ†æå‡è®¾ on-policy é‡‡æ ·ã€‚åœ¨ off-policy åœºæ™¯ä¸‹ï¼Œç»“è®ºæ˜¯å¦æ”¹å˜ï¼Ÿ</p>

<p>è®¾æ ·æœ¬æ¥è‡ªè¡Œä¸ºç­–ç•¥ $\mu$ï¼Œä½¿ç”¨é‡è¦æ€§åŠ æƒçš„ç­–ç•¥æ¢¯åº¦ï¼š</p>

<p>$$
\nabla_\theta \tilde{J} = \mathbb{E}_\mu\left[\frac{q_\theta}{\mu} \cdot s_\theta \cdot (R - \beta \cdot k)\right]
$$</p>

<p>åˆ©ç”¨ $\mathbb{E}_\mu[\frac{q_\theta}{\mu} \cdot f] = \mathbb{E}_{q_\theta}[f]$ï¼Œä¸Šå¼ç­‰äºï¼š</p>

<p>$$
= \mathbb{E}_{q_\theta}[s_\theta \cdot R] - \beta \cdot \mathbb{E}_{q_\theta}[s_\theta \cdot k]
$$</p>

<p><strong>æ— åæ¡ä»¶</strong>ä»ç„¶æ˜¯ $\mathbb{E}_{q_\theta}[s_\theta \cdot k] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]$ï¼Œä¸ on-policy å®Œå…¨ç›¸åŒã€‚</p>

<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šåœ¨ off-policy ç­–ç•¥æ¢¯åº¦æ¡†æ¶ä¸‹ï¼Œé‡è¦æ€§æƒé‡ $\frac{q_\theta}{\mu}$ ä½œç”¨äºæ•´ä¸ªç­–ç•¥æ¢¯åº¦ä¼°è®¡å™¨ï¼Œ<strong>ä¸éœ€è¦å¯¹ shaped reward ä¸­çš„ KL ä¼°è®¡å™¨å•ç‹¬åŠ æƒ</strong>ã€‚å› æ­¤ï¼š</p>

<ul>
  <li>Shaped reward ä¿æŒåŸå½¢å¼ï¼š$\tilde{R} = R - \beta \cdot k_1$ï¼ˆä¸æ˜¯ $R - \beta \cdot \frac{q_\theta}{\mu} k_1$ï¼‰</li>
  <li>ç»“è®ºä¸ on-policy ç›¸åŒï¼š<strong>åªèƒ½ç”¨ $k_1$ï¼Œä¸èƒ½ç”¨ $k_3$</strong></li>
</ul>

<h3 id="å…³é”®å‘ç°åªæœ‰-inlmath391mathend-å¯ç”¨äº-reward-æƒ©ç½š">å…³é”®å‘ç°ï¼šåªæœ‰ $k_1$ å¯ç”¨äº Reward æƒ©ç½š</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">æ•°å€¼æ— åï¼Ÿ</th>
      <th style="text-align: center">ä½œä¸º Reward æƒ©ç½šæ—¶æ¢¯åº¦æ— åï¼Ÿ</th>
      <th style="text-align: center">å®é™…è¡¨ç°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">ç¨³å®š</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">âœ—</td>
      <td style="text-align: center">å´©æºƒ</td>
    </tr>
  </tbody>
</table>

<p><strong>æ ¸å¿ƒæ•™è®­</strong>ï¼šè¯„ä»· KL ä¼°è®¡å™¨æ—¶ï¼Œã€Œæ•°å€¼æ— åã€å’Œã€Œæ¢¯åº¦æ­£ç¡®ã€æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç»´åº¦ã€‚å¯¹äº reward æƒ©ç½šåœºæ™¯ï¼ˆæ— è®º on-policy è¿˜æ˜¯ off-policyï¼‰ï¼Œ<strong>åªæœ‰ $k_1$ æ˜¯æ­£ç¡®çš„é€‰æ‹©</strong>ã€‚$k_3$ è™½ç„¶æ•°å€¼æ— åä¸”æ–¹å·®æ›´ä½ï¼Œä½†ä½œä¸º reward æƒ©ç½šä¼šå¯¼è‡´æ¢¯åº¦æœ‰åï¼Œå¯èƒ½å¼•å‘è®­ç»ƒå´©æºƒã€‚</p>

<h2 id="å®è·µæŒ‡å—ä¸å¸¸è§é™·é˜±">å®è·µæŒ‡å—ä¸å¸¸è§é™·é˜±</h2>

<p>æœ‰äº†å‰é¢çš„ç†è®ºåˆ†æï¼Œæœ¬èŠ‚ç»™å‡ºå…·ä½“åœºæ™¯ä¸‹çš„é€‰å‹å»ºè®®ï¼Œæ–¹ä¾¿ç›´æ¥æŸ¥é˜…ã€‚</p>

<h3 id="é€‰å‹é€ŸæŸ¥è¡¨">é€‰å‹é€ŸæŸ¥è¡¨</h3>

<p>ä¸‹è¡¨æŒ‰ã€Œç›®æ ‡ KL æ–¹å‘ã€Ã—ã€Œé‡‡æ ·æ¥æºã€Ã—ã€Œä½¿ç”¨æ–¹å¼ã€ä¸‰ä¸ªç»´åº¦ç»™å‡ºæ¨èçš„ä¼°è®¡å™¨é€‰æ‹©ã€‚å…¶ä¸­ã€Œç”¨äº <strong>Loss</strong>ã€å¯¹åº” KL ä½œä¸º lossï¼ˆéœ€è¦åä¼ æ¢¯åº¦ï¼‰ï¼Œã€Œç”¨äº <strong>Reward</strong>ã€å¯¹åº” KL ä½œä¸º reward æƒ©ç½šï¼ˆstop-gradientï¼‰ã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç›®æ ‡</th>
      <th style="text-align: center">é‡‡æ ·æ¥æº</th>
      <th style="text-align: center">ç”¨äº Lossï¼ˆloss æ¢¯åº¦å›ä¼ ï¼‰</th>
      <th style="text-align: center">ç”¨äº Rewardï¼ˆstop-gradï¼‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">åå‘ KL $D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">$q$ï¼ˆon-policyï¼‰</td>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">$k_1$</td>
    </tr>
    <tr>
      <td style="text-align: center">åå‘ KL $D_{\mathrm{KL}}(q \| p)$</td>
      <td style="text-align: center">$\mu$ï¼ˆoff-policyï¼‰</td>
      <td style="text-align: center">$\frac{q}{\mu} k_3$ æˆ– $\text{sg}\left(\frac{q}{\mu}\right) k_2$</td>
      <td style="text-align: center">$k_1$</td>
    </tr>
    <tr>
      <td style="text-align: center">æ­£å‘ KL $D_{\mathrm{KL}}(p \| q)$</td>
      <td style="text-align: center">$q$</td>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">$\mathbb{E}_q\left[\frac{p}{q} \log \frac{p}{q}\right]$</td>
    </tr>
  </tbody>
</table>

<h3 id="kl-ä½œä¸º-losséœ€è¦-loss-æ¢¯åº¦å›ä¼ ">KL ä½œä¸º Lossï¼ˆéœ€è¦ loss æ¢¯åº¦å›ä¼ ï¼‰</h3>

<p>å½“ KL ä½œä¸º loss çš„ä¸€éƒ¨åˆ†å‚ä¸åä¼ æ—¶ï¼Œå¿…é¡»è€ƒè™‘æ¢¯åº¦çš„æ­£ç¡®æ€§ã€‚</p>

<h4 id="on-policyä¼˜åŒ–åå‘-klæœ€å¸¸è§åœºæ™¯">On-policyï¼šä¼˜åŒ–åå‘ KLï¼ˆæœ€å¸¸è§åœºæ™¯ï¼‰</h4>

<p>ç›®æ ‡ï¼šæ§åˆ¶ actor ä¸åç¦» reference policyã€‚</p>

<p><strong>æ­£ç¡®åšæ³•</strong>ï¼šä½¿ç”¨ <strong>$k_2$</strong> ä½œä¸º lossã€‚</p>

<p>$$
\mathcal{L}_{k_2} = \frac{1}{2}\left(\log \frac{p}{q}\right)^2
$$</p>

<p>å…¶æ¢¯åº¦æœŸæœ› $\mathbb{E}_q[\nabla k_2] = \nabla_\theta D_{\mathrm{KL}}(q \| p)$ æ­£æ˜¯åå‘ KL çš„çœŸæ¢¯åº¦ã€‚</p>

<h4 id="on-policyä¼˜åŒ–æ­£å‘-klè¦†ç›–å‹åœºæ™¯">On-policyï¼šä¼˜åŒ–æ­£å‘ KLï¼ˆè¦†ç›–å‹åœºæ™¯ï¼‰</h4>

<p>ç›®æ ‡ï¼šè®©ç­–ç•¥è¦†ç›–å‚è€ƒåˆ†å¸ƒçš„æ”¯æ’‘é›†ï¼ˆå¦‚ç¦»çº¿ RLã€æ¨¡ä»¿å­¦ä¹ ç­‰ï¼‰ã€‚</p>

<p><strong>æ­£ç¡®åšæ³•</strong>ï¼šä½¿ç”¨ <strong>$k_3$</strong> ä½œä¸º lossã€‚</p>

<p>$$
\mathbb{E}_q[\nabla k_3] = \mathbb{E}_q\left[\left(1-\frac{p}{q}\right) \cdot s_\theta\right] = \nabla_\theta D_{\mathrm{KL}}(p \| q)
$$</p>

<p>ç›´æ¥å¯¹ $k_3$ çš„æ ·æœ¬å‡å€¼è°ƒç”¨ loss æ¢¯åº¦å›ä¼ ï¼Œè‡ªåŠ¨å¾®åˆ†è®¡ç®—çš„å°±æ˜¯ $\mathbb{E}_q[\nabla_\theta k_3]$ï¼Œå³æ­£å‘ KL çš„æ¢¯åº¦ï¼Œæ— éœ€é¢å¤–å¤„ç†ã€‚</p>

<h4 id="off-policyä¼˜åŒ–åå‘-kl">Off-policyï¼šä¼˜åŒ–åå‘ KL</h4>

<p>ç›®æ ‡ï¼šæ•°æ®æ¥è‡ªè¡Œä¸ºç­–ç•¥ $\mu$ï¼Œä»å¸Œæœ›ä¼˜åŒ–åå‘ KLã€‚</p>

<p><strong>æ¨èåšæ³•</strong>ï¼šä½¿ç”¨ <strong>$\dfrac{q_\theta}{\mu} k_3$</strong> æˆ– <strong>$\text{sg}\left(\dfrac{q_\theta}{\mu}\right) k_2$</strong> ä½œä¸º lossï¼ˆä¸¤è€…æ¢¯åº¦å®Œå…¨ç­‰ä»·ï¼‰ã€‚</p>

<p>$$
\mathcal{L} = \dfrac{q_\theta(x)}{\mu(x)} \cdot \left(\dfrac{p(x)}{q_\theta(x)} - 1 - \log \dfrac{p(x)}{q_\theta(x)}\right)
$$</p>

<p>æˆ–</p>

<p>$$
\mathcal{L} = \text{sg}\left(\dfrac{q_\theta(x)}{\mu(x)}\right) \cdot \dfrac{1}{2}\left(\log \dfrac{p(x)}{q_\theta(x)}\right)^2
$$</p>

<ul>
  <li>æ¢¯åº¦æ— å</li>
  <li>åœ¨ $q_\theta \approx p$ æ—¶æ–¹å·®éƒ½æ˜¾è‘—æ›´ä½</li>
</ul>

<p><strong>å¤‡é€‰æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨ $\dfrac{q_\theta}{\mu} k_1$ï¼ˆæ¢¯åº¦åŒæ ·æ— åï¼Œä½†æ–¹å·®æ›´é«˜ï¼‰</p>

<p><strong>é¿å…</strong>ï¼šä½¿ç”¨ $\dfrac{q_\theta}{\mu} k_2$ï¼ˆæƒé‡å‚ä¸æ¢¯åº¦è®¡ç®—ï¼‰â€”â€”æ¢¯åº¦æœ‰åï¼Œä¸æ˜¯åå‘ KL çš„æ­£ç¡®æ–¹å‘</p>

<h3 id="kl-ä½œä¸º-reward-æƒ©ç½šstop-gradient">KL ä½œä¸º Reward æƒ©ç½šï¼ˆstop-gradientï¼‰</h3>

<p>å½“ KL ä½œä¸ºæ ‡é‡æƒ©ç½šåŠ å…¥ reward æƒ©ç½šæ—¶ï¼Œè™½ç„¶ KL é¡¹æœ¬èº«ä¸åä¼ æ¢¯åº¦ï¼Œä½†å®ƒä¼šé€šè¿‡ advantage é—´æ¥å½±å“ç­–ç•¥æ¢¯åº¦ã€‚æ ¹æ®å‰æ–‡ã€Œä½œä¸º Rewardï¼šæ•°å€¼æ— å â‰  æ¢¯åº¦æ­£ç¡®ã€çš„åˆ†æï¼š</p>

<p><strong>æ¨è</strong>ï¼š</p>
<ul>
  <li>ä½¿ç”¨ <strong>$k_1$</strong>ï¼ˆæ•°å€¼æ— åï¼Œä¸”è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦ä¹Ÿæ— åï¼‰</li>
  <li>æ— è®º on-policy è¿˜æ˜¯ off-policyï¼Œç»“è®ºç›¸åŒ</li>
</ul>

<p><strong>é¿å…</strong>ï¼š</p>
<ul>
  <li>ä½¿ç”¨ $k_3$ï¼ˆè™½ç„¶æ•°å€¼æ— åä¸”æ–¹å·®æ›´ä½ï¼Œä½†è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æœ‰åï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒå´©æºƒï¼‰</li>
</ul>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šOff-policy ç­–ç•¥æ¢¯åº¦ä¸­ï¼Œé‡è¦æ€§æƒé‡ $\frac{q_\theta}{\mu}$ ä½œç”¨äºæ•´ä¸ª $s_\theta \cdot \tilde{R}$ï¼Œshaped reward æœ¬èº«ä¿æŒ $\tilde{R} = R - \beta \cdot k_1$ å½¢å¼å³å¯ã€‚</p>
</blockquote>

<h3 id="é™·é˜±ä¸€on-policy-ä¸‹ç”¨-inlmath425mathend-ä½œä¸º-loss">é™·é˜±ä¸€ï¼šOn-policy ä¸‹ç”¨ $k_1$ ä½œä¸º Loss</h3>

<p>$k_1$ çš„æ¢¯åº¦æœŸæœ›æ’ä¸ºé›¶ï¼ˆ$\mathbb{E}_q[\nabla k_1] = \mathbb{E}_q[s_\theta] = 0$ï¼‰ï¼Œä½œä¸º loss å®Œå…¨æ— æ•ˆã€‚</p>

<blockquote>
  <p><strong>è§£å†³</strong>ï¼šon-policy ä¼˜åŒ–åå‘ KL ç”¨ $k_2$ï¼›ä¼˜åŒ–æ­£å‘ KL ç”¨ $k_3$ã€‚</p>
</blockquote>

<h3 id="é™·é˜±äºŒæ··æ·†-inlmath430mathend-çš„æ•°å€¼æ— åä¸æ¢¯åº¦è¡Œä¸º">é™·é˜±äºŒï¼šæ··æ·† $k_3$ çš„æ•°å€¼æ— åä¸æ¢¯åº¦è¡Œä¸º</h3>

<p>$k_3$ å¯¹<strong>åå‘ KL çš„æ•°å€¼</strong>æ˜¯æ— åä¼°è®¡ï¼Œä½†å®ƒçš„<strong>æ¢¯åº¦</strong>å¯¹åº”çš„æ˜¯<strong>æ­£å‘ KL</strong>â€”â€”è¿™ä¸¤è€…å®Œå…¨ä¸åŒã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">åœºæ™¯</th>
      <th style="text-align: center">é—®é¢˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">ç”¨ $k_3$ ä½œä¸º Lossï¼ˆç›®æ ‡æ˜¯åå‘ KLï¼‰</td>
      <td style="text-align: center">$\nabla k_3$ å¯¹åº”æ­£å‘ KLï¼Œä½ åœ¨ä¼˜åŒ–é”™è¯¯çš„æ–¹å‘</td>
    </tr>
    <tr>
      <td style="text-align: center">ç”¨ $k_3$ ä½œä¸º Reward æƒ©ç½šï¼ˆç›®æ ‡æ˜¯åå‘ KLï¼‰</td>
      <td style="text-align: center">è¯±å¯¼å‡ºæœ‰åç­–ç•¥æ¢¯åº¦ï¼ˆåå·®é¡¹ $-\nabla D_{\mathrm{KL}}(p\|q)$ï¼‰ï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒå´©æºƒ</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>è§£å†³</strong>ï¼š</p>
  <ul>
    <li>ç”¨ä½œ <strong>Loss</strong> ä¼˜åŒ–åå‘ KL â†’ ç”¨ $k_2$ï¼›ä¼˜åŒ–æ­£å‘ KL æ‰ç”¨ $k_3$</li>
    <li>ç”¨ä½œ <strong>Reward</strong> æƒ©ç½š â†’ åªç”¨ $k_1$ï¼ˆæ— è®º on-policy è¿˜æ˜¯ off-policyï¼‰</li>
  </ul>
</blockquote>

<h3 id="é™·é˜±ä¸‰off-policy-ä¸‹å¯¹é‡è¦æ€§æƒé‡çš„-detach-å¤„ç†">é™·é˜±ä¸‰ï¼šOff-policy ä¸‹å¯¹é‡è¦æ€§æƒé‡çš„ detach å¤„ç†</h3>

<p>Off-policy åœºæ™¯ä¸‹ï¼Œæ˜¯å¦å¯¹é‡è¦æ€§æƒé‡ $w = q_\theta / \mu$ è¿›è¡Œ detach ä¼šå¯¼è‡´å®Œå…¨ä¸åŒçš„ç»“æœã€‚ä¸‹è¡¨æ€»ç»“äº†æ­£ç¡®çš„ detach ç­–ç•¥ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">æ˜¯å¦ detach $w$</th>
      <th style="text-align: center">æ¢¯åº¦å¯¹åº”çš„ç›®æ ‡</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$w k_1$</td>
      <td style="text-align: center">ä¸ detach</td>
      <td style="text-align: center">åå‘ KL âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$w k_3$</td>
      <td style="text-align: center">ä¸ detach</td>
      <td style="text-align: center">åå‘ KL âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$w k_2$</td>
      <td style="text-align: center">ä¸ detach</td>
      <td style="text-align: center">f-æ•£åº¦ âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\text{sg}(w) k_2$</td>
      <td style="text-align: center">detach</td>
      <td style="text-align: center">åå‘ KL âœ“</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>è§£å†³</strong>ï¼šoff-policy ä¼˜åŒ–åå‘ KLï¼Œæ¨èä½¿ç”¨ $w k_3$ æˆ– $\text{sg}(w) k_2$ï¼ˆä¸¤è€…æ¢¯åº¦ç­‰ä»·ï¼‰ã€‚è‹¥ä½¿ç”¨ $w k_1$ï¼Œæ¢¯åº¦æ— åä½†æ–¹å·®æ›´é«˜ã€‚</p>
</blockquote>

<h3 id="é™·é˜±å››åœ¨-reward-æƒ©ç½šä¸­ä½¿ç”¨-inlmath448mathend">é™·é˜±å››ï¼šåœ¨ Reward æƒ©ç½šä¸­ä½¿ç”¨ $k_3$</h3>

<p>$k_3$ è™½ç„¶å¯¹åå‘ KL æ•°å€¼æ— åä¸”æ–¹å·®æ›´ä½ï¼Œä½†ä½œä¸º reward æƒ©ç½šä¼šå¯¼è‡´ç­–ç•¥æ¢¯åº¦æœ‰åï¼ˆåå·®é¡¹ $-\nabla D_{\mathrm{KL}}(p\|q)$ï¼‰ï¼Œå¯èƒ½å¼•å‘è®­ç»ƒå´©æºƒã€‚</p>

<blockquote>
  <p><strong>è§£å†³</strong>ï¼šæ— è®º on-policy è¿˜æ˜¯ off-policyï¼Œreward æƒ©ç½šåªç”¨ $k_1$ã€‚</p>
</blockquote>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æœ¬æ–‡å›´ç»•ã€Œ<strong>ä»è°é‡‡æ ·</strong>ã€ã€Œ<strong>ä¼°è®¡è°çš„å€¼</strong>ã€ã€Œ<strong>å¯¹è°æ±‚æ¢¯åº¦</strong>ã€ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œç³»ç»Ÿåœ°å‰–æäº† $k_1, k_2, k_3$ ä¸‰ç§ KL ä¼°è®¡å™¨ã€‚</p>

<p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p>

<ol>
  <li><strong>å…ˆæ˜ç¡®ä½¿ç”¨æ–¹å¼</strong>ï¼šKL ä½œä¸º Lossï¼ˆloss æ¢¯åº¦å›ä¼ ï¼‰è¿˜æ˜¯ä½œä¸º Rewardï¼ˆstop-gradï¼‰ï¼Ÿ</li>
  <li><strong>KL ä½œä¸º Lossï¼ˆon-policyï¼‰</strong>ï¼šä¼˜åŒ–åå‘ KL ç”¨ $k_2$ï¼›ä¼˜åŒ–æ­£å‘ KL ç”¨ $k_3$</li>
  <li><strong>KL ä½œä¸º Lossï¼ˆoff-policyï¼‰</strong>ï¼šç”¨ $\frac{q}{\mu} k_3$ æˆ– $\text{sg}\left(\frac{q}{\mu}\right) k_2$ï¼ˆæ³¨æ„ detach ç­–ç•¥ï¼ï¼‰</li>
  <li><strong>KL ä½œä¸º Reward</strong>ï¼šåªç”¨ $k_1$ï¼ˆ$k_3$ è™½ç„¶æ•°å€¼æ— åä½†ä¼šå¯¼è‡´ç­–ç•¥æ¢¯åº¦æœ‰åï¼‰</li>
</ol>

<p>æŠŠè¿™å‡ ç‚¹æ¢³ç†æ¸…æ¥šï¼Œä¸‰ç§ä¼°è®¡å™¨å°±ä¸å†è®©äººæ··æ·†äº†ã€‚</p>

<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>

<ol>
  <li>
    <p>Dibya Ghosh. â€œKL Divergence for Machine Learningâ€. <a href="https://dibyaghosh.com/blog/probability/kldivergence">https://dibyaghosh.com/blog/probability/kldivergence</a></p>
  </li>
  <li>
    <p>John Schulman. â€œApproximating KL Divergenceâ€. <a href="https://joschu.net/blog/kl-approx.html">https://joschu.net/blog/kl-approx.html</a></p>
  </li>
  <li>
    <p>Verl Documentation. â€œProximal Policy Optimization (PPO)â€. <a href="https://verl.readthedocs.io/en/latest/algo/ppo.html">https://verl.readthedocs.io/en/latest/algo/ppo.html</a></p>
  </li>
  <li>
    <p>åˆä¸ƒ123334. RLHF/RLVR è®­ç»ƒä¸­çš„ KL è¿‘ä¼¼æ–¹æ³•æµ…æï¼ˆk1 / k2 / k3ï¼‰. <a href="https://zhuanlan.zhihu.com/p/1966872846212010437">https://zhuanlan.zhihu.com/p/1966872846212010437</a></p>
  </li>
  <li>
    <p>Kezhao Liu, Jason Klein Liu, Mingtao Chen, Yiming Liu. â€œRethinking KL Regularization in RLHF: From Value Estimation to Gradient Optimizationâ€. <a href="https://arxiv.org/abs/2510.01555">https://arxiv.org/abs/2510.01555</a></p>
  </li>
  <li>
    <p>Yifan Zhang, Yiping Ji, Gavin Brown, et al. â€œOn the Design of KL-Regularized Policy Gradient Algorithms for LLM Reasoningâ€. <a href="https://arxiv.org/abs/2505.17508">https://arxiv.org/abs/2505.17508</a></p>
  </li>
  <li>
    <p>Vedant Shah, Johan Obando-Ceron, Vineet Jain, Brian Bartoldson, Bhavya Kailkhura, Sarthak Mittal, Glen Berseth, Pablo Samuel Castro. â€œA Comedy of Estimators: On KL Regularization in RL Training of LLMsâ€. <a href="https://arxiv.org/abs/2512.21852">https://arxiv.org/abs/2512.21852</a></p>
  </li>
</ol>

<div class="language-bibtex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">@misc</span><span class="p">{</span><span class="nl">WangZhang2025KLEstimators</span><span class="p">,</span>
  <span class="na">author</span>       <span class="p">=</span> <span class="s">{Wang, Xihuai and Zhang, Shao}</span><span class="p">,</span>
  <span class="na">title</span>        <span class="p">=</span> <span class="s">{Understanding KL Divergence Estimators in RL: From Value Approximation to Gradient Estimation}</span><span class="p">,</span>
  <span class="na">year</span>         <span class="p">=</span> <span class="s">{2025}</span><span class="p">,</span>
  <span class="na">month</span>        <span class="p">=</span> <span class="nv">dec</span><span class="p">,</span>
  <span class="na">day</span>          <span class="p">=</span> <span class="s">{01}</span><span class="p">,</span>
  <span class="na">url</span>          <span class="p">=</span> <span class="s">{https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-en.html}</span>
<span class="p">}</span>
</code></pre></div></div>

      </article>

      

      
        
      </div>

    <div class="col-lg-3 d-none d-lg-block toc-sidebar-col">
      <aside class="toc-sidebar" data-toc-sidebar id="toc-sidebar">
  <div class="toc-sidebar__header">
    <div class="toc-sidebar__title">ç›®å½•</div>
    <button class="toc-toggle-btn" aria-label="Toggle table of contents" aria-expanded="false" aria-controls="toc-content" data-toc-toggle>
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
  <nav
    id="toc-content"
    class="toc js-page-toc"
    data-toc
    data-toc-content=".toc-content"
    data-toc-headings="h2,h3"
    data-toc-min-items="2"
    aria-label="ç›®å½•"
  ></nav>
</aside>

<!-- Collapsed TOC toggle button (shown when TOC is collapsed) -->
<button class="toc-collapsed-toggle" aria-label="Show table of contents" aria-expanded="false" aria-controls="toc-content" data-toc-expand>
  <i class="fas fa-list"></i>
</button>


    </div>
  </div>
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        &copy; Copyright 2026 Xihuai Leo Wang. Last updated: January 07, 2026.
      </div>
    </footer>


    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/blog_enhancements.js" type="text/javascript"></script>
  <script defer src="/assets/js/sidenotes.js" type="text/javascript"></script>
  <script defer src="/assets/js/footnote_preview.js" type="text/javascript"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>
  <script defer src="/assets/js/toc.js" type="text/javascript"></script>
  <script defer src="/assets/js/venue_filter.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax 3.x with comprehensive configuration -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams',
        // Support all common math delimiters
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        processRefs: true,
        // Common macros for convenience
        macros: {
          RR: '\\mathbb{R}',
          NN: '\\mathbb{N}',
          ZZ: '\\mathbb{Z}',
          CC: '\\mathbb{C}',
          EE: '\\mathbb{E}',
          PP: '\\mathbb{P}',
          bm: ['\\boldsymbol{#1}', 1],
          argmax: '\\operatorname*{arg\\,max}',
          argmin: '\\operatorname*{arg\\,min}',
          sgn: '\\operatorname{sgn}',
          KL: '\\mathrm{KL}',
          Var: '\\operatorname{Var}',
          Cov: '\\operatorname{Cov}',
          tr: '\\operatorname{tr}',
          diag: '\\operatorname{diag}'
        },
        // AMS packages
        packages: {'[+]': ['ams', 'boldsymbol', 'newcommand']}
      },
      loader: {
        load: ['[tex]/ams', '[tex]/boldsymbol', '[tex]/newcommand']
      },
      options: {
        // Skip math rendering in these HTML elements
        skipHtmlTags: [
          'script', 'noscript', 'style', 'textarea', 'pre', 'code',
          'annotation', 'annotation-xml', 'kbd', 'samp', 'var'
        ],
        // Fix issues with underscores being converted to <em> by HTML
        processHtmlClass: 'mathjax-process',
        ignoreHtmlClass: 'tex2jax_ignore|no-mathjax',
        // Render math even with HTML entities
        renderActions: {
          findScript: [10, function (doc) {
            // Pre-process to fix HTML entity issues in math
            for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            }
          }, '']
        }
      },
      svg: {
        fontCache: 'global',
        scale: 1.0
      },
      chtml: {
        scale: 1.0,
        matchFontHeight: true
      },
      startup: {
        ready: function () {
          MathJax.startup.defaultReady();
          // Fix: restore underscores that might have been converted to <em>
          MathJax.startup.promise.then(() => {
            console.log('MathJax typesetting complete');
          });
        }
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  
  <!-- Pre-processing script to protect math from Markdown/HTML interference -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fix underscores in math that were converted to <em> by Markdown
      function fixMathUnderscores() {
        const mathContainers = document.querySelectorAll('.MathJax, .MathJax_Display, mjx-container');
        // This runs before MathJax, so we need to fix raw content
        const content = document.querySelector('.post-content, article');
        if (!content) return;
        
        // Find math delimiters and restore any <em> or <strong> inside them
        const html = content.innerHTML;
        
        // Pattern to find math blocks and restore underscore formatting
        // This is a fallback; the main protection is in the Jekyll plugin
      }
      
      // Fix HTML entities in display math blocks
      function fixHtmlEntities() {
        document.querySelectorAll('.language-plaintext.highlighter-rouge').forEach(el => {
          // Check if this looks like an HTML figure that wasn't rendered
          const text = el.textContent;
          if (text.includes('<img') || text.includes('<figure') || text.includes('<figcaption')) {
            // This is raw HTML that should be rendered - replace with actual HTML
            const temp = document.createElement('div');
            temp.innerHTML = text;
            el.replaceWith(...temp.childNodes);
          }
        });
      }
      
      fixHtmlEntities();
    });
  </script>

    <!-- Pseudocode -->
  <script defer src="https://cdn.jsdelivr.net/npm/pseudocode@2.4.1/build/pseudocode.min.js" integrity="sha256-aVkDxqyzrB+ExUsOY9PdyelkDhn/DfrjWu08aVpqNlo=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/pseudocode-init.js" type="text/javascript"></script>
    <!-- Mermaid -->
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>
  <script defer src="/assets/js/mermaid-init.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2923RQZBXG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-2923RQZBXG');
  </script>
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar,
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    // Use the CSS-defined padding-top value to avoid layout shift
    // The navbar height is already handled by CSS: body.fixed-top-nav { padding-top: 50px; }
    let navbarHeight = $("#navbar").outerHeight(true) || 50;
    // Only set progressBar position, don't override body padding to avoid layout shift
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
