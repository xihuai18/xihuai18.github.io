<!DOCTYPE html><html lang="zh-CN">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡ | Xihuai Wang's Page</title>
    <meta name="author" content="Xihuai Leo Wang" />
    <meta name="description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1ã€k2ã€k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶æä¾›åœ¨ã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€ä¸¤ç§æƒ…å†µä¸‹çš„é€‰å‹æŒ‡å—ã€‚" />
    <meta name="keywords" content="Reinforcement Learning, Multi-agent System, Language Model" />

    <!-- OpenGraph -->
    <meta property="og:site_name" content="Xihuai Wang's Page" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-12-01T00:00:00+00:00" /><meta property="article:author" content="Xihuai Leo Wang" /><meta property="og:title" content="ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡" />
    <meta property="og:url" content="https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-zh.html" />
    <meta property="og:description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1ã€k2ã€k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶æä¾›åœ¨ã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€ä¸¤ç§æƒ…å†µä¸‹çš„é€‰å‹æŒ‡å—ã€‚" /><meta property="og:image" content="https://xihuai18.github.io/assets/img/kl-estimators/kl-estimator.png" />
    <meta property="og:image:secure_url" content="https://xihuai18.github.io/assets/img/kl-estimators/kl-estimator.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡" /><meta property="og:locale" content="zh_CN" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡" />
    <meta name="twitter:description" content="åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1ã€k2ã€k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶æä¾›åœ¨ã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€ä¸¤ç§æƒ…å†µä¸‹çš„é€‰å‹æŒ‡å—ã€‚" /><meta name="twitter:image" content="https://xihuai18.github.io/assets/img/kl-estimators/kl-estimator.png" />
    <meta name="twitter:image:alt" content="ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡" />
    

    <!-- Schema.org -->
    <script type="application/ld+json">
      {
        "author":
        {
          "@type": "Person",
          "name": "Xihuai Leo Wang"
        },
        "url": "https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-zh.html",
        "@type": "WebSite",
        "description": "åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ k1ã€k2ã€k3 çš„æ€§è´¨å·®å¼‚ï¼Œæ¶µç›– on-policy ä¸ off-policy ä¸¤ç§åœºæ™¯ï¼Œå¹¶æä¾›åœ¨ã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€ä¸¤ç§æƒ…å†µä¸‹çš„é€‰å‹æŒ‡å—ã€‚",
        "headline": "ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡",
        "sameAs": ["https://scholar.google.com/citations?user=hy6v3qUAAAAJ", "https://github.com/xihuai18"],
        "name": "Xihuai Leo Wang",
        "@context": "https://schema.org"
      }
    </script>


    <!-- DNS Prefetch & Preconnect for faster external resource loading -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&display=swap">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light" /><!-- Pseudocode -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pseudocode@2.4.1/build/pseudocode.min.css" integrity="sha256-VwMV//xgBPDyRFVSOshhRhzJRDyBmIACniLPpeXNUdc=" crossorigin="anonymous"><!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-zh.html">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

    <!-- Prefetch/Preload for faster navigation -->
    <link rel="prefetch" href="/" as="document">
    <link rel="prefetch" href="/blog/" as="document">
    <link rel="prefetch" href="/publications/" as="document">
    <link rel="prefetch" href="/cv/" as="document">
    
    <!-- Instant.page for instant page loads on hover -->
    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module" defer></script>

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header --><header>

  <!-- Nav Bar -->
  <nav id="navbar"
    class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      <a class="navbar-brand title font-weight-lighter" href="/">Xihuai Wang's Page</a>
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>

      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">

          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">About</a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">Blog</a>
          </li>

          <!-- CV -->
          <!-- 
          <li class="nav-item ">
            <a class="nav-link" href="/assets/pdf/" target="_blank"
              rel="noopener noreferrer">cv</a>
          </li> -->
          <!-- Other pages -->
          <li class="nav-item ">
            <a class="nav-link" href="/publications/">Publications</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="/cv/">CV</a>
          </li>
          <!-- Toggle theme mode -->
          <li class="nav-item toggle-container">
            <button id="light-toggle" class="nav-link" title="Change theme">
              <i class="fas fa-moon"></i>
              <i class="fas fa-sun"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Scrolling Progress Bar -->
  <progress id="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post toc-layout">
  <header class="post-header">
    <h1 class="post-title">ç®€å•ç†è§£ RL ä¸­çš„ KL æ•£åº¦ä¼°è®¡å™¨ï¼šä»æ•°å€¼ä¼°è®¡åˆ°æ¢¯åº¦ä¼°è®¡</h1>
    <div class="post-meta-container">
      <div class="post-meta-row">
        <span class="post-date">
          <i class="far fa-calendar-alt"></i>
          December 1, 2025
        </span></div>
      <div class="post-tags-row">
        <a href="/blog/?year=2025" data-filter-link data-filter-type="year" data-filter-value="2025">
          ğŸ“… 2025
        </a>
          &nbsp; &middot; &nbsp;
          
            <a href="/blog/?category=reinforcement-learning" data-filter-link data-filter-type="category" data-filter-value="reinforcement-learning">
              ğŸ·ï¸ reinforcement-learning
            </a>
            
          
      </div>
    </div>
  </header>

  <div class="post-links">
  

  <!-- Bilingual Links -->
  

  

  <!-- External Platform Links -->
  

  

  <!-- External Source (from plugin) -->
  

  <!-- Output links -->
  
    <a href="/reinforcement-learning/2025/12/01/kl-estimators-en.html">English Version</a>
  
    <a href="https://zhuanlan.zhihu.com/p/1978993413425763764" target="_blank">çŸ¥ä¹ <img src="/assets/img/icons/zhihu.ico" style="height: 1em; vertical-align: middle;"></a>
  
    <a href="https://mp.weixin.qq.com/s/VD_NBty5na4PfAa7wLoGAw" target="_blank">å¾®ä¿¡å…¬ä¼—å· <img src="/assets/img/icons/wechat.png" style="height: 1em; vertical-align: middle;"></a>
  
</div>


  <div class="row">
    
      <div class="col-lg toc-content">
    

      <article class="post-content">
        <p><img src="/assets/img/kl-estimators/kl-estimator.png" alt="Mini-class" style="display:block;margin:0 auto;width:95%;max-width:100%;" /></p>

<blockquote>
  <p>åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒKL æ•£åº¦çš„ä¼°è®¡æ–¹å¼ç›´æ¥å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡ç³»ç»Ÿå‰–æä¸‰ç§ç»å…¸ä¼°è®¡å™¨ $k_1, k_2, k_3$ åœ¨ on-policy å’Œ off-policy åœºæ™¯ä¸‹çš„æ€§è´¨å·®å¼‚ï¼Œå¹¶æä¾›åœ¨ã€Œç”¨äº loss æ¢¯åº¦å›ä¼ ã€ä¸ã€Œç”¨äº reward æƒ©ç½šã€ä¸¤ç§æƒ…å†µä¸‹çš„é€‰å‹æŒ‡å—ã€‚</p>
</blockquote>

<h2 id="å¼•è¨€kl-æ•£åº¦kullback-leibleræ•£åº¦åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²">å¼•è¨€ï¼šKL æ•£åº¦ï¼ˆKullback-Leibleræ•£åº¦ï¼‰åœ¨å¼ºåŒ–å­¦ä¹ ä¸­çš„è§’è‰²</h2>

<p>åœ¨ç­–ç•¥ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–PPOã€GRPOï¼ˆGroup Relative Policy Optimizationï¼‰ï¼‰æˆ–å¯¹é½è®­ç»ƒæ¡†æ¶ï¼ˆåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ RLHF/åŸºäºAIåé¦ˆçš„å¼ºåŒ–å­¦ä¹ RLAIFï¼‰ä¸­ï¼Œ<strong>KLæƒ©ç½šé¡¹</strong>ä½œä¸ºä¸€ç§æ­£åˆ™åŒ–æœºåˆ¶ï¼Œè¢«å¹¿æ³›åº”ç”¨äºçº¦æŸå½“å‰ç­–ç•¥ä½¿å…¶ä¸åç¦»å‚è€ƒç­–ç•¥ï¼Œä»è€Œæœ‰æ•ˆé˜²æ­¢è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸ç¨³å®šç°è±¡ä¹ƒè‡³ç­–ç•¥å´©æºƒã€‚ç„¶è€Œï¼ŒKLæƒ©ç½šé¡¹çš„å®ç°æ¶‰åŠå¤šä¸ªç»´åº¦çš„å†³ç­–ï¼š<strong>ä¼°è®¡å™¨çš„é€‰æ‹©</strong>ï¼ˆ$k_1$ã€$k_2$ã€$k_3$ï¼‰ã€<strong>é‡‡æ ·ç­–ç•¥çš„ç¡®å®š</strong>ï¼ˆåŒç­–ç•¥on-policyæˆ–å¼‚ç­–ç•¥off-policyï¼‰ã€ä»¥åŠ<strong>åº”ç”¨æ–¹å¼çš„é€‰æ‹©</strong>ï¼ˆä½œä¸ºæŸå¤±å‡½æ•°å‚ä¸æ¢¯åº¦å›ä¼ ï¼ŒæŠ‘æˆ–ä½œä¸ºå¥–åŠ±æƒ©ç½šé¡¹ï¼‰ã€‚æœ¬æ–‡æ—¨åœ¨ç³»ç»Ÿæ€§åœ°æ¢³ç†è¿™äº›å†³ç­–é€‰é¡¹åŠå…¶å†…åœ¨å…³è”ï¼Œä¸ºè¯»è€…å˜æ¸…ç›¸å…³æ ¸å¿ƒæ¦‚å¿µæä¾›ç†è®ºæ¡†æ¶å’Œå®è·µæŒ‡å¯¼ã€‚</p>

<h3 id="æ­£å‘-kl-ä¸åå‘-kl-çš„åŒºåˆ«">æ­£å‘ KL ä¸åå‘ KL çš„åŒºåˆ«</h3>

<p>è®¾ $q_\theta$ ä¸ºå½“å‰ actor ç­–ç•¥ï¼Œ$p$ ä¸ºå‚è€ƒç­–ç•¥ï¼Œä¸¤ç§æ–¹å‘çš„ KL æ•£åº¦åˆ†åˆ«ä¸ºï¼š</p>

<p><strong>åå‘ KLï¼ˆReverse KLï¼‰</strong>ï¼š
$$
D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{x \sim q_\theta}\left[\log \frac{q_\theta(x)}{p(x)}\right]
$$</p>

<figure style="text-align:center;">
  <img src="/assets/img/kl-estimators/kl-estimator-reverse.png" style="width:80%;max-width:100%;" />
  <figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://dibyaghosh.com/blog/probability/kldivergence/">Dibya Ghosh's Blog</a></figcaption>
</figure>

<p><strong>æ­£å‘ KLï¼ˆForward KLï¼‰</strong>ï¼š
$$
D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_{x \sim p}\left[\log \frac{p(x)}{q_\theta(x)}\right]
$$</p>

<figure style="text-align:center;">
  <img src="/assets/img/kl-estimators/kl-estimator-forward.png" style="width:80%;max-width:100%;" />
  <figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://dibyaghosh.com/blog/probability/kldivergence/">Dibya Ghosh's Blog</a></figcaption>
</figure>

<p><strong>ç›´è§‚è§£é‡Š</strong>ï¼š</p>

<ul>
  <li><strong>åå‘KL</strong>å…·æœ‰ã€Œæ¨¡å¼å¯»æ‰¾ã€ï¼ˆmode-seekingï¼‰ç‰¹æ€§ï¼Œå³ä¼˜åŒ–åçš„ç­–ç•¥å€¾å‘äºé›†ä¸­åœ¨å‚è€ƒåˆ†å¸ƒçš„é«˜æ¦‚ç‡åŒºåŸŸï¼Œä½†å¯èƒ½ä»¥ç‰ºç‰²å¤šæ ·æ€§ä¸ºä»£ä»·ã€‚</li>
  <li><strong>æ­£å‘KL</strong>è¡¨ç°å‡ºã€Œå…¨è¦†ç›–ã€ï¼ˆmass-coveringï¼‰ç‰¹æ€§ï¼Œå³ç­–ç•¥è¯•å›¾è¦†ç›–å‚è€ƒåˆ†å¸ƒçš„æ•´ä¸ªæ”¯æ’‘é›†ã€‚</li>
</ul>

<p>åœ¨RLHFçš„ä¸»æµå®ç°ä¸­ï¼Œ<strong>åå‘KL</strong>æ›´ä¸ºå¸¸ç”¨ï¼Œå…¶åŸå› åœ¨äºæˆ‘ä»¬é€šå¸¸æœŸæœ›actorç­–ç•¥ä¸è¿‡åº¦åç¦»å‚è€ƒç­–ç•¥ï¼Œè€Œéè¦æ±‚å…¶å®Œå…¨è¦†ç›–å‚è€ƒåˆ†å¸ƒçš„æ‰€æœ‰æ¨¡å¼ã€‚</p>

<h3 id="æœ¬æ–‡çš„æ ¸å¿ƒé—®é¢˜é‡‡æ ·æ¥æºä¼°è®¡ç›®æ ‡ä¸åº”ç”¨æ–¹å¼">æœ¬æ–‡çš„æ ¸å¿ƒé—®é¢˜ï¼šé‡‡æ ·æ¥æºã€ä¼°è®¡ç›®æ ‡ä¸åº”ç”¨æ–¹å¼</h3>

<p>åœ¨å…·ä½“å®ç°KLæƒ©ç½šæœºåˆ¶æ—¶ï¼Œå¿…é¡»æ˜ç¡®ä¸‰ä¸ªç›¸äº’å…³è”çš„æ ¸å¿ƒé—®é¢˜ï¼š</p>

<ol>
  <li><strong>é‡‡æ ·æ¥æº</strong>ï¼šæ ·æœ¬åº”æ¥è‡ªå½“å‰ç­–ç•¥ $q_\theta$ï¼ˆåŒç­–ç•¥on-policyï¼‰ï¼ŒæŠ‘æˆ–æ¥è‡ªè¡Œä¸ºç­–ç•¥ $\mu$ï¼ˆå¼‚ç­–ç•¥off-policyï¼‰ï¼Ÿ</li>
  <li><strong>ä¼°è®¡ç›®æ ‡</strong>ï¼šéœ€è¦ä¼°è®¡çš„æ˜¯åå‘KLæ•£åº¦ $D_{\mathrm{KL}}(q_\theta \| p)$ï¼Œè¿˜æ˜¯æ­£å‘KLæ•£åº¦ $D_{\mathrm{KL}}(p \| q_\theta)$ï¼Ÿ</li>
  <li><strong>åº”ç”¨æ–¹å¼</strong>ï¼šKLé¡¹åº”ä½œä¸ºæŸå¤±å‡½æ•°çš„ä¸€éƒ¨åˆ†å‚ä¸æ¢¯åº¦å›ä¼ ï¼Œè¿˜æ˜¯ä½œä¸ºå¥–åŠ±æƒ©ç½šé¡¹ï¼ˆåº”ç”¨stop-gradientæ“ä½œï¼‰ï¼Ÿ</li>
</ol>

<p>è¿™ä¸‰ä¸ªé—®é¢˜çš„ä¸åŒç»„åˆå†³å®šäº†åº”é€‰ç”¨ä½•ç§ä¼°è®¡å™¨ã€‚æœ¬æ–‡çš„ç›®æ ‡åœ¨äºç³»ç»Ÿæ€§åœ°æ¢³ç†è¿™äº›é€‰æ‹©åŠå…¶å†…åœ¨é€»è¾‘å…³è”ï¼Œä¸ºå®è·µåº”ç”¨æä¾›æ¸…æ™°çš„æŒ‡å¯¼æ¡†æ¶ã€‚</p>

<h2 id="å‡†å¤‡å·¥ä½œç¬¦å·ä¸åŸºæœ¬æ¦‚å¿µ">å‡†å¤‡å·¥ä½œï¼šç¬¦å·ä¸åŸºæœ¬æ¦‚å¿µ</h2>

<p>åœ¨æ·±å…¥åˆ†æä¹‹å‰ï¼Œæœ¬èŠ‚é¦–å…ˆç»Ÿä¸€æ–‡ä¸­ä½¿ç”¨çš„ç¬¦å·çº¦å®šï¼Œå¹¶æ¨å¯¼ä¸¤ä¸ªåœ¨åæ–‡ä¸­å°†åå¤ä½¿ç”¨çš„åŸºç¡€ç»“è®ºã€‚</p>

<h3 id="ç¬¦å·é‡‡æ ·åˆ†å¸ƒä¸è§£ææ¢¯åº¦">ç¬¦å·ã€é‡‡æ ·åˆ†å¸ƒä¸è§£ææ¢¯åº¦</h3>

<p><strong>ç¬¦å·çº¦å®š</strong></p>

<ul>
  <li>$q_\theta$ï¼šå½“å‰ actor ç­–ç•¥ï¼ˆå‚æ•°ä¸º $\theta$ï¼‰</li>
  <li>$q$ï¼šè‹¥æ— æ­§ä¹‰ï¼Œåæ–‡ç®€å†™ $q := q_\theta$</li>
  <li>$p$ï¼šå‚è€ƒç­–ç•¥ï¼ˆreference policyï¼‰ï¼Œä¸ä¾èµ–äº $\theta$</li>
  <li>$\mu$ï¼šè¡Œä¸ºç­–ç•¥ï¼ˆbehavior policyï¼‰ï¼Œç”¨äº off-policy é‡‡æ ·ï¼Œä¸ä¾èµ–äº $\theta$</li>
  <li>$s_\theta(x) = \nabla_\theta \log q_\theta(x)$ï¼šscore functionï¼ˆå¾—åˆ†å‡½æ•°ï¼‰</li>
  <li>$\text{sg}(\cdot)$ï¼šstop-gradient æ“ä½œï¼ˆåœ¨ä»£ç ä¸­å¯¹åº” <code class="language-plaintext highlighter-rouge">.detach()</code>ï¼‰</li>
</ul>

<h4 id="ç»Ÿä¸€çš„é‡‡æ ·ç­–ç•¥è§†è§’å¼•å…¥-inlmath89mathend-è®°å·">ç»Ÿä¸€çš„é‡‡æ ·ç­–ç•¥è§†è§’ï¼šå¼•å…¥ $\rho$ è®°å·</h4>

<p>åœ¨åˆ†æKLä¼°è®¡å™¨çš„æ¢¯åº¦æ€§è´¨æ—¶ï¼ŒåŒç­–ç•¥ï¼ˆon-policyï¼‰ä¸å¼‚ç­–ç•¥ï¼ˆoff-policyï¼‰åœºæ™¯çœ‹ä¼¼éœ€è¦åˆ†åˆ«å¤„ç†ï¼Œç„¶è€Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶æ¥è¿›è¡Œæè¿°ã€‚</p>

<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼•å…¥<strong>é‡‡æ ·ç­–ç•¥</strong> $\mu$ï¼Œå³æ•°æ®æ¥æºäºåˆ†å¸ƒ $x \sim \mu$ï¼Œå¹¶å®šä¹‰<strong>ç»Ÿä¸€çš„é‡è¦æ€§æƒé‡æ¯”ç‡</strong>ï¼š</p>

<p>$$
\rho(x) := \frac{q_\theta(x)}{\text{sg}(\mu(x))}
$$</p>

<p>æ­¤å®šä¹‰çš„å…³é”®åœ¨äºï¼š<strong>æ— è®ºåŒç­–ç•¥è¿˜æ˜¯å¼‚ç­–ç•¥åœºæ™¯ï¼Œæˆ‘ä»¬éƒ½å°†é‡‡æ ·ç­–ç•¥ $\mu$ è§†ä¸ºæ¢¯åº¦å¸¸æ•°</strong>ï¼ˆå³å¯¹ $\mu$ åº”ç”¨stop-gradientæ“ä½œï¼‰ã€‚</p>

<ul>
  <li><strong>å¼‚ç­–ç•¥ï¼ˆOff-policyï¼‰åœºæ™¯</strong>ï¼ˆ$\mu \neq q_\theta$ï¼‰ï¼šç”±äº $\mu$ æœ¬èº«ä¸ä¾èµ–äº $\theta$ï¼Œæ•… $\text{sg}(\mu) = \mu$ï¼Œæ­¤æ—¶ $\rho = \frac{q_\theta}{\mu}$ã€‚</li>
  <li><strong>åŒç­–ç•¥ï¼ˆOn-policyï¼‰åœºæ™¯</strong>ï¼ˆ$\mu = q_\theta$ï¼‰ï¼šä»¤ $\mu = q_\theta$ ä½†å¯¹å…¶åº”ç”¨stop-gradientæ“ä½œï¼Œåˆ™ $\rho = \frac{q_\theta}{\text{sg}(q_\theta)} \equiv 1$ï¼ˆæ•°å€¼æ’ä¸º1ï¼‰ï¼Œä½† $\nabla_\theta \rho = s_\theta \neq 0$ã€‚</li>
</ul>

<p><strong>å®ç°æ³¨æ„äº‹é¡¹</strong>ï¼šåœ¨åŒç­–ç•¥æƒ…å†µä¸‹ï¼Œå°½ç®¡æ•°å€¼ä¸Š $\rho\equiv 1$ï¼Œä½†å¿…é¡»åœ¨è®¡ç®—å›¾ä¸­æ˜¾å¼æ„é€  $\rho=\frac{q_\theta}{\text{sg}(q_\theta)}$ï¼ˆæˆ–ç­‰ä»·è¡¨ç¤ºä¸º $\rho=\exp(\log q_\theta-\text{sg}(\log q_\theta))$ï¼‰ã€‚è‹¥ç›´æ¥å°† $\rho$ è®¾ä¸ºå¸¸æ•°1ï¼Œåˆ™ä¼šä¸¢å¤±score-functionæ¢¯åº¦è·¯å¾„ï¼Œå¯¼è‡´æ¨å¯¼é€€åŒ–ä¸ºåæ–‡æ‰€è¿°çš„ã€Œæœ´ç´ åŒç­–ç•¥å®ç°ã€ã€‚</p>

<p><strong>æ ¸å¿ƒæ´å¯Ÿ</strong>ï¼š$\rho$ çš„ä½œç”¨åœ¨äºè¡¥å…¨ã€Œé‡‡æ ·åˆ†å¸ƒå¯¹å‚æ•° $\theta$ çš„ä¾èµ–ã€è¿™æ¡æ¢¯åº¦è·¯å¾„ã€‚åœ¨åŒç­–ç•¥æƒ…å†µä¸‹ï¼Œè¿™æ­£æ˜¯ã€Œå…ˆå–æœŸæœ›åæ±‚æ¢¯åº¦ã€ä¸ã€Œå…ˆæ±‚æ¢¯åº¦åå–æœŸæœ›ã€ä¸¤è€…å·®å¼‚çš„æ ¹æºï¼Œä¹Ÿæ˜¯ä¿®å¤è¿™ä¸€å·®å¼‚çš„å…³é”®æœºåˆ¶ã€‚</p>

<p>é€šè¿‡å¼•å…¥è¿™ä¸€ç»Ÿä¸€è®°å·ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŒç­–ç•¥ä¸å¼‚ç­–ç•¥çš„åˆ†æåˆå¹¶åˆ°åŒä¸€æ¡†æ¶ä¸­ï¼Œä»è€Œæ˜¾è‘—ç®€åŒ–åç»­çš„æ¨å¯¼è¿‡ç¨‹ã€‚</p>

<h4 id="å¾—åˆ†å‡½æ•°ä¸klæ•£åº¦çš„è§£ææ¢¯åº¦">å¾—åˆ†å‡½æ•°ä¸KLæ•£åº¦çš„è§£ææ¢¯åº¦</h4>

<p>å¾—åˆ†å‡½æ•°å…·æœ‰ä¸€ä¸ªé‡è¦æ€§è´¨ï¼š$\mathbb{E}_{q_\theta}[s_\theta] = 0$ï¼ˆç”± $\int \nabla_\theta q_\theta dx = \nabla_\theta \int q_\theta dx = \nabla_\theta 1 = 0$ å¯å¾—ï¼‰ã€‚</p>

<p>åŸºäºè¿™ä¸€æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼æ­£å‘ä¸åå‘KLæ•£åº¦å…³äºå‚æ•° $\theta$ çš„<strong>è§£ææ¢¯åº¦</strong>ã€‚</p>

<p><strong>åå‘ KL çš„æ¢¯åº¦</strong>ï¼š</p>

<p>$$
D_{\mathrm{KL}}(q_\theta \| p) = \int q_\theta(x) \log \frac{q_\theta(x)}{p(x)} dx
$$</p>

<p>å¯¹ $\theta$ æ±‚æ¢¯åº¦ï¼ˆåº”ç”¨ä¹˜ç§¯æ³•åˆ™ï¼‰ï¼š</p>

<p>$$
\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \int \nabla_\theta q_\theta \cdot \log \frac{q_\theta}{p} dx + \int q_\theta \cdot \nabla_\theta \log \frac{q_\theta}{p} dx
$$</p>

<p>åˆ©ç”¨ $\nabla_\theta q_\theta = q_\theta \cdot s_\theta$ï¼Œä»¥åŠ $\nabla_\theta \log q_\theta = s_\theta$ã€$\nabla_\theta \log p = 0$ï¼š</p>

<p>$$
= \mathbb{E}_{q_\theta}\left[s_\theta \cdot \log \frac{q_\theta}{p}\right] + \mathbb{E}_{q_\theta}[s_\theta] = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \log \frac{q_\theta}{p}\right]
$$</p>

<p>å³ï¼š</p>

<p>$$
\boxed{\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \log \frac{q_\theta}{p}\right] = -\mathbb{E}_{q_\theta}\left[s_\theta \cdot \log \frac{p}{q_\theta}\right]}
$$</p>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šåæ–‡å°†å®šä¹‰ $k_1 := -\log\frac{p}{q_\theta}$ï¼Œå› æ­¤ä¸Šå¼å¯ç®€å†™ä¸º $\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]$ï¼Œè¿™ä¸€å½¢å¼å°†åœ¨åç»­æ¢¯åº¦åˆ†æä¸­åå¤å‡ºç°ã€‚</p>
</blockquote>

<p><strong>æ­£å‘KLæ•£åº¦çš„æ¢¯åº¦</strong>ï¼š</p>

<p>$$
D_{\mathrm{KL}}(p \| q_\theta) = \int p(x) \log \frac{p(x)}{q_\theta(x)} dx
$$</p>

<p>ç”±äº $p(x)$ ä¸ä¾èµ–äºå‚æ•° $\theta$ï¼š</p>

<p>$$
\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = \int p(x) \cdot \nabla_\theta \left(-\log q_\theta(x)\right) dx = -\mathbb{E}_p[s_\theta]
$$</p>

<p>ä¸ºä½¿ç”¨æ¥è‡ª $q$ çš„æ ·æœ¬ä¼°è®¡è¯¥æ¢¯åº¦ï¼Œæˆ‘ä»¬å¼•å…¥é‡è¦æ€§é‡‡æ ·æŠ€æœ¯ï¼š</p>

<p>$$
-\mathbb{E}_p[s_\theta] = -\mathbb{E}_{q_\theta}\left[\frac{p}{q_\theta} \cdot s_\theta\right]
$$</p>

<p>åˆ©ç”¨ $\mathbb{E}_{q_\theta}[s_\theta] = 0$ï¼Œå¯æ”¹å†™ä¸ºï¼š</p>

<p>$$
\boxed{\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_{q_\theta}\left[\left(1-\frac{p}{q_\theta}\right) \cdot s_\theta\right]}
$$</p>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šåæ–‡å°†æ¨å¯¼ $\nabla_\theta k_3 = (1-\frac{p}{q_\theta}) s_\theta$ï¼Œå› æ­¤ $\mathbb{E}_{q_\theta}[\nabla_\theta k_3] = \nabla_\theta D_{\mathrm{KL}}(p \| q_\theta)$ï¼ˆæ­£å‘KLæ•£åº¦ï¼‰â€”â€”è¿™è§£é‡Šäº†ä¸ºä½•ç›´æ¥å¯¹ $k_3$ è¿›è¡Œåå‘ä¼ æ’­ä¼šäº§ç”Ÿã€Œé”™è¯¯ã€çš„æ¢¯åº¦æ–¹å‘ã€‚</p>
</blockquote>

<p>åŸºäºè¿™ä¸¤ä¸ªç»“æœï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨åç»­åˆ†æä¸­åˆ¤æ–­å„ä¼°è®¡å™¨çš„æ¢¯åº¦æœŸæœ›åˆ†åˆ«å¯¹åº”ä½•ç§KLæ•£åº¦çš„è§£ææ¢¯åº¦ã€‚</p>

<h2 id="ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†">ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†</h2>

<p>åŸºäºæ¦‚ç‡æ¯”å€¼ $\frac{p(x)}{q_\theta(x)}$ï¼ŒJohn Schulmanæå‡ºäº†ä¸‰ç§å•æ ·æœ¬ä¼°è®¡å™¨ã€‚æœ¬èŠ‚å°†è¯¦ç»†ä»‹ç»è¿™äº›ä¼°è®¡å™¨çš„å®šä¹‰åŠå…¶è®¾è®¡åŸç†ã€‚</p>

<h3 id="ä¸‰ç§ä¼°è®¡å™¨å®šä¹‰ä¸ç›´è§‚è§£é‡Š">ä¸‰ç§ä¼°è®¡å™¨ï¼šå®šä¹‰ä¸ç›´è§‚è§£é‡Š</h3>

<p><strong>$k_1$ï¼šæœ€æœ´ç´ çš„ log-ratio ä¼°è®¡å™¨</strong></p>

<p>$$
k_1(x) = -\log \frac{p(x)}{q_\theta(x)} = \log q_\theta(x) - \log p(x)
$$</p>

<p>è¿™æ˜¯æœ€ç›´è§‚çš„å®šä¹‰â€”â€”ç›´æ¥å–å¯¹æ•°æ¯”å€¼çš„è´Ÿå€¼ã€‚å®ƒå¯¹åå‘ KL æ˜¯æ— åçš„ï¼Œä½†å­˜åœ¨ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼š<strong>ä¼°è®¡å€¼å¯èƒ½ä¸ºè´Ÿæ•°</strong>ï¼Œè€Œ KL æ•£åº¦å§‹ç»ˆæ˜¯éè´Ÿçš„ã€‚è¿™ä¼šå¯¼è‡´æ–¹å·®æé«˜ï¼Œå› ä¸ºæ­£è´Ÿä¼°è®¡å€¼ä¼šç›¸äº’æŠµæ¶ˆã€‚</p>

<p><strong>$k_2$ï¼šåŸºäº f-æ•£åº¦çš„å¹³æ–¹ä¼°è®¡å™¨</strong></p>

<p>$$
k_2(x) = \frac{1}{2}\left(\log \frac{p(x)}{q_\theta(x)}\right)^2
$$</p>

<p><strong>è®¾è®¡åŠ¨æœº</strong>ï¼š$k_1$ çš„ä¼°è®¡å€¼å¯æ­£å¯è´Ÿï¼Œè€Œ $k_2$ é€šè¿‡å–å¹³æ–¹ç¡®ä¿<strong>æ¯ä¸ªæ ·æœ¬çš„ä¼°è®¡å€¼éƒ½éè´Ÿ</strong>ï¼Œä»è€Œæ¯ä¸ªæ ·æœ¬éƒ½èƒ½ç›´è§‚åœ°è¡¡é‡ $p$ å’Œ $q$ ä¹‹é—´çš„å·®å¼‚ç¨‹åº¦ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆåå·®è¾ƒå°ï¼Ÿ</strong> $k_2$ æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <strong>f-æ•£åº¦</strong>ï¼ˆf-divergenceï¼‰ï¼Œå…¶ä¸­ $f(x) = \frac{1}{2}(\log x)^2$ã€‚f-æ•£åº¦æœ‰ä¸€ä¸ªé‡è¦æ€§è´¨ï¼š<strong>æ‰€æœ‰å¯å¾®çš„ f-æ•£åº¦åœ¨ $q \approx p$ æ—¶ï¼ŒäºŒé˜¶å±•å¼€éƒ½å½¢å¦‚</strong></p>

<p>$$
D_f\big(p, q_{\theta_0+\Delta\theta}\big) = D_f\big(p, q_{\theta_0}\big) + \frac{f^{\prime\prime}(1)}{2}\, \Delta\theta^T F(\theta_0)\, \Delta\theta + O(\|\Delta\theta\|^3)
$$</p>

<p>å…¶ä¸­ $F(\theta_0)$ æ˜¯ $\theta_0$ å¤„çš„ Fisher ä¿¡æ¯çŸ©é˜µã€‚KL æ•£åº¦å¯¹åº” $f(x) = -\log x$ï¼Œæœ‰ $f^{\prime\prime}(1) = 1$ï¼›è€Œ $k_2$ å¯¹åº”çš„ $f(x) = \frac{1}{2}(\log x)^2$ï¼ŒåŒæ ·æœ‰ $f^{\prime\prime}(1) = 1$ã€‚è¿™æ„å‘³ç€<strong>å½“ç­–ç•¥æ¥è¿‘æ—¶ï¼Œ$\mathbb{E}_{q_\theta}[k_2]$ ä¸çœŸå® KL æ•£åº¦åœ¨äºŒé˜¶è¿‘ä¼¼ä¸‹å…·æœ‰ç›¸åŒçš„å±€éƒ¨æ›²ç‡</strong>ï¼Œåå·®ä¸»è¦æ¥æºäºæ›´é«˜é˜¶é¡¹ã€‚</p>

<p><strong>$k_3$ï¼šæ§åˆ¶å˜é‡æ³•æ„é€ çš„ Bregman æ•£åº¦ä¼°è®¡å™¨</strong></p>

<p>$$
k_3(x) = \frac{p(x)}{q_\theta(x)} - 1 - \log \frac{p(x)}{q_\theta(x)}
$$</p>

<p><strong>è®¾è®¡åŠ¨æœº</strong>ï¼šæˆ‘ä»¬å¸Œæœ›å¾—åˆ°ä¸€ä¸ª<strong>æ—¢æ— ååˆä½æ–¹å·®</strong>çš„ä¼°è®¡å™¨ã€‚æ ‡å‡†åšæ³•æ˜¯ä¸º $k_1$ æ·»åŠ ä¸€ä¸ª<strong>æ§åˆ¶å˜é‡</strong>ï¼ˆcontrol variateï¼‰â€”â€”å³æœŸæœ›ä¸ºé›¶ä½†ä¸ $k_1$ è´Ÿç›¸å…³çš„é‡ã€‚</p>

<p>æ³¨æ„åˆ° $\mathbb{E}_{q_\theta}\left[\frac{p}{q_\theta} - 1\right] = \mathbb{E}_{q_\theta}\left[\frac{p}{q_\theta}\right] - 1 = 1 - 1 = 0$ï¼Œå› æ­¤å¯¹äºä»»æ„ $\lambda$ï¼Œ</p>

<p>$$
k_1 + \lambda\left(\frac{p}{q_\theta} - 1\right) = -\log \frac{p}{q_\theta} + \lambda\left(\frac{p}{q_\theta} - 1\right)
$$</p>

<p>ä»ç„¶æ˜¯æ— åä¼°è®¡ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆé€‰æ‹© $\lambda = 1$ï¼Ÿ</strong> ç”±äº $\log$ æ˜¯å‡¹å‡½æ•°ï¼Œæœ‰ $\log x \leq x - 1$ï¼Œå› æ­¤</p>

<p>$$
k_3 = \left(\frac{p}{q_\theta} - 1\right) - \log \frac{p}{q_\theta} \geq 0
$$</p>

<p><strong>å§‹ç»ˆéè´Ÿ</strong>ï¼è¿™ä¿è¯äº†æ¯ä¸ªæ ·æœ¬éƒ½ã€Œæ­£å‘ã€è´¡çŒ®ä¿¡æ¯ï¼Œé¿å…äº† $k_1$ ä¸­æ­£è´Ÿä¼°è®¡å€¼ç›¸äº’æŠµæ¶ˆçš„é—®é¢˜ã€‚</p>

<p><strong>å‡ ä½•è§†è§’</strong>ï¼š$k_3$ å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>Bregman æ•£åº¦</strong>ã€‚è€ƒè™‘å‡¸å‡½æ•° $\phi(x) = -\log x$ï¼Œå®ƒåœ¨ $x=1$ å¤„çš„åˆ‡çº¿ä¸º $y = 1 - x$ã€‚Bregman æ•£åº¦å®šä¹‰ä¸ºå‡½æ•°å€¼ä¸åˆ‡çº¿å€¼ä¹‹å·®ï¼š</p>

<p>$$
\begin{aligned}
D_\phi\left(\frac{p}{q_\theta}, 1\right) &= \phi\left(\frac{p}{q_\theta}\right) - \phi(1) - \phi'(1)\left(\frac{p}{q_\theta} - 1\right) \\
&= -\log \frac{p}{q_\theta} - 0 - (-1)\left(\frac{p}{q_\theta} - 1\right) \\
&= \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta} \\
&= k_3.
\end{aligned}
$$</p>

<p>ç”±äºå‡¸å‡½æ•°å§‹ç»ˆä½äºå…¶åˆ‡çº¿ä¸Šæ–¹ï¼Œè¯¥å·®å€¼<strong>è‡ªç„¶éè´Ÿ</strong>ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå½“ $\frac{p}{q_\theta} \to 1$ æ—¶ï¼Œå‡½æ•°ä¸åˆ‡çº¿ã€Œè´´åˆã€å¾—è¶Šæ¥è¶Šç´§å¯†ï¼Œå·®å€¼ä»¥ \left(\frac{p}{q_\theta} - 1\right)^2 çš„äºŒé˜¶é€Ÿåº¦è¶‹è¿‘äºé›¶â€”â€”è¿™æ­£æ˜¯ $k_3$ åœ¨ç­–ç•¥æ¥è¿‘æ—¶æ–¹å·®è¾ƒå°çš„æ ¹æœ¬åŸå› ã€‚</p>

<p><strong>å°ç»“ï¼šä¸‰è€…çš„è®¾è®¡é€»è¾‘å¯¹æ¯”</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">å®šä¹‰</th>
      <th style="text-align: center">è®¾è®¡åŸç†</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">$-\log \frac{p}{q_\theta}$</td>
      <td style="text-align: center">æœ€æœ´ç´ å®šä¹‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">$\frac{1}{2}\left(\log \frac{p}{q_\theta}\right)^2$</td>
      <td style="text-align: center">f-æ•£åº¦ï¼ŒäºŒé˜¶è¡Œä¸ºä¸ KL ä¸€è‡´</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">$\frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}$</td>
      <td style="text-align: center">æ§åˆ¶å˜é‡ + Bregman æ•£åº¦</td>
    </tr>
  </tbody>
</table>

<p>åœ¨æ˜ç¡®äº†ä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†ä¹‹åï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æå®ƒä»¬åœ¨ä¼°è®¡KLæ•£åº¦æ•°å€¼æ—¶çš„æ€§è´¨ï¼Œå³åå·®ä¸æ–¹å·®ç‰¹æ€§ã€‚</p>

<h2 id="æ•°å€¼ä¼°è®¡åå·®ä¸æ–¹å·®">æ•°å€¼ä¼°è®¡ï¼šåå·®ä¸æ–¹å·®</h2>

<p>æœ¬èŠ‚å°†åˆ†æä¸‰ç§ä¼°è®¡å™¨åœ¨ä¼°è®¡KLæ•£åº¦æ•°å€¼æ—¶çš„æ€§è´¨ã€‚è¿™äº›æ€§è´¨æ„æˆäº†ä¸€åˆ‡ä½¿ç”¨åœºæ™¯çš„åŸºç¡€ã€‚</p>

<p>å‡è®¾ä» $q_\theta$ é‡‡æ ·æ¥ä¼°è®¡åå‘ KL $D_{\mathrm{KL}}(q_\theta \| p)$ï¼š</p>

<h3 id="æ— åæ€§åˆ†æ">æ— åæ€§åˆ†æ</h3>

<p>$$
\begin{aligned}
\mathbb{E}_{q_\theta}[k_1] &= \mathbb{E}_{q_\theta}\left[\log \frac{q_\theta}{p}\right] = D_{\mathrm{KL}}(q_\theta \| p) && \textbf{ï¼ˆæ— åï¼‰} \\[8pt]
\mathbb{E}_{q_\theta}[k_3] &= \mathbb{E}_{q_\theta}\left[\frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}\right] && \\
&= 1 - 1 + D_{\mathrm{KL}}(q_\theta \| p) && \\
&= D_{\mathrm{KL}}(q_\theta \| p) && \textbf{ï¼ˆæ— åï¼‰} \\[8pt]
\mathbb{E}_{q_\theta}[k_2] &= \frac{1}{2}\mathbb{E}_{q_\theta}\left[\left(\log \frac{p}{q_\theta}\right)^2\right] \neq D_{\mathrm{KL}}(q_\theta \| p) && \textbf{ï¼ˆæœ‰åï¼‰}
\end{aligned}
$$</p>

<p><strong>ç»“è®º</strong>ï¼šåœ¨ä¼°è®¡åå‘ KL çš„æ•°å€¼æ—¶ï¼Œ$k_1$ å’Œ $k_3$ æ˜¯æ— åä¼°è®¡ï¼Œè€Œ $k_2$ æ˜¯æœ‰åä¼°è®¡ã€‚</p>

<h3 id="æ–¹å·®ç‰¹æ€§åˆ†æ">æ–¹å·®ç‰¹æ€§åˆ†æ</h3>

<p>John Schulman çš„å®éªŒï¼ˆ$q = \mathcal{N}(0,1)$ï¼Œ$p = \mathcal{N}(0.1,1)$ï¼ŒçœŸå® KL = 0.005ï¼‰æ˜¾ç¤ºï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">åå·®/çœŸå€¼</th>
      <th style="text-align: center">æ ‡å‡†å·®/çœŸå€¼</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">20</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">0.002</td>
      <td style="text-align: center">1.42</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1.42</td>
    </tr>
  </tbody>
</table>

<p>å½“ KL è¾ƒå¤§æ—¶ï¼ˆ$p = \mathcal{N}(1,1)$ï¼ŒçœŸå® KL = 0.5ï¼‰ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">åå·®/çœŸå€¼</th>
      <th style="text-align: center">æ ‡å‡†å·®/çœŸå€¼</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">2</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">0.25</td>
      <td style="text-align: center">1.73</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1.7</td>
    </tr>
  </tbody>
</table>

<p><strong>æ ¸å¿ƒç›´è§‚ç†è§£</strong>ï¼š</p>

<ul>
  <li>$k_1 = -\log \frac{p}{q_\theta}$ ä»¥ä¸€é˜¶é¡¹èµ·æ­¥ï¼Œå½“ $\frac{p}{q_\theta}$ æ¥è¿‘ 1 æ—¶æ³¢åŠ¨è¾ƒå¤§ï¼Œä¸”å¯èƒ½å–è´Ÿå€¼</li>
  <li>$k_3 = \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}$ åœ¨ $\frac{p}{q_\theta}=1$ å¤„æ˜¯äºŒé˜¶å°é‡ï¼Œå§‹ç»ˆéè´Ÿï¼Œå› æ­¤åœ¨ç­–ç•¥æ¥è¿‘æ—¶æ–¹å·®è¾ƒå°</li>
  <li>ä½†å½“è¦†ç›–ä¸¥é‡ä¸è¶³ï¼ˆ$\frac{p}{q_\theta}$ å¯èƒ½æå¤§ï¼‰æ—¶ï¼Œ$k_3$ çš„æ–¹å·®ä¼šå› æƒé‡çˆ†ç‚¸è€Œå¢å¤§ï¼›æ­¤æ—¶ $k_1$ åè€Œæ›´åŠ ç¨³å®š</li>
</ul>

<p><strong>æ•°å€¼ä¼°è®¡å°ç»“</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">å¯¹æ•°å€¼çš„åå·®</th>
      <th style="text-align: center">æ–¹å·®ç‰¹æ€§</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">æ— å</td>
      <td style="text-align: center">é«˜ï¼ˆå¯æ­£å¯è´Ÿï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">æœ‰åï¼ˆä½†æå°ï¼‰</td>
      <td style="text-align: center">ä½ï¼ˆæ’æ­£ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">æ— å</td>
      <td style="text-align: center">ä½ï¼ˆæ’æ­£ï¼‰</td>
    </tr>
  </tbody>
</table>

<p>ä»æ•°å€¼ä¼°è®¡çš„è§’åº¦çœ‹ï¼Œ$k_3$ æ˜¯ã€Œæ— å + ä½æ–¹å·®ã€çš„æœ€ä¼˜é€‰æ‹©ã€‚</p>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šè‹¥è¦ä¼°è®¡<strong>æ­£å‘ KL çš„æ•°å€¼</strong> $D_{\mathrm{KL}}(p \| q_\theta) = \mathbb{E}_p\left[\log \frac{p}{q_\theta}\right]$ï¼Œä¸”åªèƒ½ä» $q_\theta$ é‡‡æ ·ï¼Œåˆ™å¯ä»¥ä½¿ç”¨é‡è¦æ€§é‡‡æ · $\mathbb{E}_{q_\theta}\left[\frac{p}{q_\theta} \log \frac{p}{q_\theta}\right]$ã€‚</p>
</blockquote>

<h2 id="kl-æƒ©ç½šçš„ä¸¤ç§ä½¿ç”¨æ–¹å¼">KL æƒ©ç½šçš„ä¸¤ç§ä½¿ç”¨æ–¹å¼</h2>

<p>äº†è§£äº†ä¼°è®¡å™¨çš„æ•°å€¼æ€§è´¨åï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥æ˜ç¡®ï¼š<strong>KL æƒ©ç½šåœ¨å¼ºåŒ–å­¦ä¹ ä¸­ç©¶ç«Ÿå¦‚ä½•åº”ç”¨ï¼Ÿ</strong> è¿™ä¸€é€‰æ‹©å†³å®šäº†æˆ‘ä»¬æ˜¯ä»…å…³å¿ƒä¼°è®¡å™¨çš„æ•°å€¼æ€§è´¨ï¼Œè¿˜æ˜¯å¿…é¡»åŒæ—¶å…³æ³¨å…¶æ¢¯åº¦æ€§è´¨ã€‚</p>

<p>å›é¡¾ KL æ­£åˆ™åŒ–å¼ºåŒ–å­¦ä¹ çš„ç›®æ ‡å‡½æ•°ï¼ˆä¸‹å¼ä¸­ $\tau\sim q_\theta$ è¡¨ç¤ºâ€œç”±ç­–ç•¥ $q_\theta$ è¯±å¯¼çš„è½¨è¿¹åˆ†å¸ƒâ€ï¼‰ï¼š</p>

<p>$$
J(\theta) = \mathbb{E}_{\tau \sim q_\theta} \left[ \sum_{t=0}^T \gamma^t r(s_t, a_t) \right] - \beta \cdot D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>è¿™ä¸ªæ•°å­¦å½¢å¼çœ‹ä¼¼ç»Ÿä¸€ï¼Œä½†åœ¨åŸºäºç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradientï¼‰çš„ç®—æ³•ï¼ˆå¦‚ PPOï¼‰ä¸­å®ç°æ—¶ï¼Œå´è¡ç”Ÿå‡ºä¸¤ç§æˆªç„¶ä¸åŒçš„å®ç°èŒƒå¼â€”â€”å®ƒä»¬åœ¨ä»£ç å±‚é¢å¯èƒ½åªå·®å‡ è¡Œï¼Œå´å¯¹åº”ç€å®Œå…¨ä¸åŒçš„ä¼˜åŒ–è¯­ä¹‰ã€‚</p>

<blockquote>
  <p><strong>ç¬¦å·è¯´æ˜</strong>ï¼šæœ¬èŠ‚ç”¨ $\text{KL}_t$ æˆ– $\text{KL}(s)$ æ³›æŒ‡æŸä¸ª token/state çº§çš„ KL ä¼°è®¡å™¨ï¼ˆå¦‚ $k_1, k_2, k_3$ï¼‰ï¼Œå…·ä½“å®šä¹‰è§å‰æ–‡ã€Œä¸‰ç§ä¼°è®¡å™¨çš„å®šä¹‰ä¸è®¾è®¡åŸç†ã€ä¸€èŠ‚ã€‚</p>
</blockquote>

<h3 id="ä½œä¸º-losskl-å‚ä¸æ¢¯åº¦åä¼ ">ä½œä¸º Lossï¼šKL å‚ä¸æ¢¯åº¦åä¼ </h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">actor_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">advantage</span> <span class="o">*</span> <span class="n">log_prob</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">kl</span>  <span class="c1"># kl å‚ä¸æ¢¯åº¦è®¡ç®—
</span></code></pre></div></div>

<p>Critic ä»…å­¦ä¹ ç¯å¢ƒä»·å€¼ï¼ŒKL ä½œä¸º actor çš„æ­£åˆ™é¡¹ç›´æ¥å‚ä¸ loss çš„æ¢¯åº¦å›ä¼ ã€‚</p>

<h3 id="ä½œä¸º-rewardkl-åŠ å…¥å¥–åŠ±å¡‘å½¢">ä½œä¸º Rewardï¼šKL åŠ å…¥å¥–åŠ±å¡‘å½¢</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kl</span> <span class="o">=</span> <span class="nf">compute_kl</span><span class="p">(</span><span class="n">log_prob_q</span><span class="p">,</span> <span class="n">log_prob_p</span><span class="p">).</span><span class="nf">detach</span><span class="p">()</span>
<span class="n">shaped_reward</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">kl</span>
</code></pre></div></div>

<p>KL è¢«è§†ä¸ºç¯å¢ƒå¥–åŠ±çš„ä¸€éƒ¨åˆ†ï¼Œä½¿ç”¨å½¢å¡‘åçš„å¥–åŠ±è¿›è¡Œæ ‡å‡†çš„ actor-critic æ›´æ–°ã€‚KL é¡¹ä¸å‚ä¸ loss çš„æ¢¯åº¦å›ä¼ ã€‚</p>

<p>è¿™ä¸¤ç§åšæ³•çœ‹ä¼¼åªæ˜¯ä»£ç ä¸­ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">.detach()</code> çš„åŒºåˆ«ï¼Œå®é™…ä¸Šå¯¹åº”ç€æˆªç„¶ä¸åŒçš„ä¼˜åŒ–è¯­ä¹‰ã€‚ä¸¤ç§æ–¹å¼çš„æ·±å…¥å¯¹æ¯”å°†åœ¨åæ–‡ã€Œ$k_1$ in Reward ä¸ä½æ–¹å·® KL in Loss çš„ç­‰ä»·æ€§ä¸å·®å¼‚ã€ä¸€èŠ‚è¯¦ç»†å±•å¼€ã€‚æ­¤å¤„å…ˆç»™å‡ºæ ¸å¿ƒåŒºåˆ«ï¼š</p>

<ul>
  <li><strong>KL ä½œä¸º Loss</strong>ï¼šéœ€è¦ KL ä¼°è®¡å™¨çš„æ­£ç¡®æ˜¾å¼æ¢¯åº¦ï¼Œå…³å¿ƒæ¢¯åº¦å¯¹åº”å“ªä¸ªä¼˜åŒ–ç›®æ ‡</li>
  <li><strong>KL ä½œä¸º Reward</strong>ï¼šéœ€è¦ KL çš„å‡†ç¡®æ•°å€¼ä¼°è®¡ï¼ŒåŒæ—¶è¿˜è¦å…³æ³¨å®ƒè¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ˜¯å¦æ­£ç¡®</li>
</ul>

<p>ä¸‹é¢æˆ‘ä»¬æŒ‰ç…§ã€Œä½œä¸º Lossã€å’Œã€Œä½œä¸º Rewardã€ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œæ·±å…¥å‰–æä¼°è®¡å™¨çš„æ¢¯åº¦æ€§è´¨ã€‚</p>

<h2 id="ä½œä¸º-loss-æ—¶çš„æ¢¯åº¦åˆ†æ">ä½œä¸º Loss æ—¶çš„æ¢¯åº¦åˆ†æ</h2>

<p>å½“ KL æ•£åº¦ä½œä¸ºæŸå¤±å‡½æ•°å‚ä¸æ¢¯åº¦å›ä¼ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨ä¸åŒä¼°è®¡å™¨å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡ã€‚è¿™æ˜¯å®è·µä¸­æœ€æ˜“æ··æ·†ï¼Œä¹Ÿæœ€å…³é”®çš„ç¯èŠ‚ã€‚</p>

<p>å€ŸåŠ©å‰æ–‡å¼•å…¥çš„ç»Ÿä¸€æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥å°† on-policy ä¸ off-policy åœºæ™¯ä¸‹çš„åˆ†æåˆå¹¶ä¸ºä¸€å¥—æ¨å¯¼ã€‚å›é¡¾ç»Ÿä¸€çš„æ¯”ç‡å®šä¹‰ï¼š</p>

<p>$$
\rho(x) := \frac{q_\theta(x)}{\text{sg}(\mu(x))}
$$</p>

<p>å…¶ä¸­ $\mu$ ä¸ºé‡‡æ ·ç­–ç•¥ã€‚åœ¨æ­¤æ¡†æ¶ä¸‹ï¼š</p>

<ul>
  <li><strong>On-policy</strong>ï¼ˆ$\mu = q_\theta$ï¼‰ï¼š$\rho \equiv 1$ï¼Œä½† $\nabla_\theta \rho = s_\theta$</li>
  <li><strong>Off-policy</strong>ï¼ˆ$\mu \neq q_\theta$ï¼‰ï¼š$\rho = \frac{q_\theta}{\mu}$ï¼Œä¸” $\nabla_\theta \rho = \rho \cdot s_\theta$</li>
</ul>

<h3 id="ä¸‰ç§ä¼°è®¡å™¨çš„åŸºæœ¬æ¢¯åº¦">ä¸‰ç§ä¼°è®¡å™¨çš„åŸºæœ¬æ¢¯åº¦</h3>

<p>é¦–å…ˆè®¡ç®—ä¸‰ç§ä¼°è®¡å™¨æœ¬èº«çš„æ¢¯åº¦ï¼ˆä¸å« $\rho$ï¼‰ï¼Œè¿™äº›ç»“æœå°†åœ¨åç»­åˆ†æä¸­åå¤ä½¿ç”¨ã€‚</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_1$</strong>ï¼š</p>

<p>$$
k_1 = -\log \frac{p(x)}{q_\theta(x)} = \log q_\theta(x) - \log p(x)
$$</p>

<p>$$
\nabla_\theta k_1 = \nabla_\theta \log q_\theta(x) - \nabla_\theta \log p(x) = s_\theta - 0 = s_\theta
$$</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_2$</strong>ï¼š</p>

<p>$$
k_2 = \frac{1}{2}\left(\log \frac{p}{q_\theta}\right)^2
$$</p>

<p>ç”±é“¾å¼æ³•åˆ™ï¼š</p>

<p>$$
\begin{aligned}
\nabla_\theta k_2
&= \left(\log \frac{p}{q_\theta}\right) \cdot \nabla_\theta\left(\log \frac{p}{q_\theta}\right) \\
&= \left(\log \frac{p}{q_\theta}\right) \cdot \nabla_\theta(\log p(x) - \log q_\theta(x)) \\
&= \left(\log \frac{p}{q_\theta}\right)(-s_\theta) \\
&= - \left(\log \frac{p}{q_\theta}\right) s_\theta.
\end{aligned}
$$</p>

<p><strong>æ¨å¯¼ $\nabla_\theta k_3$</strong>ï¼š</p>

<p>$$
k_3 = \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}
$$</p>

<p>é¦–å…ˆè®¡ç®— $\nabla_\theta \frac{p}{q_\theta}$ã€‚ç”±äº $\frac{p}{q_\theta} = p(x) \cdot q_\theta(x)^{-1}$ï¼š</p>

<p>$$
\nabla_\theta \frac{p}{q_\theta} = p(x) \cdot (-1) \cdot q_\theta(x)^{-2} \cdot \nabla_\theta q_\theta(x) = -\frac{p(x)}{q_\theta(x)} \cdot \frac{\nabla_\theta q_\theta(x)}{q_\theta(x)} = -\frac{p}{q_\theta} \cdot s_\theta
$$</p>

<p>å†è®¡ç®— $\nabla_\theta \log \frac{p}{q_\theta}$ï¼š</p>

<p>$$
\nabla_\theta \log \frac{p}{q_\theta} = \frac{q_\theta}{p} \nabla_\theta \frac{p}{q_\theta} = \frac{q_\theta}{p} \cdot \left(-\frac{p}{q_\theta} \cdot s_\theta\right) = -s_\theta
$$</p>

<p>å› æ­¤ï¼š</p>

<p>$$
\nabla_\theta k_3 = \nabla_\theta \frac{p}{q_\theta} - 0 - \nabla_\theta \log \frac{p}{q_\theta} = -\frac{p}{q_\theta} \cdot s_\theta - (-s_\theta) = \left(1 - \frac{p}{q_\theta}\right) \cdot s_\theta
$$</p>

<p><strong>å°ç»“</strong>ï¼šä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦åˆ†åˆ«ä¸ºï¼š</p>

<ul>
  <li>$\nabla_\theta k_1 = s_\theta$</li>
  <li>$\nabla_\theta k_2 = -\left(\log \frac{p}{q_\theta}\right) s_\theta = k_1 \cdot s_\theta$</li>
  <li>$\nabla_\theta k_3 = \left(1 - \frac{p}{q_\theta}\right) s_\theta$</li>
</ul>

<p>è¿™äº›åŸºæœ¬æ¢¯åº¦å°†åœ¨åç»­çš„ç»Ÿä¸€æ¡†æ¶åˆ†æä¸­åå¤ä½¿ç”¨ã€‚</p>

<h4 id="å…ˆæœŸæœ›åæ¢¯åº¦vså…ˆæ¢¯åº¦åæœŸæœ›ä¸€ä¸ªé‡è¦è­¦ç¤º">ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€vsã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€ï¼šä¸€ä¸ªé‡è¦è­¦ç¤º</h4>

<p>åœ¨åˆ†æ KL ä¼°è®¡å™¨çš„æ¢¯åº¦æ—¶ï¼Œæœ‰ä¸€ä¸ªå®¹æ˜“æ··æ·†çš„é™·é˜±ï¼š<strong>ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ä¸ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€å¯èƒ½ç»™å‡ºä¸åŒçš„ç»“æœ</strong>ã€‚</p>

<p>å¦‚æœä»è§£æè§’åº¦å°† $\mathbb{E}_{q_\theta}[k_i]$ è§†ä¸º $\theta$ çš„å‡½æ•°å†æ±‚æ¢¯åº¦ï¼ˆå³ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ï¼‰ï¼Œæ ¹æ®ã€Œæ•°å€¼ä¼°è®¡ã€ä¸€èŠ‚çš„ç»“è®º $\mathbb{E}_{q_\theta}[k_1] = \mathbb{E}_{q_\theta}[k_3] = D_{\mathrm{KL}}(q_\theta \| p)$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p>

<p>$$
\nabla_\theta \mathbb{E}_{q_\theta}[k_1] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>$$
\nabla_\theta \mathbb{E}_{q_\theta}[k_3] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>ä¸¤è€…éƒ½ç»™å‡ºåå‘ KL çš„æ¢¯åº¦ã€‚ç„¶è€Œï¼Œåœ¨ä»£ç ä¸­ç›´æ¥å¯¹ $k_i$ çš„æ ·æœ¬å‡å€¼è¿›è¡Œåå‘ä¼ æ’­æ—¶ï¼Œè‡ªåŠ¨å¾®åˆ†æ‰§è¡Œçš„æ˜¯ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€ï¼Œå¾—åˆ° $\mathbb{E}_{q_\theta}[\nabla_\theta k_i]$â€”â€”è¿™ä¸ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€çš„ç»“æœ<strong>å¯èƒ½ä¸åŒ</strong>ã€‚</p>

<p>è¿™ç§å·®å¼‚çš„æ ¹æºåœ¨äºï¼šå½“é‡‡æ ·åˆ†å¸ƒ $q_\theta$ æœ¬èº«ä¾èµ–äº $\theta$ æ—¶ï¼ŒæœŸæœ›ä¸æ¢¯åº¦ä¸èƒ½éšæ„äº¤æ¢ã€‚è¿™æ­£æ˜¯ on-policy åœºæ™¯çš„æ ¸å¿ƒå›°éš¾ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦å¼•å…¥ç»Ÿä¸€ $\rho$ æ¡†æ¶çš„åŸå› ã€‚</p>

<h3 id="ç»Ÿä¸€æ¡†æ¶ä¸‹çš„æ¢¯åº¦åˆ†æ">ç»Ÿä¸€æ¡†æ¶ä¸‹çš„æ¢¯åº¦åˆ†æ</h3>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ $\rho$ æ¡†æ¶ç»Ÿä¸€å¤„ç† on-policy å’Œ off-policy åœºæ™¯ã€‚è€ƒè™‘æŸå¤±å‡½æ•°å½¢å¼ $L = \rho \cdot k$ï¼Œå…¶ä¸­ $\rho = \frac{q_\theta}{\text{sg}(\mu)}$ã€‚</p>

<p><strong>å…³é”®è§‚å¯Ÿ</strong>ï¼šç”±äº $\text{sg}(\mu)$ ä¸ä¾èµ–äº $\theta$ï¼Œå¯¹äºä»»ä½•å…³äº $\theta$ å¯å¾®çš„å‡½æ•° $f_\theta(x)$ï¼Œæœ‰</p>

<p>$$
\nabla_\theta \mathbb{E}_{\mu}[f_\theta(x)] = \mathbb{E}_{\mu}[\nabla_\theta f_\theta(x)]
$$</p>

<p>è¿™æ„å‘³ç€åœ¨ $\rho$ æ¡†æ¶ä¸‹ï¼Œã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ä¸ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€<strong>æ€»æ˜¯ç­‰ä»·çš„</strong>â€”â€”æ— è®º on-policy è¿˜æ˜¯ off-policyã€‚</p>

<blockquote>
  <p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçš„â€œæœŸæœ›â€æŒ‡çš„æ˜¯å¯¹<strong>å›ºå®šçš„é‡‡æ ·åˆ†å¸ƒ</strong> $\mu$ çš„ $\mathbb{E}_\mu[\cdot]$ã€‚æˆ‘ä»¬å°†â€œåˆ†å¸ƒå¯¹ $\theta$ çš„ä¾èµ–â€ç»Ÿä¸€çº³å…¥ $\rho=\frac{q_\theta}{\text{sg}(\mu)}$ è¿™æ¡è·¯å¾„ä¸­ï¼›å› æ­¤ä¸è¦å°†è¿™å¥è¯è¯¯è¯»ä¸ºå¯¹ $\mathbb{E}_{q_\theta}[\cdot]$ ä¹Ÿèƒ½æ— æ¡ä»¶åœ°äº¤æ¢å¾®åˆ†ä¸æœŸæœ›ã€‚</p>
</blockquote>

<h4 id="ç»Ÿä¸€æ¡†æ¶ä¸‹ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼">ç»Ÿä¸€æ¡†æ¶ä¸‹ä¸‰ç§ä¼°è®¡å™¨çš„æ¢¯åº¦æ¨å¯¼</h4>

<p>åˆ©ç”¨ $\nabla_\theta \rho = \rho \cdot s_\theta$ï¼ˆå› ä¸º $\rho = q_\theta / \text{sg}(\mu)$ï¼‰ï¼Œç»“åˆå‰æ–‡æ¨å¯¼çš„ $\nabla_\theta k_i$ï¼Œåº”ç”¨ä¹˜ç§¯æ³•åˆ™ï¼š</p>

<p><strong>$\nabla_\theta(\rho k_1)$</strong>ï¼š</p>

<p>$$
\nabla_\theta(\rho k_1) = (\nabla_\theta \rho) k_1 + \rho (\nabla_\theta k_1) = \rho s_\theta k_1 + \rho s_\theta = \rho s_\theta (k_1 + 1)
$$</p>

<p><strong>$\nabla_\theta(\rho k_2)$</strong>ï¼š</p>

<p>$$
\nabla_\theta(\rho k_2) = \rho s_\theta k_2 + \rho \left(-\log \frac{p}{q_\theta}\right) s_\theta = \rho s_\theta \left(k_2 - \log \frac{p}{q_\theta}\right) = \rho s_\theta (k_2 + k_1)
$$</p>

<p><strong>$\nabla_\theta(\text{sg}(\rho) k_2)$</strong>ï¼ˆå¯¹ $\rho$ æ–½åŠ  stop-gradientï¼‰ï¼š</p>

<p>$$
\nabla_\theta(\text{sg}(\rho) k_2) = \text{sg}(\rho) \cdot \nabla_\theta k_2 = \rho \cdot \left(-\log \frac{p}{q_\theta}\right) s_\theta = \rho s_\theta k_1
$$</p>

<p><strong>$\nabla_\theta(\rho k_3)$</strong>ï¼š</p>

<p>$$
\nabla_\theta(\rho k_3) = \rho s_\theta k_3 + \rho \left(1-\frac{p}{q_\theta}\right) s_\theta = \rho s_\theta \left(k_3 + 1 - \frac{p}{q_\theta}\right)
$$</p>

<p>ä»£å…¥ $k_3 = \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}$ï¼š</p>

<p>$$
k_3 + 1 - \frac{p}{q_\theta} = \left(\frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}\right) + 1 - \frac{p}{q_\theta} = -\log \frac{p}{q_\theta} = k_1
$$</p>

<p>å› æ­¤å¾—åˆ°ä¸€ä¸ªå…³é”®ç®€åŒ–ï¼š</p>

<p>$$
\boxed{\nabla_\theta(\rho k_3) = \rho s_\theta k_1}
$$</p>

<h4 id="æ¢¯åº¦æœŸæœ›ä¸ä¼˜åŒ–ç›®æ ‡">æ¢¯åº¦æœŸæœ›ä¸ä¼˜åŒ–ç›®æ ‡</h4>

<p>åˆ©ç”¨ $\mathbb{E}_\mu[\rho \cdot f] = \mathbb{E}_{q_\theta}[f]$ å’Œ $\mathbb{E}_{q_\theta}[s_\theta] = 0$ï¼š</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(\rho k_1)]$</strong>ï¼š</p>

<p>$$
\mathbb{E}_\mu[\rho s_\theta (k_1 + 1)] = \mathbb{E}_{q_\theta}[s_\theta k_1] + \underbrace{\mathbb{E}_{q_\theta}[s_\theta]}_{=0} = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) \quad \checkmark

$$</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(\rho k_2)]$</strong>ï¼š</p>

<p>$$
\begin{aligned}
\mathbb{E}_\mu[\rho s_\theta (k_2 + k_1)]
&= \mathbb{E}_{q_\theta}[s_\theta k_2] + \mathbb{E}_{q_\theta}[s_\theta k_1] \\
&= \mathbb{E}_{q_\theta}[s_\theta k_2] + \mathbb{E}_{q_\theta}[\nabla_\theta k_2] && \text{ï¼ˆå› ä¸º } \nabla_\theta k_2 = k_1 s_\theta \text{ï¼‰} \\
&= \nabla_\theta \mathbb{E}_{q_\theta}[k_2] && \text{ï¼ˆLeibniz è§„åˆ™ï¼‰}
\end{aligned}
$$</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ$\rho k_2$ çš„æ¢¯åº¦æœŸæœ›å¯¹åº”çš„æ˜¯â€œæœ€å°åŒ– $\mathbb{E}_{q_\theta}[k_2]$â€ï¼ˆä¸€ä¸ªä¸ KL äºŒé˜¶è¿‘ä¼¼ä¸€è‡´çš„ f-æ•£åº¦ï¼‰ï¼Œè€Œ<strong>ä¸æ˜¯</strong>åå‘ KL $D_{\mathrm{KL}}(q_\theta\|p)$ çš„è§£ææ¢¯åº¦ï¼›å› æ­¤å½“ç›®æ ‡æ˜¯åå‘ KL æ—¶ï¼Œåº”é¿å…ä½¿ç”¨ $\rho k_2$ã€‚</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(\text{sg}(\rho) k_2)]$</strong>ï¼š</p>

<p>$$
\mathbb{E}_\mu[\rho s_\theta k_1] = \mathbb{E}_{q_\theta}[s_\theta k_1] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) \quad \checkmark
$$</p>

<p><strong>$\mathbb{E}_\mu[\nabla_\theta(\rho k_3)]$</strong>ï¼š</p>

<p>$$
\mathbb{E}_\mu[\rho s_\theta k_1] = \mathbb{E}_{q_\theta}[s_\theta k_1] = \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) \quad \checkmark
$$</p>

<h4 id="æ¢¯åº¦ç­‰ä»·æ€§å“ªäº›æ–¹æ³•äº§ç”Ÿç›¸åŒçš„æ¢¯åº¦éšæœºå˜é‡">æ¢¯åº¦ç­‰ä»·æ€§ï¼šå“ªäº›æ–¹æ³•äº§ç”Ÿç›¸åŒçš„æ¢¯åº¦éšæœºå˜é‡</h4>

<p>ä»ä¸Šè¿°æ¨å¯¼ä¸­ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªå…³é”®äº‹å®ï¼š</p>

<blockquote>
  <p><strong>$\text{sg}(\rho) k_2$ ä¸ $\rho k_3$ çš„æ¢¯åº¦å®Œå…¨ç›¸åŒ</strong>ï¼š$\nabla_\theta(\text{sg}(\rho) k_2) = \nabla_\theta(\rho k_3) = \rho s_\theta k_1$</p>
</blockquote>

<p>è¿™æ„å‘³ç€å®ƒä»¬ä¸ä»…æœŸæœ›ç›¸åŒï¼Œè€Œä¸”<strong>ä½œä¸ºéšæœºå˜é‡å®Œå…¨ç­‰ä»·</strong>â€”â€”åŒå‡å€¼ã€åŒæ–¹å·®ã€åŒé«˜é˜¶çŸ©ã€‚</p>

<p><strong>æ€»ç»“è¡¨æ ¼</strong>ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Loss å½¢å¼</th>
      <th style="text-align: center">æ¢¯åº¦éšæœºå˜é‡</th>
      <th style="text-align: center">æ¢¯åº¦æœŸæœ›</th>
      <th style="text-align: center">å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$\rho k_1$</td>
      <td style="text-align: center">$\rho s_\theta (k_1+1)$</td>
      <td style="text-align: center">$\nabla D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">åå‘ KL âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$\rho k_2$</td>
      <td style="text-align: center">$\rho s_\theta (k_2 + k_1)$</td>
      <td style="text-align: center">$\nabla_\theta \mathbb{E}_{q_\theta}[k_2]$</td>
      <td style="text-align: center">f-æ•£åº¦ï¼ˆéåå‘ KLï¼‰âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\text{sg}(\rho) k_2$</td>
      <td style="text-align: center">$\rho s_\theta k_1$</td>
      <td style="text-align: center">$\nabla D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">åå‘ KL âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$\rho k_3$</td>
      <td style="text-align: center">$\rho s_\theta k_1$</td>
      <td style="text-align: center">$\nabla D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">åå‘ KL âœ“</td>
    </tr>
  </tbody>
</table>

<h3 id="on-policy-ä¸-off-policy-çš„ç»Ÿä¸€è§†è§’">On-policy ä¸ Off-policy çš„ç»Ÿä¸€è§†è§’</h3>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿä¸€æ¡†æ¶é‡æ–°å®¡è§† on-policy ä¸ off-policy çš„å…³ç³»ã€‚</p>

<p><strong>On-policy</strong>ï¼ˆ$\mu = q_\theta$ï¼‰ï¼š</p>

<ul>
  <li>$\rho = \frac{q_\theta}{\text{sg}(q_\theta)} \equiv 1$ï¼ˆæ•°å€¼æ’ä¸º 1ï¼‰</li>
  <li>$\rho k_1 = k_1$ï¼Œ$\rho k_2 = k_2$ï¼Œ$\rho k_3 = k_3$</li>
  <li>ä½†æ¢¯åº¦ä¸åŒï¼å› ä¸º $\nabla_\theta \rho = s_\theta \neq 0$</li>
</ul>

<p>è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆ on-policy æ—¶<strong>æœ´ç´ ç›´æ¥åå‘ä¼ æ’­</strong>ï¼ˆä¸æ˜¾å¼æ„é€  $\rho$ï¼‰ä½¿ç”¨ $k_1$ æˆ– $k_3$ ä½œä¸ºæŸå¤±å‡½æ•°ä¼šå‡ºé—®é¢˜ï¼š</p>

<ul>
  <li>ç›´æ¥ä½¿ç”¨ $k_1$ï¼šç›¸å½“äºæ²¡æœ‰ $\rho$ çš„ç‰ˆæœ¬ï¼Œ$\mathbb{E}_{q_\theta}[\nabla k_1] = \mathbb{E}_{q_\theta}[s_\theta] = 0$ï¼Œ<strong>å®Œå…¨æ— æ•ˆ</strong></li>
  <li>ç›´æ¥ä½¿ç”¨ $k_3$ï¼šç›¸å½“äºæ²¡æœ‰ $\rho$ çš„ç‰ˆæœ¬ï¼Œ$\mathbb{E}_{q_\theta}[\nabla k_3] = \nabla D_{\mathrm{KL}}(p \| q_\theta)$ï¼ˆæ­£å‘ KLï¼‰ï¼Œ<strong>æ–¹å‘é”™è¯¯</strong></li>
  <li>ç›´æ¥ä½¿ç”¨ $k_2$ï¼š$\mathbb{E}_{q_\theta}[\nabla k_2] = \nabla D_{\mathrm{KL}}(q_\theta \| p)$ï¼ˆåå‘ KLï¼‰âœ“ <strong>æœ´ç´ å®ç°ä¸‹å”¯ä¸€æ­£ç¡®é€‰æ‹©</strong></li>
</ul>

<p>ä½†å¦‚æœ<strong>æ˜¾å¼æ„é€ </strong> $\rho = \frac{q_\theta}{\text{sg}(q_\theta)}$ï¼Œåˆ™ï¼š</p>

<ul>
  <li><strong>å¯ç”¨</strong>ï¼š$\rho k_1$ï¼ˆæ–¹å·®é«˜ï¼‰ã€$\text{sg}(\rho) k_2$ï¼ˆæ¨èï¼‰ã€$\rho k_3$ï¼ˆæ¨èï¼‰â€”â€”ä¸‰è€…å‡ç»™å‡ºåå‘ KL æ¢¯åº¦</li>
  <li><strong>ä¸å¯ç”¨</strong>ï¼š$\rho k_2$ï¼ˆ$\rho$ å‚ä¸æ¢¯åº¦ï¼‰â€”â€”ä¼˜åŒ–çš„æ˜¯ f-æ•£åº¦è€Œéåå‘ KL</li>
</ul>

<p><strong>Off-policy</strong>ï¼ˆ$\mu \neq q_\theta$ï¼‰ï¼š</p>

<ul>
  <li>$\rho = \frac{q_\theta}{\mu}$ï¼ˆæ ‡å‡†é‡è¦æ€§æƒé‡ï¼‰</li>
  <li><strong>å¯ç”¨</strong>ï¼š$\rho k_1$ï¼ˆæ–¹å·®é«˜ï¼‰ã€$\text{sg}(\rho) k_2$ï¼ˆæ¨èï¼‰ã€$\rho k_3$ï¼ˆæ¨èï¼‰â€”â€”ä¸‰è€…å‡ç»™å‡ºåå‘ KL æ¢¯åº¦</li>
  <li><strong>ä¸å¯ç”¨</strong>ï¼š$\rho k_2$ï¼ˆ$\rho$ å‚ä¸æ¢¯åº¦ï¼‰â€”â€”ä¼˜åŒ–çš„æ˜¯ f-æ•£åº¦è€Œéåå‘ KL</li>
</ul>

<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šon-policy æ—¶ $k_2$ èƒ½ç›´æ¥å·¥ä½œï¼Œæœ¬è´¨ä¸Šæ˜¯å› ä¸º $k_2$ çš„æ¢¯åº¦å½¢å¼ $-\log\frac{p}{q_\theta} \cdot s_\theta = k_1 \cdot s_\theta$ æ°å¥½ç­‰äº $\rho s_\theta k_1$ï¼ˆå½“ $\rho \equiv 1$ æ—¶ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªã€Œå·§åˆã€ï¼Œè€Œéä¸€èˆ¬è§„å¾‹ã€‚</p>

<p>å…³äºå¤§æ¨¡å‹ off-policy åœºæ™¯çš„æ·±å…¥åˆ†æï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ï¼š<a href="/reinforcement-learning/2025/11/15/three-policy-zh.html">ä»ä¸¤ç­–ç•¥åˆ°ä¸‰ç­–ç•¥ï¼šLLM RL ä¸­è¡Œä¸ºç­–ç•¥â€“å‚è€ƒç­–ç•¥ä¸ä¸€è‡´ä¸‹çš„ TRPO æ‰©å±•</a>ã€‚</p>

<h3 id="æ–¹å·®åˆ†æ">æ–¹å·®åˆ†æ</h3>

<p>å‰é¢æˆ‘ä»¬çœ‹åˆ°ï¼Œç»™å‡ºåå‘ KL æ— åæ¢¯åº¦çš„æœ‰ä¸‰ä¸ªé€‰æ‹©ï¼š$\rho k_1$ã€$\text{sg}(\rho) k_2$ã€$\rho k_3$ã€‚å®ƒä»¬çš„æ¢¯åº¦éšæœºå˜é‡åˆ†åˆ«ä¸ºï¼ˆæ³¨æ„ $s_\theta$ æ˜¯å‘é‡ï¼Œå› æ­¤æ¢¯åº¦ä¹Ÿæ˜¯å‘é‡ï¼‰ï¼š</p>

<p>$$
g_1(x) = \rho(x) s_\theta(x) (k_1(x) + 1), \quad g_\star(x) = \rho(x) s_\theta(x) k_1(x)
$$</p>

<p>å…¶ä¸­ $g_\star$ å¯¹åº” $\text{sg}(\rho) k_2$ å’Œ $\rho k_3$ï¼ˆä¸¤è€…å®Œå…¨ç›¸åŒï¼‰ã€‚</p>

<p>ä¸ºäº†é¿å…â€œå‘é‡æ¢¯åº¦çš„æ–¹å·®â€è¿™ä¸€è¡¨è¿°çš„æ­§ä¹‰ï¼Œæˆ‘ä»¬æ¯”è¾ƒä»»æ„æ–¹å‘ä¸Šçš„æŠ•å½±æ–¹å·®ï¼šå–ä»»æ„å•ä½å‘é‡ $u$ï¼Œå®šä¹‰æ ‡é‡éšæœºå˜é‡</p>

<p>$$
g_1^{(u)} := u^\top g_1, \quad g_\star^{(u)} := u^\top g_\star.
$$</p>

<p>ä»¤ $A_u(x) := \rho(x)\, u^\top s_\theta(x)$ï¼Œ$B(x) := k_1(x)$ï¼Œåˆ™</p>

<p>$$
g_1^{(u)} = A_u(B+1), \quad g_\star^{(u)} = A_u B.
$$</p>

<p>ä¸¤è€…æœŸæœ›ç›¸åŒï¼Œä¸”ä»»æ„æ–¹å‘ä¸Šçš„æ–¹å·®ä¹‹å·®ä¸º</p>

<p>$$
\boxed{
\mathrm{Var}_\mu\big(g_1^{(u)}\big) - \mathrm{Var}_\mu\big(g_\star^{(u)}\big)
= \mathbb{E}_\mu\big[A_u(x)^2 \big(2B(x)+1\big)\big]
= \mathbb{E}_\mu\Big[\rho(x)^2\,\big(u^\top s_\theta(x)\big)^2\,\big(2k_1(x)+1\big)\Big].
}
$$</p>

<p>ï¼ˆä½ ä¹Ÿå¯ä»¥å°†æ­¤ç†è§£ä¸ºå¯¹æ¯ä¸ªåæ ‡åˆ†é‡åˆ†åˆ«æ¯”è¾ƒæ–¹å·®ï¼›ç»“è®ºä¸ç›´è§‚é‡çº§åˆ¤æ–­ä¸€è‡´ã€‚ï¼‰</p>

<p><strong>åœ¨å…¸å‹çš„ KL æƒ©ç½šåœºæ™¯ä¸‹</strong>ï¼ˆ$q_\theta \approx p \approx \mu$ï¼‰ï¼Œå– $\frac{p(x)}{q_\theta(x)} = 1 + \varepsilon(x)$ï¼Œ$|\varepsilon| \ll 1$ï¼š</p>

<ul>
  <li>$k_1 = -\log \frac{p}{q_\theta} \approx -\varepsilon$</li>
  <li>$2k_1 + 1 \approx 1 - 2\varepsilon$ï¼Œä¸»å¯¼é¡¹ä¸ºæ­£çš„ $O(1)$ å¸¸æ•°</li>
</ul>

<p>å› æ­¤ $\mathrm{Var}_\mu(g_1) > \mathrm{Var}_\mu(g_\star)$ã€‚</p>

<p><strong>æ ¸å¿ƒç›´è§‚ç†è§£</strong>ï¼š</p>

<ul>
  <li>$g_1 = \rho s_\theta (k_1 + 1)$ åŒ…å«ä¸€ä¸ªé‡çº§ä¸º $O(1)$ çš„é›¶å‡å€¼å™ªå£°é¡¹ $\rho s_\theta$</li>
  <li>$g_\star = \rho s_\theta k_1$ å·²å°†è¯¥å¸¸æ•°å™ªå£°é¡¹æ¶ˆå»ï¼Œå‰©ä¸‹ä¸ $\varepsilon$ æˆæ­£æ¯”çš„ä¸€é˜¶å°é‡</li>
</ul>

<p><strong>æ–¹å·®å¯¹æ¯”è¡¨æ ¼</strong>ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">æ¢¯åº¦éšæœºå˜é‡</th>
      <th style="text-align: center">ç³»æ•°é‡çº§ï¼ˆ$\frac{p}{q_\theta}\approx1$ï¼‰</th>
      <th style="text-align: center">æ–¹å·®</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$\rho k_1$</td>
      <td style="text-align: center">$\rho s_\theta (k_1+1)$</td>
      <td style="text-align: center">$O(1)$</td>
      <td style="text-align: center">é«˜</td>
    </tr>
    <tr>
      <td style="text-align: center">$\text{sg}(\rho) k_2$</td>
      <td style="text-align: center">$\rho s_\theta k_1$</td>
      <td style="text-align: center">$O(\varepsilon)$</td>
      <td style="text-align: center">ä½</td>
    </tr>
    <tr>
      <td style="text-align: center">$\rho k_3$</td>
      <td style="text-align: center">$\rho s_\theta k_1$</td>
      <td style="text-align: center">$O(\varepsilon)$</td>
      <td style="text-align: center">ä½</td>
    </tr>
  </tbody>
</table>

<p><strong>ç»“è®º</strong>ï¼š$\text{sg}(\rho) k_2$ ä¸ $\rho k_3$ åœ¨æ¢¯åº¦å±‚é¢å®Œå…¨ç­‰ä»·â€”â€”åŒå‡å€¼ã€åŒæ–¹å·®ã€åŒé«˜é˜¶çŸ©ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œ$\rho k_1$ çš„æ¢¯åº¦å¤šäº†ä¸€ä¸ªé›¶å‡å€¼çš„å¸¸æ•°å™ªå£°é¡¹ï¼Œåœ¨å…¸å‹çš„ KL æƒ©ç½šåœºæ™¯ä¸‹å…¶æ–¹å·®å¤§çº¦é«˜ä¸€ä¸ªé‡çº§ã€‚</p>

<blockquote>
  <p><strong>å®è·µå»ºè®®</strong>ï¼šè‹¥ä¼˜åŒ–åå‘ KLï¼Œé¦–é€‰ $\rho k_3$ æˆ– $\text{sg}(\rho) k_2$ï¼ˆä¸¤è€…æ¢¯åº¦ç­‰ä»·ä¸”æ–¹å·®ä½ï¼‰ï¼›$\rho k_1$ è™½æ— åä½†æ–¹å·®é«˜ï¼Œå¯ä½œä¸ºå¤‡é€‰å¹¶éœ€é…åˆ clipping/æ­£åˆ™åŒ–ã€‚</p>
</blockquote>

<p><strong>æåº¦ off-policy æ—¶çš„è­¦ç¤º</strong>ï¼š</p>

<p>å½“ $\mu$ ä¸ $q_\theta$ å·®å¼‚å¾ˆå¤§æ—¶â€”â€”ä¾‹å¦‚ $\mu$ åœ¨ $q_\theta$ çš„é«˜å¯†åº¦åŒºåŸŸå‡ ä¹æ²¡æœ‰é‡‡æ ·ï¼Œæˆ– $\rho = q_\theta / \mu$ åœ¨å°¾éƒ¨çˆ†ç‚¸â€”â€”ä»»ä½•åŸºäº $\rho$ çš„æ–¹æ³•éƒ½ä¼šé­é‡ä¸¥é‡çš„æ–¹å·®é—®é¢˜ã€‚æ­¤æ—¶ï¼Œ$\rho k_3$ï¼ˆæˆ– $\text{sg}(\rho) k_2$ï¼‰ç›¸å¯¹äº $\rho k_1$ çš„ä¼˜åŠ¿ä¸å†æœ‰ç†è®ºä¿è¯ï¼Œéœ€è¦ç»“åˆ clippingã€æ­£åˆ™åŒ–ç­‰ç­–ç•¥ç»¼åˆå¤„ç†ã€‚</p>

<p>ä¸è¿‡ï¼Œåœ¨ RL å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæ§åˆ¶ KL çº¦æŸã€é™åˆ¶ off-policy ç¨‹åº¦ï¼ˆä¾‹å¦‚ä½¿ç”¨è¿‘é‚»ç­–ç•¥ $\mu = q_{\theta_\text{old}}$ï¼‰ã€‚åœ¨è¿™ä¸ªå¸¸è§çš„åœºæ™¯ä¸­ï¼Œå¯ä»¥ç›¸å½“æœ‰ä¿¡å¿ƒåœ°è¯´ï¼š</p>

<blockquote>
  <p><strong>å¦‚æœå·²ç»å†³å®šç”¨é‡è¦æ€§é‡‡æ ·æ¥ä¼˜åŒ–åå‘ KLï¼Œæ¨èä½¿ç”¨ $\rho k_3$ æˆ– $\text{sg}(\rho) k_2$ï¼ˆä¸¤è€…æ¢¯åº¦ç­‰ä»·ä¸”æ–¹å·®ä½ï¼‰ï¼›ç›¸è¾ƒä¹‹ä¸‹ï¼Œ$\rho k_1$ æ–¹å·®æ›´é«˜ã€‚</strong></p>
</blockquote>

<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ DeepSeek v3.2 æŠ€æœ¯æŠ¥å‘Šä¸­ä½¿ç”¨çš„æ˜¯ $\frac{q_\theta}{\mu} k_3$ ä½œä¸º off-policy KL æƒ©ç½šçš„ä¼°è®¡å™¨ã€‚</p>

<figure style="text-align:center;">
<img src="/assets/img/kl-estimators/dpsk-3d2-k3.png" style="width:95%;max-width:100%;" />
<figcaption style="font-size:0.9em;color:gray;">å›¾ç‰‡æ¥æºï¼š<a href="https://arxiv.org/pdf/2512.02556v1">DeepSeek v3.2 æŠ€æœ¯æŠ¥å‘Š 3.1 ç« èŠ‚</a></figcaption>
</figure>

<h4 id="æ¢¯åº¦åˆ†ææ€»è§ˆè¡¨">æ¢¯åº¦åˆ†ææ€»è§ˆè¡¨</h4>

<p>ç»¼åˆä»¥ä¸Šåˆ†æï¼Œä¸‹è¡¨æ±‡æ€»äº†ç»Ÿä¸€æ¡†æ¶ä¸‹å„ä¼°è®¡å™¨çš„æ¢¯åº¦æœŸæœ›åŠå…¶å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">é‡‡æ ·ç±»å‹</th>
      <th style="text-align: center">Loss</th>
      <th style="text-align: center">$\nabla_\theta$ Loss çš„æœŸæœ›</th>
      <th style="text-align: center">å¯¹åº”çš„ä¼˜åŒ–ç›®æ ‡</th>
      <th style="text-align: center">èƒ½å¦ç”¨äºä¼˜åŒ–åå‘ KLï¼Ÿ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">on/off-policy</td>
      <td style="text-align: center">$\rho k_1$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“ï¼ˆä½†æ–¹å·®è¾ƒé«˜ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">on/off-policy</td>
      <td style="text-align: center">$\rho k_2$</td>
      <td style="text-align: center">$\nabla_\theta \mathbb{E}_{q_\theta}[k_2]$</td>
      <td style="text-align: center">f-æ•£åº¦ï¼ˆéåå‘ KLï¼‰</td>
      <td style="text-align: center">âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">on/off-policy</td>
      <td style="text-align: center">$\text{sg}(\rho) k_2$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“ï¼ˆæ¨èï¼Œä½æ–¹å·®ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">on/off-policy</td>
      <td style="text-align: center">$\rho k_3$</td>
      <td style="text-align: center">$\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)$</td>
      <td style="text-align: center">åå‘ KL</td>
      <td style="text-align: center">âœ“ï¼ˆæ¨èï¼Œä½æ–¹å·®ï¼‰</td>
    </tr>
  </tbody>
</table>

<p>å…¶ä¸­ $\rho = \frac{q_\theta}{\text{sg}(\mu)}$ã€‚å½“ on-policyï¼ˆ$\mu = q_\theta$ï¼‰æ—¶ï¼Œ$\rho \equiv 1$ã€‚</p>

<p>éœ€è¦ç‰¹åˆ«å¼ºè°ƒï¼š<strong>ä¸Šè¡¨çš„ç»“è®ºé’ˆå¯¹çš„æ˜¯ â€œloss å†™æˆ $L=\rho\,k$ ä¸” $\rho$ åœ¨è®¡ç®—å›¾ä¸­ä¿ç•™æ¢¯åº¦è·¯å¾„â€ çš„ç»Ÿä¸€æ¡†æ¶</strong>ã€‚åœ¨ on-policy æ—¶ï¼Œè™½ç„¶æ•°å€¼ä¸Š $\rho\equiv 1$ï¼Œä½†ç”±äº $\rho=\frac{q_\theta}{\text{sg}(q_\theta)}$ï¼Œä»æœ‰ $\nabla_\theta\rho=s_\theta\neq 0$ï¼Œå› æ­¤ $\rho k$ ä¸â€œç›´æ¥å¯¹ $k$ çš„æ ·æœ¬å‡å€¼åå‘ä¼ æ’­â€åœ¨æ¢¯åº¦ä¸Šå¹¶ä¸ç­‰ä»·ã€‚</p>

<p>å¦‚æœä½ é‡‡ç”¨çš„æ˜¯<strong>æœ´ç´  on-policy å†™æ³•</strong>ï¼ˆå³ä» $q_\theta$ é‡‡æ ·åï¼Œå°† $\{k_i(x)\}$ è§†ä¸ºæ™®é€šæ ‡é‡ï¼Œå¯¹å…¶æ ·æœ¬å‡å€¼ç›´æ¥åå‘ä¼ æ’­ï¼›ä¸æ˜¾å¼æ„é€  $\rho=\frac{q_\theta}{\text{sg}(q_\theta)}$ æ¥è¡¥ä¸Š score-function è·¯å¾„ï¼‰ï¼Œåˆ™ä¼šé€€åŒ–ä¸ºï¼š</p>

<ul>
  <li>ç›´æ¥ä½¿ç”¨ $k_1$ï¼š$\mathbb{E}_{q_\theta}[\nabla k_1]=0$ï¼ˆæ— æ•ˆï¼‰</li>
  <li>ç›´æ¥ä½¿ç”¨ $k_2$ï¼š$\mathbb{E}_{q_\theta}[\nabla k_2]=\nabla D_{\mathrm{KL}}(q_\theta\|p)$ï¼ˆåå‘ KLï¼‰âœ“</li>
  <li>ç›´æ¥ä½¿ç”¨ $k_3$ï¼š$\mathbb{E}_{q_\theta}[\nabla k_3]=\nabla D_{\mathrm{KL}}(p\|q_\theta)$ï¼ˆæ­£å‘ KLï¼‰âœ—</li>
</ul>

<p><strong>å…³é”®ç»“è®º</strong>ï¼š</p>

<ol>
  <li><strong>On-policy ä¼˜åŒ–åå‘ KLï¼ˆæœ´ç´ ç›´æ¥åå‘ä¼ æ’­çš„å®ç°ï¼‰</strong>ï¼šå”¯ä¸€æ­£ç¡®é€‰æ‹©æ˜¯ $k_2$</li>
  <li><strong>Off-policy ä¼˜åŒ–åå‘ KL</strong>ï¼šæœ‰ä¸‰ä¸ªæ­£ç¡®é€‰é¡¹ï¼š
    <ul>
      <li>$\rho k_1$ï¼šæ— åä½†æ–¹å·®è¾ƒé«˜</li>
      <li>$\text{sg}(\rho) k_2$ï¼šæ— åï¼Œä¸ $\rho k_3$ <strong>æ¢¯åº¦å®Œå…¨ç­‰ä»·</strong></li>
      <li>$\rho k_3$ï¼šæ— åä¸”æ–¹å·®æ›´ä½ï¼ˆä¸ä¸Šä¸€é¡¹ç­‰ä»·ï¼Œå‡ä¸ºæ¨èé€‰æ‹©ï¼‰</li>
    </ul>
  </li>
  <li><strong>$\rho k_2$ï¼ˆæƒé‡å‚ä¸æ¢¯åº¦ï¼‰å¤±æ•ˆ</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªå®¹æ˜“è¢«å¿½è§†çš„é™·é˜±</li>
</ol>

<h2 id="ä½œä¸º-reward-æ—¶çš„æ¢¯åº¦åˆ†æ">ä½œä¸º Reward æ—¶çš„æ¢¯åº¦åˆ†æ</h2>

<p>å‰æ–‡åˆ†æäº† KL ä½œä¸º Loss æ—¶å„ä¼°è®¡å™¨çš„æ¢¯åº¦æ€§è´¨ã€‚ä¸€ä¸ªè‡ªç„¶çš„æƒ³æ³•æ˜¯ï¼šæ—¢ç„¶ $k_1$ å’Œ $k_3$ å¯¹åå‘ KL æ•°å€¼éƒ½æ˜¯æ— åçš„ï¼ˆè§ã€Œæ•°å€¼ä¼°è®¡ã€ç« èŠ‚ï¼‰ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ï¼ˆåŠ  stop-gradientï¼‰ä½œä¸º reward æƒ©ç½šåº”è¯¥éƒ½æ²¡é—®é¢˜ã€‚</p>

<p><strong>ä½†è¿™æ˜¯é”™è¯¯çš„ã€‚</strong></p>

<p>é—®é¢˜åœ¨äºï¼šå½“ KL ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œè™½ç„¶ KL é¡¹æœ¬èº«ä¸åå‘ä¼ æ’­æ¢¯åº¦ï¼Œä½†å®ƒä¼šé€šè¿‡ advantage é—´æ¥å½±å“ç­–ç•¥æ¢¯åº¦ã€‚å› æ­¤ï¼Œè¯„ä»·ä¸€ä¸ªä¼°è®¡å™¨ã€Œèƒ½å¦ç”¨äº reward æƒ©ç½šã€ï¼Œä¸åº”åªçœ‹æ•°å€¼åå·®ï¼Œè€Œåº”çœ‹<strong>å®ƒè¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ˜¯å¦æ­£ç¡®</strong>ã€‚</p>

<h3 id="çœŸæ­£çš„-kl-æ­£åˆ™åŒ–ç­–ç•¥æ¢¯åº¦">çœŸæ­£çš„ KL æ­£åˆ™åŒ–ç­–ç•¥æ¢¯åº¦</h3>

<p>è€ƒè™‘ KL æ­£åˆ™åŒ–çš„å¼ºåŒ–å­¦ä¹ ç›®æ ‡ï¼š</p>

<p>$$
J(\theta) = \mathbb{E}_{q_\theta}[R] - \beta \cdot D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>å…¶è§£ææ¢¯åº¦ä¸ºï¼š</p>

<p>$$
\nabla_\theta J = \mathbb{E}_{q_\theta}[s_\theta \cdot R] - \beta \cdot \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p>åˆ©ç”¨å‰æ–‡ã€Œå‡†å¤‡å·¥ä½œã€ç« èŠ‚çš„ç»“è®ºï¼Œåå‘ KL çš„æ¢¯åº¦ä¸ºï¼š</p>

<p>$$
\nabla_\theta D_{\mathrm{KL}}(q_\theta \| p) = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(-\log \frac{p}{q_\theta}\right)\right] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]
$$</p>

<p>å› æ­¤ï¼ŒçœŸæ­£çš„ KL æ­£åˆ™åŒ–ç­–ç•¥æ¢¯åº¦æ˜¯ï¼š</p>

<p>$$
\nabla_\theta J = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(R - \beta \cdot k_1\right)\right]
$$</p>

<h4 id="ä½¿ç”¨ä¼°è®¡å™¨-inlmath393mathend-æ—¶çš„æ¢¯åº¦å½¢å¼">ä½¿ç”¨ä¼°è®¡å™¨ $\hat{k}$ æ—¶çš„æ¢¯åº¦å½¢å¼</h4>

<p>å½“æˆ‘ä»¬ä½¿ç”¨æŸä¸ªä¼°è®¡å™¨ $\hat{k}$ï¼ˆåŠ  stop-gradientï¼‰ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œshaped reward ä¸º $\tilde{R} = R - \beta \cdot \text{sg}(\hat{k})$ï¼Œç­–ç•¥æ¢¯åº¦å˜ä¸ºï¼š</p>

<p>$$
\nabla_\theta \tilde{J} = \mathbb{E}_{q_\theta}\left[s_\theta \cdot (R - \beta \cdot \hat{k})\right]
$$</p>

<p><strong>æ— åæ¡ä»¶</strong>ï¼š$\nabla_\theta \tilde{J} = \nabla_\theta J$ å½“ä¸”ä»…å½“</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot \hat{k}] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]
$$</p>

<h4 id="ä½¿ç”¨-inlmath397mathend-ä½œä¸ºæƒ©ç½šæ¢¯åº¦æ— å">ä½¿ç”¨ $k_1$ ä½œä¸ºæƒ©ç½šï¼šæ¢¯åº¦æ— å</h4>

<p>å½“ $\hat{k} = k_1$ æ—¶ï¼Œæ¡ä»¶è‡ªåŠ¨æ»¡è¶³ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot k_1] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1] \quad \checkmark
$$</p>

<p>å› æ­¤ï¼Œ<strong>$k_1$ ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œè¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ˜¯æ— åçš„</strong>ã€‚</p>

<h4 id="ä½¿ç”¨-inlmath400mathend-ä½œä¸ºæƒ©ç½šæ¢¯åº¦æœ‰å">ä½¿ç”¨ $k_3$ ä½œä¸ºæƒ©ç½šï¼šæ¢¯åº¦æœ‰å</h4>

<p>å½“ $\hat{k} = k_3 = \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}$ æ—¶ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot k_3] = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(\frac{p}{q_\theta} - 1\right)\right] + \mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(-\log \frac{p}{q_\theta}\right)\right]
$$</p>

<p>ç¬¬äºŒé¡¹æ­£æ˜¯ $\mathbb{E}_{q_\theta}[s_\theta \cdot k_1]$ã€‚é—®é¢˜å‡ºåœ¨ç¬¬ä¸€é¡¹ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}\left[s_\theta \cdot \left(\frac{p}{q_\theta} - 1\right)\right] = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q_\theta}\right] - \underbrace{\mathbb{E}_{q_\theta}[s_\theta]}_{=0} = \mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q_\theta}\right]
$$</p>

<p>è€Œè¿™ä¸ªé‡å¯ä»¥æ”¹å†™ä¸ºï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q_\theta}\right] = \int q_\theta(x) \cdot \nabla_\theta \log q_\theta(x) \cdot \frac{p(x)}{q_\theta(x)} dx = \int p(x) \cdot \nabla_\theta \log q_\theta(x) dx = \mathbb{E}_p[s_\theta]
$$</p>

<p>åˆ©ç”¨æ­£å‘ KL çš„æ¢¯åº¦å…¬å¼ $\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta) = -\mathbb{E}_p[s_\theta]$ï¼Œæœ‰ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}\left[s_\theta \cdot \frac{p}{q_\theta}\right] = -\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta)
$$</p>

<p>å› æ­¤ï¼š</p>

<p>$$
\mathbb{E}_{q_\theta}[s_\theta \cdot k_3] = \underbrace{-\nabla_\theta D_{\mathrm{KL}}(p \| q_\theta)}_{\text{åå·®é¡¹}} + \nabla_\theta D_{\mathrm{KL}}(q_\theta \| p)
$$</p>

<p><strong>$k_3$ ä½œä¸º reward æƒ©ç½šæ—¶ï¼Œæ¢¯åº¦æ˜¯æœ‰åçš„</strong>ï¼Œåå·®é¡¹ç­‰äºæ­£å‘ KL æ¢¯åº¦çš„è´Ÿå€¼ã€‚</p>

<p><strong>åå·®çš„å‡ ä½•å«ä¹‰</strong>ï¼šä½¿ç”¨ $k_3$ ä½œä¸º reward æƒ©ç½šï¼Œç›¸å½“äºåœ¨ä¼˜åŒ–ä¸€ä¸ªã€Œé”™è¯¯çš„æ··åˆç›®æ ‡ã€ï¼š</p>

<ul>
  <li>æ—¢æƒ©ç½šåå‘ KLï¼ˆå¸Œæœ›ç­–ç•¥ä¸åç¦»å‚è€ƒï¼‰</li>
  <li>åˆ<strong>é”™è¯¯åœ°é¼“åŠ±æ­£å‘ KL å˜å¤§</strong>ï¼ˆå¸Œæœ›å‚è€ƒä¸è¦†ç›–ç­–ç•¥ï¼‰</li>
</ul>

<p>è¿™ä¸¤ä¸ªæ–¹å‘ç›¸äº’å†²çªï¼Œå¯èƒ½å¯¼è‡´ä¼˜åŒ–ä¸ç¨³å®šã€‚</p>

<p><strong>å®éªŒéªŒè¯</strong>ï¼šShah et al. (2025) çš„å®éªŒè¡¨æ˜ï¼Œåœ¨ on-policy RL å¾®è°ƒ LLM æ—¶ï¼š</p>

<ul>
  <li><strong>$k_1$ in reward</strong>ï¼šè®­ç»ƒç¨³å®š</li>
  <li><strong>$k_3$ in reward</strong>ï¼š<strong>è®­ç»ƒå´©æºƒ</strong></li>
</ul>

<p>è¿™ä¸æˆ‘ä»¬çš„ç†è®ºåˆ†æå®Œå…¨ä¸€è‡´ã€‚</p>

<h4 id="off-policy-åœºæ™¯ä¸‹çš„ç»“è®º">Off-policy åœºæ™¯ä¸‹çš„ç»“è®º</h4>

<p>ä¸Šè¿°åˆ†æå‡è®¾ on-policy é‡‡æ ·ã€‚åœ¨ off-policy åœºæ™¯ä¸‹ï¼Œç»“è®ºæ˜¯å¦æ”¹å˜ï¼Ÿ</p>

<p>è®¾æ ·æœ¬æ¥è‡ªè¡Œä¸ºç­–ç•¥ $\mu$ï¼Œä½¿ç”¨é‡è¦æ€§åŠ æƒçš„ç­–ç•¥æ¢¯åº¦ï¼š</p>

<p>$$
\nabla_\theta \tilde{J} = \mathbb{E}_\mu\left[\frac{q_\theta}{\mu} \cdot s_\theta \cdot (R - \beta \cdot k)\right]
$$</p>

<p>åˆ©ç”¨ $\mathbb{E}_\mu[\frac{q_\theta}{\mu} \cdot f] = \mathbb{E}_{q_\theta}[f]$ï¼Œä¸Šå¼ç­‰äºï¼š</p>

<p>$$
= \mathbb{E}_{q_\theta}[s_\theta \cdot R] - \beta \cdot \mathbb{E}_{q_\theta}[s_\theta \cdot k]
$$</p>

<p><strong>æ— åæ¡ä»¶</strong>ä»ç„¶æ˜¯ $\mathbb{E}_{q_\theta}[s_\theta \cdot k] = \mathbb{E}_{q_\theta}[s_\theta \cdot k_1]$ï¼Œä¸ on-policy å®Œå…¨ç›¸åŒã€‚</p>

<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šåœ¨ off-policy ç­–ç•¥æ¢¯åº¦æ¡†æ¶ä¸‹ï¼Œé‡è¦æ€§æƒé‡ $\frac{q_\theta}{\mu}$ ä½œç”¨äºæ•´ä¸ªç­–ç•¥æ¢¯åº¦ä¼°è®¡å™¨ï¼Œ<strong>ä¸éœ€è¦å¯¹ shaped reward ä¸­çš„ KL ä¼°è®¡å™¨å•ç‹¬åŠ æƒ</strong>ã€‚å› æ­¤ï¼š</p>

<ul>
  <li>Shaped reward ä¿æŒåŸå½¢å¼ï¼š$\tilde{R} = R - \beta \cdot k_1$ï¼ˆä¸æ˜¯ $R - \beta \cdot \frac{q_\theta}{\mu} k_1$ï¼‰</li>
  <li>åœ¨æœ¬æ–‡è®¨è®ºçš„ <strong>stop-grad reward shaping</strong>ï¼ˆ$\tilde{R}=R-\beta\,\text{sg}(k)$ï¼‰ä¸”ç›®æ ‡ä¸º <strong>åå‘ KL æ­£åˆ™</strong> çš„è®¾å®šä¸‹ï¼šç»“è®ºä¸ on-policy ç›¸åŒï¼Œ<strong>åªèƒ½ç”¨ $k_1$ï¼Œä¸èƒ½ç”¨ $k_3$</strong></li>
</ul>

<h3 id="å…³é”®å‘ç°åªæœ‰-inlmath417mathend-å¯ç”¨äº-reward-æƒ©ç½š">å…³é”®å‘ç°ï¼šåªæœ‰ $k_1$ å¯ç”¨äº Reward æƒ©ç½š</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">æ•°å€¼æ— åï¼Ÿ</th>
      <th style="text-align: center">ä½œä¸º Reward æƒ©ç½šæ—¶æ¢¯åº¦æ— åï¼Ÿ</th>
      <th style="text-align: center">å®é™…è¡¨ç°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">ç¨³å®š</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">âœ—</td>
      <td style="text-align: center">å´©æºƒ</td>
    </tr>
  </tbody>
</table>

<p><strong>æ ¸å¿ƒæ•™è®­</strong>ï¼šè¯„ä»· KL ä¼°è®¡å™¨æ—¶ï¼Œã€Œæ•°å€¼æ— åã€å’Œã€Œæ¢¯åº¦æ­£ç¡®ã€æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç»´åº¦ã€‚å¯¹äºæœ¬æ–‡è®¨è®ºçš„ reward æƒ©ç½šç”¨æ³•ï¼ˆstop-grad reward shapingï¼Œç›®æ ‡ä¸ºåå‘ KL æ­£åˆ™ï¼›æ— è®º on-policy è¿˜æ˜¯ off-policyï¼‰ï¼Œ<strong>åªæœ‰ $k_1$ æ˜¯æ­£ç¡®çš„é€‰æ‹©</strong>ã€‚$k_3$ è™½ç„¶æ•°å€¼æ— åä¸”æ–¹å·®æ›´ä½ï¼Œä½†ä½œä¸º reward æƒ©ç½šä¼šå¯¼è‡´æ¢¯åº¦æœ‰åï¼Œå¯èƒ½å¼•å‘è®­ç»ƒå´©æºƒã€‚</p>

<p>åˆ°è¿™é‡Œå®¹æ˜“äº§ç”Ÿä¸€ä¸ªâ€œè¡¨é¢çŸ›ç›¾â€ï¼š</p>

<ul>
  <li>åœ¨ <strong>Reward æƒ©ç½š</strong>é‡Œæˆ‘ä»¬å¼ºè°ƒâ€œåªèƒ½ç”¨ $k_1$â€ï¼›</li>
  <li>ä½†åœ¨å‰æ–‡ <strong>Loss åä¼ </strong>ï¼ˆå°¤å…¶ off-policyï¼‰é‡Œï¼Œæˆ‘ä»¬åˆæ¨èç”¨ $\rho k_3$ æˆ– $\text{sg}(\rho)k_2$ æ¥è·å¾—æ›´ä½æ–¹å·®çš„åå‘ KL æ¢¯åº¦ã€‚</li>
</ul>

<p>ä¸‹ä¸€èŠ‚å°†è§£é‡Šï¼šä¸¤è€…å¹¶ä¸å†²çªâ€”â€”åœ¨â€œKL æ­£åˆ™é¡¹å¯¹ç­–ç•¥æ›´æ–°çš„é‚£ä¸€éƒ¨åˆ†â€ä¸Šï¼Œå®ƒä»¬ç”šè‡³å¯ä»¥åšåˆ°<strong>æ ·æœ¬çº§å®Œå…¨ç­‰ä»·</strong>ï¼›å·®å¼‚ä¸»è¦æ¥è‡ª KL æ˜¯å¦è¿›å…¥ advantage/baselineã€ä»¥åŠä¿¡ç”¨åˆ†é…ï¼ˆcredit assignmentï¼‰çš„è·¯å¾„ã€‚</p>

<h2 id="inlmath425mathend-in-reward-ä¸ä½æ–¹å·®-kl-in-loss-çš„ç­‰ä»·æ€§ä¸å·®å¼‚">$k_1$ in Reward ä¸ä½æ–¹å·® KL in Loss çš„ç­‰ä»·æ€§ä¸å·®å¼‚</h2>

<p>å‰é¢æˆ‘ä»¬åˆ†åˆ«åˆ†æäº† KL ä½œä¸º Loss å’Œä½œä¸º Reward ä¸¤ç§ä½¿ç”¨æ–¹å¼ã€‚ä¸€ä¸ªè‡ªç„¶çš„é—®é¢˜æ˜¯ï¼š<strong>è¿™ä¸¤ç§æ–¹å¼åœ¨ä»€ä¹ˆæ„ä¹‰ä¸Šç­‰ä»·ï¼Œåˆåœ¨ä»€ä¹ˆæ„ä¹‰ä¸Šä¸åŒï¼Ÿ</strong> æœ¬èŠ‚å°†æ·±å…¥æ¢è®¨è¿™ä¸ªé—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§æ¨¡å‹ RL çš„å®è·µåœºæ™¯ä¸‹ã€‚</p>

<h3 id="kl-æ¢¯åº¦é¡¹çš„æ ·æœ¬çº§ç­‰ä»·æ€§">KL æ¢¯åº¦é¡¹çš„æ ·æœ¬çº§ç­‰ä»·æ€§</h3>

<p>æœ¬èŠ‚åªæ¯”è¾ƒâ€œKL æ­£åˆ™åŒ–å¸¦æ¥çš„é‚£ä¸€é¡¹ç­–ç•¥æ¢¯åº¦â€ï¼Œå¹¶ç»Ÿä¸€å†™æˆ <strong>policy gradient çš„ä¸Šå‡æ–¹å‘</strong> $\nabla_\theta J$ï¼ˆè‹¥ä½ åœ¨ä»£ç é‡Œæœ€å°åŒ– lossï¼Œåˆ™æ•´ä½“åªå·®ä¸€ä¸ªå…¨å±€è´Ÿå·ï¼Œä¸å½±å“ç­‰ä»·æ€§ç»“è®ºï¼‰ã€‚åŒæ—¶é»˜è®¤ä½ ä½¿ç”¨çš„æ˜¯æœ¬æ–‡å‰æ–‡çš„ç»Ÿä¸€æƒé‡è®°å·ï¼šæ ·æœ¬æ¥è‡ª $x\sim\mu$ï¼Œé‡è¦æ€§æƒé‡ $\rho=\frac{q_\theta}{\text{sg}(\mu)}$ ä½œç”¨åœ¨ç­–ç•¥æ¢¯åº¦ä¼°è®¡å™¨ä¸Šã€‚</p>

<p>å›é¡¾å‰æ–‡çš„å…³é”®ç»“è®ºï¼š</p>

<p><strong>KL ä½œä¸º Lossï¼ˆä½æ–¹å·®é€‰æ‹©ï¼‰</strong>ï¼šå‰æ–‡å·²è¯æ˜ï¼Œé‡‡ç”¨ $\text{sg}(\rho) k_2$ æˆ– $\rho k_3$ ä½œä¸ºæ­£åˆ™é¡¹æ—¶ï¼Œæ¢¯åº¦éšæœºå˜é‡éƒ½åŒ–ç®€ä¸º</p>

<p>$$
\nabla_\theta(\text{sg}(\rho) k_2) = \nabla_\theta(\rho k_3) = \rho s_\theta k_1
$$</p>

<p><strong>KL ä½œä¸º Rewardï¼ˆ$k_1$ in rewardï¼‰</strong>ï¼šshaped reward ä¸º $\tilde{R} = R - \beta \cdot k_1$ï¼ˆå¯¹ $k_1$ åš stop-gradient åªæ˜¯åœ¨å®ç°ä¸Šé¿å…â€œKL ç›´æ¥åä¼ â€ï¼Œä¸æ”¹å˜å®ƒä½œä¸ºæƒ©ç½šçš„æ•°å€¼ï¼‰ã€‚åœ¨â€œç­–ç•¥æ¢¯åº¦é¡¹â€é‡Œï¼ŒKL æƒ©ç½šè´¡çŒ®çš„æ˜¯</p>

<p>$$
\mathbb{E}_\mu[\rho s_\theta \cdot (-\beta k_1)] = -\beta \cdot \mathbb{E}_\mu[\rho s_\theta k_1]
$$</p>

<p><strong>å…³é”®å‘ç°</strong>ï¼šä¸¤è€…çš„ KL æ¢¯åº¦é¡¹<strong>æ ·æœ¬çº§å®Œå…¨ç›¸åŒ</strong>ã€‚</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸è€ƒè™‘ baseline/advantage çš„å…·ä½“æ„é€ ç»†èŠ‚æ—¶ï¼š</p>

<ul>
  <li>â€œæŠŠ KL å†™è¿› loss å¹¶ç”¨ä½æ–¹å·®å®ç°ï¼ˆ$\text{sg}(\rho)k_2$ æˆ– $\rho k_3$ï¼‰â€</li>
  <li>ä¸â€œæŠŠ KL å†™è¿› reward å¹¶é€‰ $k_1$ï¼ˆstop-grad shaped rewardï¼‰â€</li>
</ul>

<p>å¯¹ç­–ç•¥æ›´æ–°æ–½åŠ çš„ KL æ­£åˆ™â€œåŠ›â€å¯ä»¥æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p>

<p>å…·ä½“æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬åªçœ‹â€œæœ€å¤§åŒ– $J$â€æ—¶ KL æƒ©ç½šè´¡çŒ®çš„é‚£ä¸€é¡¹æ¢¯åº¦ï¼ˆæƒ©ç½šé¡¹åœ¨ $J$ é‡Œå¸¦è´Ÿå·ï¼Œå› æ­¤è¿™é¡¹çš„ä¸Šå‡æ–¹å‘è‡ªç„¶å¸¦ $-\beta$ï¼‰ï¼š</p>

<ul>
  <li><strong>KL in Lossï¼ˆä½æ–¹å·®å®ç°ï¼‰</strong>ï¼š$-\beta \cdot \rho s_\theta k_1$</li>
  <li><strong>KL in Rewardï¼ˆ$k_1$ in rewardï¼‰</strong>ï¼š$\rho s_\theta \cdot (-\beta k_1) = -\beta \cdot \rho s_\theta k_1$</li>
</ul>

<p>å®ƒä»¬æ˜¯<strong>åŒä¸€ä¸ªéšæœºå˜é‡</strong>ï¼Œä¸ä»…æœŸæœ›ç›¸åŒï¼Œæ–¹å·®ä¹Ÿå®Œå…¨ç›¸åŒã€‚</p>

<h4 id="æ•´ä½“æ›´æ–°è¯­ä¹‰çš„å·®å¼‚">æ•´ä½“æ›´æ–°è¯­ä¹‰çš„å·®å¼‚</h4>

<p>å°½ç®¡ KL æ¢¯åº¦é¡¹åœ¨æ ·æœ¬çº§ç­‰ä»·ï¼Œ<strong>ä¸¤ç§æ–¹å¼çš„æ•´ä½“æ›´æ–°è¯­ä¹‰ä»ç„¶ä¸åŒ</strong>ã€‚å·®å¼‚ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>

<h4 id="1-kl-æ˜¯å¦è¿›å…¥-advantagebaseline">1. KL æ˜¯å¦è¿›å…¥ Advantage/Baseline</h4>

<p><strong>KL ä½œä¸º Loss</strong>ï¼ˆç­‰ä»·äºæœ€å¤§åŒ– $J(\theta)=\mathbb{E}[R]-\beta\,\mathrm{KL}$ï¼Œä½†æŠŠ KL é¡¹ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ã€å¯æ§çš„â€œæ˜¾å¼åŠ›â€æ¥å®ç°ï¼‰ï¼š</p>

<p>$$
\nabla_\theta J_{\text{loss-impl}} = \underbrace{\mathbb{E}_\mu[\rho s_\theta A_{\text{env}}]}_{\text{RL ä¸Šå‡æ–¹å‘}} + \underbrace{(-\beta) \cdot \mathbb{E}_\mu[\rho s_\theta k_1]}_{\text{ç‹¬ç«‹çš„ KL æƒ©ç½šä¸Šå‡æ–¹å‘}}
$$</p>

<p>KL æ˜¯ä¸€ä¸ª<strong>ç‹¬ç«‹çš„æ­£åˆ™é¡¹</strong>ï¼Œä¸ advantage å®Œå…¨è§£è€¦ã€‚KL æ¢¯åº¦çš„å¤§å°åªå–å†³äº $k_1$ æœ¬èº«ï¼Œä¸å— critic è´¨é‡æˆ– baseline é€‰æ‹©çš„å½±å“ã€‚</p>

<p><strong>KL ä½œä¸º Reward</strong>ï¼š</p>

<p>$$
\nabla_\theta J_{\text{reward-impl}} = \mathbb{E}_\mu[\rho s_\theta \tilde{A}], \quad \tilde{A} \text{ åŸºäº } (R - \beta \cdot k_1)
$$</p>

<p>KL é€šè¿‡ shaped reward è¿›å…¥ advantage è®¡ç®—ï¼Œä¼šè¢« baseline å¤„ç†ã€‚è¿™æ„å‘³ç€ï¼š</p>

<ul>
  <li>KL çš„å½±å“ä¼šè¢« advantage çš„æ„é€ æ–¹å¼è°ƒåˆ¶</li>
  <li>å¦‚æœä½¿ç”¨ value function baselineï¼ŒKL çš„å½±å“ä¼šè¢«éƒ¨åˆ†å¸æ”¶</li>
</ul>

<p>ä»å®ç°è§’åº¦çœ‹ï¼Œè¿™é‡Œçš„å·®åˆ«å¯ä»¥ç†è§£ä¸ºï¼šLoss æ–¹æ¡ˆæŠŠâ€œç¯å¢ƒå›æŠ¥éƒ¨åˆ†â€å’Œâ€œKL æ­£åˆ™éƒ¨åˆ†â€åˆ†å¼€ä¼°è®¡ï¼›Reward æ–¹æ¡ˆæŠŠ KL è§†ä¸ºå›æŠ¥çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å®ƒä¼šè·Ÿç€ä½ å¯¹å›æŠ¥åšçš„æ‰€æœ‰å¤„ç†ï¼ˆbaselineã€å½’ä¸€åŒ–ã€æˆªæ–­ç­‰ï¼‰ä¸€èµ·èµ°ã€‚</p>

<h4 id="2-ä¿¡åº¦åˆ†é…ç‹¬ç«‹æ­£åˆ™åŠ›-vs-æ··å…¥-shaped-reward">2. ä¿¡åº¦åˆ†é…ï¼šç‹¬ç«‹æ­£åˆ™åŠ› vs æ··å…¥ Shaped Reward</h4>

<p><strong>KL ä½œä¸º Loss</strong>ï¼šæ¯ä¸ª token/state çš„ KL æ¢¯åº¦æ˜¯ã€Œå±€éƒ¨ã€çš„ï¼Œåªå½±å“è¯¥ä½ç½®çš„ç­–ç•¥æ›´æ–°ã€‚</p>

<p><strong>KL ä½œä¸º Reward</strong>ï¼šKL æƒ©ç½šé€šè¿‡ return/advantage çš„æ—¶é—´å›ä¼ ï¼Œå¯èƒ½å½±å“åˆ°æ›´æ—©çš„å†³ç­–ã€‚</p>

<h4 id="3-reward-ä¸­å¿ƒåŒ–-klå¯¹æ¢¯åº¦æ— åæ€§çš„å½±å“">3. Reward ä¸­å¿ƒåŒ– KLï¼šå¯¹æ¢¯åº¦æ— åæ€§çš„å½±å“</h4>

<p>åœ¨å¤§æ¨¡å‹ RLï¼ˆå¦‚ GRPOã€PPO for LLMï¼‰ä¸­ï¼Œå¸¸è§çš„ advantage è®¡ç®—æ–¹å¼æ˜¯ $A = r - \text{mean}(r)$ã€‚å½“ KL ä½œä¸º Reward æ—¶ï¼Œæ˜¯å¦æŠŠ KL ä¹Ÿçº³å…¥ mean ä¼šå½±å“æ¢¯åº¦çš„æ— åæ€§ã€‚</p>

<p>è®¾é‡‡æ · $x_1,\dots,x_n \overset{iid}{\sim} q_\theta$ï¼Œè®° $g_i = \nabla_\theta \log q_\theta(x_i)$ï¼Œå¹¶ç”¨ $\mathrm{kl}_i$ è¡¨ç¤ºç¬¬ $i$ ä¸ªæ ·æœ¬çš„ KL æƒ©ç½šæ ‡é‡ï¼Œ$\bar{\mathrm{kl}} = \frac{1}{n}\sum_j \mathrm{kl}_j$ã€‚</p>

<p><strong>ä¸ä¸­å¿ƒåŒ–ï¼ˆ$-\beta\,\mathrm{kl}_i$ï¼‰</strong>ï¼šKL æ¢¯åº¦é¡¹çš„æœŸæœ›ä¸º</p>

<p>$$
-\beta \mathbb{E}[g_i\,\mathrm{kl}_i] = -\beta \nabla_\theta \mathbb{E}[\mathrm{KL}]
$$</p>

<p>è¿™æ˜¯å¯¹ $-\beta \mathbb{E}[\mathrm{KL}]$ çš„<strong>æ— åæ¢¯åº¦</strong>ã€‚</p>

<p><strong>åŒ batch å‡å€¼ä¸­å¿ƒåŒ–ï¼ˆ$-\beta(\mathrm{kl}_i - \bar{\mathrm{kl}})$ï¼Œå«è‡ªèº«ï¼‰</strong>ï¼šç”±äº $\bar{\mathrm{kl}}$ ä¾èµ–æ‰€æœ‰æ ·æœ¬ï¼ˆåŒ…æ‹¬ $x_i$ è‡ªèº«ï¼‰ï¼ŒæœŸæœ›æ¢¯åº¦å˜ä¸º</p>

<p>$$
-\beta \left(1 - \frac{1}{n}\right) \nabla_\theta \mathbb{E}[\mathrm{KL}]
$$</p>

<p>å³ KL æ­£åˆ™æ¢¯åº¦è¢«<strong>ç¼©å°</strong>äº† $\frac{1}{n}$ï¼Œç­‰ä»·äºæœ‰æ•ˆ $\beta$ å˜å°ã€‚è¿™ä¸æ˜¯ä¸¥æ ¼æ— åçš„ã€‚</p>

<p><strong>Leave-one-out ä¸­å¿ƒåŒ–ï¼ˆ$-\beta(\mathrm{kl}_i - \bar{\mathrm{kl}}_{-i})$ï¼‰</strong>ï¼šè‹¥æ”¹ç”¨ $\bar{\mathrm{kl}}_{-i} = \frac{1}{n-1}\sum_{j \neq i} \mathrm{kl}_j$ï¼Œåˆ™ $\bar{\mathrm{kl}}_{-i}$ ä¸ $g_i$ ç‹¬ç«‹ï¼Œæœ‰ $\mathbb{E}[g_i \bar{\mathrm{kl}}_{-i}] = 0$ï¼Œå› æ­¤</p>

<p>$$
-\beta \mathbb{E}[g_i (\mathrm{kl}_i - \bar{\mathrm{kl}}_{-i})] = -\beta \nabla_\theta \mathbb{E}[\mathrm{KL}]
$$</p>

<p>ä»æ˜¯<strong>æ— åæ¢¯åº¦</strong>ï¼ŒåŒæ—¶äº«å—ä¸­å¿ƒåŒ–å¸¦æ¥çš„æ–¹å·®ç¼©å‡ã€‚</p>

<p><strong>ç»“è®º</strong>ï¼šåŒ batch å‡å€¼ä¸­å¿ƒåŒ–å¼•å…¥çš„åå·®ä¸º $O(1/n)$ï¼Œåœ¨ GRPO ç­‰å¤§ batch åœºæ™¯ä¸‹å½±å“å¾ˆå°ï¼›è‹¥è¿½æ±‚ä¸¥æ ¼æ— åï¼Œå¯æ”¹ç”¨ leave-one-out å‡å€¼ï¼ŒåŒæ—¶äº«å—æ–¹å·®ç¼©å‡ã€‚</p>

<h3 id="ä½•æ—¶é€‰æ‹©å“ªç§æ–¹å¼">ä½•æ—¶é€‰æ‹©å“ªç§æ–¹å¼ï¼Ÿ</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç»´åº¦</th>
      <th style="text-align: center">KL ä½œä¸º Loss</th>
      <th style="text-align: center">KL ä½œä¸º Reward</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">KL æ¢¯åº¦å½¢æ€</td>
      <td style="text-align: center">$\rho s_\theta k_1$ï¼ˆä½æ–¹å·®é€‰æ‹©ï¼‰</td>
      <td style="text-align: center">$\rho s_\theta k_1$</td>
    </tr>
    <tr>
      <td style="text-align: center">ä¸ Advantage</td>
      <td style="text-align: center">å®Œå…¨è§£è€¦</td>
      <td style="text-align: center">é€šè¿‡ shaped reward è€¦åˆ</td>
    </tr>
    <tr>
      <td style="text-align: center">KL ä¸­å¿ƒåŒ–</td>
      <td style="text-align: center">æ— ï¼ˆç»å¯¹æƒ©ç½šï¼‰</td>
      <td style="text-align: center">æœ‰ï¼ˆ$\text{KL} - \text{mean}(\text{KL})$ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">ä¿¡åº¦åˆ†é…</td>
      <td style="text-align: center">å±€éƒ¨ã€per-token</td>
      <td style="text-align: center">å¯èƒ½æœ‰æ—¶é—´å›ä¼ ï¼ˆå–å†³äºå®ç°ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">é€‚ç”¨åœºæ™¯</td>
      <td style="text-align: center">å¸Œæœ› KL çº¦æŸæ›´å¯æ§ã€æ›´ä¸ä¾èµ– critic</td>
      <td style="text-align: center">å¸Œæœ› KL çº¦æŸæ›´å…¨å±€ã€æœ‰è§„åˆ’æ€§</td>
    </tr>
  </tbody>
</table>

<p><strong>å®è·µå»ºè®®</strong>ï¼š</p>

<ol>
  <li>
    <p><strong>å¦‚æœä½ å¸Œæœ› KL çº¦æŸæ˜¯ã€Œä¿®æ­£æ€§ã€çš„</strong>â€”â€”å³å…è®¸æ™ºèƒ½ä½“æ¢ç´¢ï¼Œä½†åœ¨å±€éƒ¨ä¿®æ­£å…¶è¡Œä¸ºï¼ŒåŒæ—¶å¸Œæœ› KL çš„å‹åŠ›æ›´å¯æ§ã€æ›´å°‘ä¾èµ– critic çš„è´¨é‡ï¼Œé‚£ä¹ˆè¯·é€‰æ‹© <strong>KL ä½œä¸º Loss</strong>ï¼Œä½¿ç”¨ $\text{sg}(\rho) k_2$ æˆ– $\rho k_3$ã€‚æ³¨æ„ï¼Œåœ¨ on-policy åœºæ™¯ä¸‹ï¼Œå¦‚æœä¸æƒ³æ˜¾å¼æ„é€  $\rho=\frac{q_\theta}{\text{sg}(q_\theta)}$ï¼Œç›´æ¥ä½¿ç”¨ $k_2$ ä¼šæ›´ç®€å•ä¸”ä¸æ˜“å‡ºé”™ã€‚</p>
  </li>
  <li>
    <p><strong>å¦‚æœä½ å¸Œæœ› KL çº¦æŸæ˜¯ã€Œé¢„é˜²æ€§ã€çš„</strong>â€”â€”å³è®©æ™ºèƒ½ä½“ä»æ ¹æºä¸Šé¿å¼€é«˜ KL åŒºåŸŸï¼Œå¹¶ä¸”æ¥å— KL è¢« baseline è°ƒåˆ¶ï¼Œé‚£ä¹ˆè¯·é€‰æ‹© <strong>KL ä½œä¸º Reward</strong>ï¼Œä½¿ç”¨ $k_1$ã€‚</p>
  </li>
</ol>

<p>åŸºäºä¸Šè¿°â€œæ•°å€¼æ— å vs æ¢¯åº¦æ­£ç¡®â€ä»¥åŠâ€œLoss ä¸ Reward å®ç°å·®å¼‚â€çš„ç»“è®ºï¼Œä¸‹é¢è¿›å…¥å¯ç›´æ¥ç…§æŠ„åˆ°ä»£ç é‡Œçš„é€‰å‹é€ŸæŸ¥ä¸å¸¸è§è¸©å‘ç‚¹ã€‚</p>

<h2 id="å®è·µæŒ‡å—ä¸å¸¸è§é™·é˜±">å®è·µæŒ‡å—ä¸å¸¸è§é™·é˜±</h2>

<h3 id="ä¸‰ç§ä¼°è®¡å™¨å®šä¹‰é€ŸæŸ¥">ä¸‰ç§ä¼°è®¡å™¨å®šä¹‰é€ŸæŸ¥</h3>

<p>$$
k_1 = \log \frac{q_\theta}{p}, \quad k_2 = \frac{1}{2}\left(\log \frac{p}{q_\theta}\right)^2, \quad k_3 = \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}
$$</p>

<h3 id="æ•°å€¼ä¼°è®¡æ€§è´¨">æ•°å€¼ä¼°è®¡æ€§è´¨</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">å¯¹åå‘ KL $D_{\mathrm{KL}}(q_\theta \| p)$ æ•°å€¼æ— åï¼Ÿ</th>
      <th style="text-align: center">æ–¹å·®</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">é«˜ï¼ˆä¼°è®¡å€¼å¯è´Ÿï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">âœ—ï¼ˆä½†åå·®æå°ï¼‰</td>
      <td style="text-align: center">ä½</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">âœ“</td>
      <td style="text-align: center">ä½</td>
    </tr>
  </tbody>
</table>

<h3 id="é€‰å‹é€ŸæŸ¥è¡¨">é€‰å‹é€ŸæŸ¥è¡¨</h3>

<h4 id="on-policy-ä¼˜åŒ–åå‘-klloss">On-policy ä¼˜åŒ–åå‘ KLï¼ˆLossï¼‰</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Loss å½¢å¼</th>
      <th style="text-align: center">ä¼˜ç‚¹</th>
      <th style="text-align: center">é—®é¢˜</th>
      <th style="text-align: center">æ¨è</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">â€”</td>
      <td style="text-align: center">æ¢¯åº¦æœŸæœ›ä¸ºé›¶ï¼Œ<strong>å®Œå…¨æ— æ•ˆ</strong>ï¼Œä¸èƒ½ç”¨äºä¼˜åŒ–</td>
      <td style="text-align: center">âœ—âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">æ¢¯åº¦æ­£ç¡®ï¼ˆåå‘ KLï¼‰ï¼Œä½æ–¹å·®ï¼Œ<strong>å®ç°æœ€ç®€å•</strong></td>
      <td style="text-align: center">æ•°å€¼æœ‰åï¼ˆä½†åå·®æå°ï¼‰</td>
      <td style="text-align: center">âœ“âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">â€”</td>
      <td style="text-align: center">æ¢¯åº¦å¯¹åº”<strong>æ­£å‘ KL</strong>ï¼Œæ–¹å‘é”™è¯¯ï¼Œä¸èƒ½ç”¨äºä¼˜åŒ–åå‘ KL</td>
      <td style="text-align: center">âœ—âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\text{sg}(q_\theta)} k_3$</td>
      <td style="text-align: center">æ¢¯åº¦æ­£ç¡®ï¼ˆåå‘ KLï¼‰ï¼Œä½æ–¹å·®ï¼Œæ•°å€¼æ— å</td>
      <td style="text-align: center">éœ€æ˜¾å¼æ„é€  $\rho$ï¼Œå®ç°ç¨å¤æ‚</td>
      <td style="text-align: center">âœ“</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>æ³¨</strong>ï¼š$k_2$ ä¸ $\frac{q_\theta}{\text{sg}(q_\theta)} k_3$ çš„æ¢¯åº¦å®Œå…¨ç›¸åŒï¼ˆæ ·æœ¬çº§ç­‰ä»·ï¼‰ã€‚On-policy æ—¶æ¨èç›´æ¥ç”¨ $k_2$ï¼Œå®ç°æœ€ç®€å•ã€‚</p>
</blockquote>

<h4 id="off-policy-ä¼˜åŒ–åå‘-klloss">Off-policy ä¼˜åŒ–åå‘ KLï¼ˆLossï¼‰</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Loss å½¢å¼</th>
      <th style="text-align: center">ä¼˜ç‚¹</th>
      <th style="text-align: center">é—®é¢˜</th>
      <th style="text-align: center">æ¨è</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\mu} k_1$</td>
      <td style="text-align: center">æ¢¯åº¦æ­£ç¡®ï¼ˆåå‘ KLï¼‰ï¼Œæ•°å€¼æ— å</td>
      <td style="text-align: center"><strong>æ–¹å·®è¾ƒé«˜</strong></td>
      <td style="text-align: center">â–³</td>
    </tr>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\mu} k_2$</td>
      <td style="text-align: center">â€”</td>
      <td style="text-align: center">æ¢¯åº¦å¯¹åº” <strong>f-æ•£åº¦</strong>ï¼ˆéåå‘ KLï¼‰ï¼Œä¸èƒ½ç”¨äºä¼˜åŒ–åå‘ KL</td>
      <td style="text-align: center">âœ—âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$</td>
      <td style="text-align: center">æ¢¯åº¦æ­£ç¡®ï¼ˆåå‘ KLï¼‰ï¼Œ<strong>ä½æ–¹å·®</strong></td>
      <td style="text-align: center">æ•°å€¼æœ‰åï¼ˆä½†åå·®æå°ï¼‰</td>
      <td style="text-align: center">âœ“âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$\frac{q_\theta}{\mu} k_3$</td>
      <td style="text-align: center">æ¢¯åº¦æ­£ç¡®ï¼ˆåå‘ KLï¼‰ï¼Œ<strong>ä½æ–¹å·®</strong>ï¼Œæ•°å€¼æ— å</td>
      <td style="text-align: center">â€”</td>
      <td style="text-align: center">âœ“âœ“</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>æ³¨</strong>ï¼š$\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$ ä¸ $\frac{q_\theta}{\mu} k_3$ çš„æ¢¯åº¦å®Œå…¨ç›¸åŒï¼ˆæ ·æœ¬çº§ç­‰ä»·ï¼‰ã€‚ä¸¤è€…å‡ä¸ºæ¨èé€‰æ‹©ã€‚</p>
</blockquote>

<h4 id="kl-ä½œä¸º-reward-æƒ©ç½šstop-grad-shaped-reward">KL ä½œä¸º Reward æƒ©ç½šï¼ˆstop-grad shaped rewardï¼‰</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ä¼°è®¡å™¨</th>
      <th style="text-align: center">ä¼˜ç‚¹</th>
      <th style="text-align: center">é—®é¢˜</th>
      <th style="text-align: center">æ¨è</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">$k_1$</td>
      <td style="text-align: center">æ•°å€¼æ— åï¼Œ<strong>è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æ— å</strong></td>
      <td style="text-align: center">æ–¹å·®è¾ƒé«˜</td>
      <td style="text-align: center">âœ“âœ“</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_2$</td>
      <td style="text-align: center">æ•°å€¼æœ‰å</td>
      <td style="text-align: center">è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æœ‰å</td>
      <td style="text-align: center">âœ—âœ—</td>
    </tr>
    <tr>
      <td style="text-align: center">$k_3$</td>
      <td style="text-align: center">æ•°å€¼æ— åï¼Œä½æ–¹å·®</td>
      <td style="text-align: center"><strong>è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æœ‰å</strong>ï¼Œåå·®é¡¹ä¸º $-\nabla D_{\mathrm{KL}}(p\|q)$ï¼Œå¯èƒ½å¯¼è‡´<strong>è®­ç»ƒå´©æºƒ</strong></td>
      <td style="text-align: center">âœ—âœ—</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p><strong>æ³¨</strong>ï¼šReward æƒ©ç½šåœºæ™¯ä¸‹ï¼Œ<strong>åªæœ‰ $k_1$ æ˜¯æ­£ç¡®çš„é€‰æ‹©</strong>ã€‚$k_3$ è™½ç„¶æ•°å€¼æ— åä¸”æ–¹å·®ä½ï¼Œä½†ä¼šå¯¼è‡´ç­–ç•¥æ¢¯åº¦æœ‰åï¼Œå®éªŒä¸­è§‚å¯Ÿåˆ°è®­ç»ƒå´©æºƒã€‚</p>
</blockquote>

<h4 id="å›¾ä¾‹è¯´æ˜">å›¾ä¾‹è¯´æ˜</h4>

<ul>
  <li>âœ“âœ“ï¼š<strong>å¼ºçƒˆæ¨è</strong>ï¼Œç†è®ºæ­£ç¡®ä¸”å®è·µè¡¨ç°å¥½</li>
  <li>âœ“ï¼šæ¨èï¼Œç†è®ºæ­£ç¡®ä½†å®ç°ç¨å¤æ‚æˆ–æœ‰å°ç¼ºç‚¹</li>
  <li>â–³ï¼šå¯ç”¨ä½†éœ€è°¨æ…ï¼Œå­˜åœ¨æ–¹å·®é«˜ç­‰é—®é¢˜</li>
  <li>âœ—âœ—ï¼š<strong>ç¦æ­¢ä½¿ç”¨</strong>ï¼Œç†è®ºä¸Šé”™è¯¯æˆ–ä¼šå¯¼è‡´è®­ç»ƒå¤±è´¥</li>
</ul>

<h3 id="å¸¸è§é™·é˜±">å¸¸è§é™·é˜±</h3>

<ol>
  <li><strong>On-policy ä¸‹ä½¿ç”¨ $k_1 = \log \frac{q_\theta}{p}$ ä½œä¸º Loss</strong>ï¼šæ¢¯åº¦æœŸæœ›ä¸ºé›¶ï¼Œå®Œå…¨æ— æ•ˆã€‚</li>
  <li><strong>On-policy ä¸‹ä½¿ç”¨ $k_3 = \frac{p}{q_\theta} - 1 - \log \frac{p}{q_\theta}$ ä½œä¸º Loss æ¥ä¼˜åŒ–åå‘ KL</strong>ï¼šå…¶æ¢¯åº¦å¯¹åº”æ­£å‘ KL $D_{\mathrm{KL}}(p \| q_\theta)$ï¼Œæ–¹å‘é”™è¯¯ã€‚</li>
  <li><strong>Off-policy ä¸‹ä½¿ç”¨ $\frac{q_\theta}{\mu} k_2$ï¼ˆé‡è¦æ€§æƒé‡ä¸ detachï¼‰</strong>ï¼šæ¢¯åº¦å¯¹åº” f-æ•£åº¦ï¼Œè€Œéåå‘ KLã€‚</li>
  <li><strong>åœ¨ Reward æƒ©ç½šä¸­ä½¿ç”¨ $k_3$</strong>ï¼šè™½ç„¶æ•°å€¼æ— åï¼Œä½†è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æœ‰åï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒå´©æºƒã€‚</li>
  <li><strong>On-policy æ—¶å°† $\rho$ ç®€å•åœ°è®¾ä¸ºå¸¸æ•° 1</strong>ï¼šå¿…é¡»æ˜¾å¼æ„é€  $\rho = \frac{q_\theta}{\text{sg}(q_\theta)}$ï¼ˆæˆ–ç­‰ä»·åœ° $\exp(\log q_\theta - \text{sg}(\log q_\theta))$ï¼‰ï¼Œå¦åˆ™ä¼šä¸¢å¤± score-function æ¢¯åº¦è·¯å¾„ï¼Œå¯¼è‡´ $\rho k_1$ å’Œ $\rho k_3$ é€€åŒ–ä¸ºæœ´ç´ å½¢å¼è€Œå¤±æ•ˆã€‚</li>
  <li><strong>æ··æ·†ã€Œæ•°å€¼æ— åã€ä¸ã€Œæ¢¯åº¦æ­£ç¡®ã€</strong>ï¼š$k_3$ å¯¹åå‘ KL æ•°å€¼æ— åï¼Œä½†ä½œä¸º Reward æƒ©ç½šæ—¶è¯±å¯¼çš„ç­–ç•¥æ¢¯åº¦æœ‰åï¼›é€‰æ‹©ä¼°è®¡å™¨æ—¶å¿…é¡»åŒæ—¶è€ƒè™‘è¿™ä¸¤ä¸ªç»´åº¦ã€‚</li>
</ol>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æœ¬æ–‡å›´ç»•ã€Œ<strong>ä»è°é‡‡æ ·</strong>ã€ã€Œ<strong>æ€ä¹ˆç”¨</strong>ã€ã€Œ<strong>ä¼°è®¡ä»€ä¹ˆ</strong>ã€è¿™ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œç³»ç»Ÿå‰–æäº† $k_1, k_2, k_3$ ä¸‰ç§ KL ä¼°è®¡å™¨ã€‚</p>

<blockquote>
  <p><strong>æ ¸å¿ƒç»“è®º</strong>ï¼š<strong>æ•°å€¼æ— å â‰  æ¢¯åº¦æ­£ç¡®</strong>ã€‚é€‰æ‹©ä¼°è®¡å™¨æ—¶ï¼Œå¿…é¡»åŒæ—¶è€ƒè™‘ã€Œä¼°è®¡è°çš„æ•°å€¼ã€å’Œã€Œæ¢¯åº¦å¯¹åº”å“ªä¸ªä¼˜åŒ–ç›®æ ‡ã€ã€‚</p>
</blockquote>

<p><strong>æ ¸å¿ƒå†…å®¹</strong>ï¼š</p>

<ol>
  <li><strong>æ•°å€¼ä¼°è®¡</strong>ï¼š$k_1$ å’Œ $k_3$ å¯¹åå‘ KL æ•°å€¼æ— åï¼Œä¸” $k_3$ å…¼å…·ä½æ–¹å·®ã€‚</li>
  <li><strong>ä½œä¸º Loss æ—¶çš„æ¢¯åº¦</strong>ï¼šåœ¨ on-policy åœºæ™¯ä¸‹ä½¿ç”¨ $k_2$ æˆ– $\frac{q_\theta}{\text{sg}(q_\theta)} k_3$ï¼›åœ¨ off-policy åœºæ™¯ä¸‹ä½¿ç”¨ $\frac{q_\theta}{\mu} k_3$ æˆ– $\text{sg}\left(\frac{q_\theta}{\mu}\right) k_2$ã€‚</li>
  <li><strong>ä½œä¸º Reward æƒ©ç½š</strong>ï¼šåªèƒ½ä½¿ç”¨ $k_1$ï¼Œå› ä¸º $k_3$ ä¼šå¯¼è‡´ç­–ç•¥æ¢¯åº¦æœ‰åã€‚</li>
  <li><strong>Loss ä¸ Reward ä¸¤ç§å®ç°çš„å…³ç³»</strong>ï¼š
    <ul>
      <li><strong>æ ·æœ¬çº§ç­‰ä»·æ€§</strong>ï¼šå½“ Loss ä½¿ç”¨ä½æ–¹å·®å®ç°ï¼ˆ$\text{sg}(\rho) k_2$ æˆ– $\rho k_3$ï¼‰ã€Reward ä½¿ç”¨ $k_1$ æ—¶ï¼Œä¸¤è€…çš„ KL æ¢¯åº¦é¡¹æ˜¯<strong>åŒä¸€ä¸ªéšæœºå˜é‡</strong> $\rho s_\theta k_1$ï¼Œä¸ä»…æœŸæœ›ç›¸åŒï¼Œæ–¹å·®ä¹Ÿå®Œå…¨ç›¸åŒã€‚</li>
      <li><strong>æ•´ä½“è¯­ä¹‰å·®å¼‚</strong>ï¼šåœ¨ Loss æ–¹å¼ä¸­ï¼ŒKL æ˜¯ç‹¬ç«‹çš„æ­£åˆ™é¡¹ï¼Œä¸ advantage å®Œå…¨è§£è€¦ï¼Œä¸å— critic è´¨é‡çš„å½±å“ï¼›è€Œåœ¨ Reward æ–¹å¼ä¸­ï¼ŒKL é€šè¿‡ shaped reward è¿›å…¥ advantage è®¡ç®—ï¼Œä¼šè¢« baseline å¤„ç†å’Œè°ƒåˆ¶ã€‚</li>
      <li><strong>ä¿¡åº¦åˆ†é…å·®å¼‚</strong>ï¼šLoss æ–¹å¼çš„ KL æ¢¯åº¦æ˜¯å±€éƒ¨çš„ï¼ˆper-tokenï¼‰ï¼›è€Œ Reward æ–¹å¼çš„ KL æƒ©ç½šå¯èƒ½é€šè¿‡ return å›ä¼ å½±å“æ›´æ—©çš„å†³ç­–ã€‚</li>
    </ul>
  </li>
  <li><strong>ç»Ÿä¸€ $\rho$ æ¡†æ¶</strong>ï¼šæœ¬æ–‡å¼•å…¥ $\rho = \frac{q_\theta}{\text{sg}(\mu)}$ æ¥ç»Ÿä¸€å¤„ç† on-policy å’Œ off-policy åœºæ™¯ã€‚è¯¥æ¡†æ¶çš„æ ¸å¿ƒæ´å¯Ÿæ˜¯ï¼šå°†ã€Œé‡‡æ ·åˆ†å¸ƒå¯¹ $\theta$ çš„ä¾èµ–ã€æ˜¾å¼åœ°çº³å…¥ $\rho$ è¿™æ¡æ¢¯åº¦è·¯å¾„ï¼Œä»è€Œä½¿ã€Œå…ˆæœŸæœ›åæ¢¯åº¦ã€ä¸ã€Œå…ˆæ¢¯åº¦åæœŸæœ›ã€åœ¨ $\mathbb{E}_\mu[\cdot]$ ä¸‹æ€»æ˜¯ç­‰ä»·ã€‚åœ¨ on-policy åœºæ™¯ä¸­ï¼Œ$\rho \equiv 1$ ä½† $\nabla_\theta \rho = s_\theta \neq 0$ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆç›´æ¥å¯¹ $k_1$ æˆ– $k_3$ è¿›è¡Œåå‘ä¼ æ’­ä¼šå¤±æ•ˆï¼Œè€Œ $k_2$ èƒ½ã€Œå·§åˆã€åœ°å·¥ä½œã€‚</li>
</ol>

<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>

<ol>
  <li>
    <p>Dibya Ghosh. â€œKL Divergence for Machine Learningâ€. <a href="https://dibyaghosh.com/blog/probability/kldivergence">https://dibyaghosh.com/blog/probability/kldivergence</a></p>
  </li>
  <li>
    <p>John Schulman. â€œApproximating KL Divergenceâ€. <a href="https://joschu.net/blog/kl-approx.html">https://joschu.net/blog/kl-approx.html</a></p>
  </li>
  <li>
    <p>Verl Documentation. â€œProximal Policy Optimization (PPO)â€. <a href="https://verl.readthedocs.io/en/latest/algo/ppo.html">https://verl.readthedocs.io/en/latest/algo/ppo.html</a></p>
  </li>
  <li>
    <p>åˆä¸ƒ123334. RLHF/RLVR è®­ç»ƒä¸­çš„ KL è¿‘ä¼¼æ–¹æ³•æµ…æï¼ˆk1 / k2 / k3ï¼‰. <a href="https://zhuanlan.zhihu.com/p/1966872846212010437">https://zhuanlan.zhihu.com/p/1966872846212010437</a></p>
  </li>
  <li>
    <p>Kezhao Liu, Jason Klein Liu, Mingtao Chen, Yiming Liu. â€œRethinking KL Regularization in RLHF: From Value Estimation to Gradient Optimizationâ€. <a href="https://arxiv.org/abs/2510.01555">https://arxiv.org/abs/2510.01555</a></p>
  </li>
  <li>
    <p>Yifan Zhang, Yiping Ji, Gavin Brown, et al. â€œOn the Design of KL-Regularized Policy Gradient Algorithms for LLM Reasoningâ€. <a href="https://arxiv.org/abs/2505.17508">https://arxiv.org/abs/2505.17508</a></p>
  </li>
  <li>
    <p>Vedant Shah, Johan Obando-Ceron, Vineet Jain, Brian Bartoldson, Bhavya Kailkhura, Sarthak Mittal, Glen Berseth, Pablo Samuel Castro. â€œA Comedy of Estimators: On KL Regularization in RL Training of LLMsâ€. <a href="https://arxiv.org/abs/2512.21852">https://arxiv.org/abs/2512.21852</a></p>
  </li>
</ol>

<div class="language-bibtex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">@misc</span><span class="p">{</span><span class="nl">WangZhang2025KLEstimators</span><span class="p">,</span>
  <span class="na">author</span>       <span class="p">=</span> <span class="s">{Wang, Xihuai and Zhang, Shao}</span><span class="p">,</span>
  <span class="na">title</span>        <span class="p">=</span> <span class="s">{Understanding KL Divergence Estimators in RL: From Value Approximation to Gradient Estimation}</span><span class="p">,</span>
  <span class="na">year</span>         <span class="p">=</span> <span class="s">{2025}</span><span class="p">,</span>
  <span class="na">month</span>        <span class="p">=</span> <span class="nv">dec</span><span class="p">,</span>
  <span class="na">day</span>          <span class="p">=</span> <span class="s">{01}</span><span class="p">,</span>
  <span class="na">url</span>          <span class="p">=</span> <span class="s">{https://xihuai18.github.io/reinforcement-learning/2025/12/01/kl-estimators-en.html}</span>
<span class="p">}</span>
</code></pre></div></div>

      </article>

      

      
        
      </div>

    <div class="col-lg-3 d-none d-lg-block toc-sidebar-col">
      <aside class="toc-sidebar" data-toc-sidebar id="toc-sidebar">
  <div class="toc-sidebar__header">
    <div class="toc-sidebar__title">ç›®å½•</div>
    <button class="toc-toggle-btn" aria-label="Toggle table of contents" aria-expanded="false" aria-controls="toc-content" data-toc-toggle>
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
  <nav
    id="toc-content"
    class="toc js-page-toc"
    data-toc
    data-toc-content=".toc-content"
    data-toc-headings="h2,h3"
    data-toc-min-items="2"
    aria-label="ç›®å½•"
  ></nav>
</aside>

<!-- Collapsed TOC toggle button (shown when TOC is collapsed) -->
<button class="toc-collapsed-toggle" aria-label="Show table of contents" aria-expanded="false" aria-controls="toc-content" data-toc-expand>
  <i class="fas fa-list"></i>
</button>


    </div>
  </div>
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        &copy; Copyright 2026 Xihuai Leo Wang. Last updated: January 25, 2026.
      </div>
    </footer>


    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/blog_enhancements.js" type="text/javascript"></script>
  <script defer src="/assets/js/sidenotes.js" type="text/javascript"></script>
  <script defer src="/assets/js/footnote_preview.js" type="text/javascript"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>
  <script defer src="/assets/js/toc.js" type="text/javascript"></script>
  <script defer src="/assets/js/venue_filter.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax 3.x with comprehensive configuration -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams',
        // Support all common math delimiters
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        processRefs: true,
        // Common macros for convenience
        macros: {
          RR: '\\mathbb{R}',
          NN: '\\mathbb{N}',
          ZZ: '\\mathbb{Z}',
          CC: '\\mathbb{C}',
          EE: '\\mathbb{E}',
          PP: '\\mathbb{P}',
          bm: ['\\boldsymbol{#1}', 1],
          argmax: '\\operatorname*{arg\\,max}',
          argmin: '\\operatorname*{arg\\,min}',
          sgn: '\\operatorname{sgn}',
          KL: '\\mathrm{KL}',
          Var: '\\operatorname{Var}',
          Cov: '\\operatorname{Cov}',
          tr: '\\operatorname{tr}',
          diag: '\\operatorname{diag}'
        },
        // AMS packages
        packages: {'[+]': ['ams', 'boldsymbol', 'newcommand']}
      },
      loader: {
        load: ['[tex]/ams', '[tex]/boldsymbol', '[tex]/newcommand']
      },
      options: {
        // Skip math rendering in these HTML elements
        skipHtmlTags: [
          'script', 'noscript', 'style', 'textarea', 'pre', 'code',
          'annotation', 'annotation-xml', 'kbd', 'samp', 'var'
        ],
        // Fix issues with underscores being converted to <em> by HTML
        processHtmlClass: 'mathjax-process',
        ignoreHtmlClass: 'tex2jax_ignore|no-mathjax',
        // Render math even with HTML entities
        renderActions: {
          findScript: [10, function (doc) {
            // Pre-process to fix HTML entity issues in math
            for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            }
          }, '']
        }
      },
      svg: {
        fontCache: 'global',
        scale: 1.0
      },
      chtml: {
        scale: 1.0,
        matchFontHeight: true
      },
      startup: {
        ready: function () {
          MathJax.startup.defaultReady();
          // Fix: restore underscores that might have been converted to <em>
          MathJax.startup.promise.then(() => {
            console.log('MathJax typesetting complete');
          });
        }
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  
  <!-- Pre-processing script to protect math from Markdown/HTML interference -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fix underscores in math that were converted to <em> by Markdown
      function fixMathUnderscores() {
        const mathContainers = document.querySelectorAll('.MathJax, .MathJax_Display, mjx-container');
        // This runs before MathJax, so we need to fix raw content
        const content = document.querySelector('.post-content, article');
        if (!content) return;
        
        // Find math delimiters and restore any <em> or <strong> inside them
        const html = content.innerHTML;
        
        // Pattern to find math blocks and restore underscore formatting
        // This is a fallback; the main protection is in the Jekyll plugin
      }
      
      // Fix HTML entities in display math blocks
      function fixHtmlEntities() {
        document.querySelectorAll('.language-plaintext.highlighter-rouge').forEach(el => {
          // Check if this looks like an HTML figure that wasn't rendered
          const text = el.textContent;
          if (text.includes('<img') || text.includes('<figure') || text.includes('<figcaption')) {
            // This is raw HTML that should be rendered - replace with actual HTML
            const temp = document.createElement('div');
            temp.innerHTML = text;
            el.replaceWith(...temp.childNodes);
          }
        });
      }
      
      fixHtmlEntities();
    });
  </script>

    <!-- Pseudocode -->
  <script defer src="https://cdn.jsdelivr.net/npm/pseudocode@2.4.1/build/pseudocode.min.js" integrity="sha256-aVkDxqyzrB+ExUsOY9PdyelkDhn/DfrjWu08aVpqNlo=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/pseudocode-init.js" type="text/javascript"></script>
    <!-- Mermaid -->
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>
  <script defer src="/assets/js/mermaid-init.js" type="text/javascript"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2923RQZBXG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-2923RQZBXG');
  </script>
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar,
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    // Use the CSS-defined padding-top value to avoid layout shift
    // The navbar height is already handled by CSS: body.fixed-top-nav { padding-top: 50px; }
    let navbarHeight = $("#navbar").outerHeight(true) || 50;
    // Only set progressBar position, don't override body padding to avoid layout shift
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
